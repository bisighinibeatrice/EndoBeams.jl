using LinearAlgebra
using StaticArrays
using Infiltrator
using BenchmarkTools

const Vec3{T} = SVector{3, T}
const Mat33{T} = SMatrix{3, 3, T, 9}
const ID3 = Diagonal(@SVector [1,1,1])



# Rotate using Rodrigue's formula
@inline function rotation_matrix(Î˜::AbstractVecOrMat{T}) where T
    
    Î˜_norm = norm(Î˜)
    if Î˜_norm > 10*eps(T)
        sinÎ˜, cosÎ˜ = sincos(Î˜_norm)
        SÎ˜ = skew(Î˜)
        R = ID3 + sinÎ˜/Î˜_norm*SÎ˜ +  2*(sin(Î˜_norm/2)/Î˜_norm)^2 * SÎ˜*SÎ˜
        return R
    else
        return SMatrix{3,3,T,9}(1,0,0,0,1,0,0,0,1)
    end

end


@inline function local_Râ°(xâ‚, xâ‚‚)

    vâ‚ = xâ‚‚ - xâ‚
    l = norm(vâ‚)
    vâ‚ = vâ‚/l
    eâ‚‚ = @SVector [0,1,0]
    eâ‚ƒ = @SVector [0,0,1]

    if ( vâ‚[1] > 1e-8*l ) || ( vâ‚[2] > 1e-8*l )
        aux = cross(eâ‚ƒ, vâ‚)
        vâ‚‚ = aux/norm(aux)
    else
        T = eltype(vâ‚)
        vâ‚‚ = T.(eâ‚‚)
    end
    
    vâ‚ƒ = cross(vâ‚, vâ‚‚)

    Râ‚‘ = [vâ‚ vâ‚‚ vâ‚ƒ]

    return Râ‚‘

end


    



@inline function local_Râ‚‘_and_aux(xâ‚, xâ‚‚, Râ‚, Râ‚‚, Râ‚‘â°Eâ‚‚, lâ‚™)

    vâ‚ = (xâ‚‚ - xâ‚)/lâ‚™
    pâ‚ = Râ‚ * Râ‚‘â°Eâ‚‚
    pâ‚‚ = Râ‚‚ * Râ‚‘â°Eâ‚‚
    p = (pâ‚+pâ‚‚)/2
    vâ‚ƒ = cross(vâ‚, p)
    vâ‚ƒ = vâ‚ƒ / norm(vâ‚ƒ)
    vâ‚‚ = cross(vâ‚ƒ, vâ‚)

    Râ‚‘ = [vâ‚ vâ‚‚ vâ‚ƒ]

    ruâ‚ = -vâ‚'
    ruâ‚‚ = vâ‚'

    Râ‚‘Â¹Â²áµ€ = Râ‚‘[:, SOneTo(2)]'

    qâ‚, qâ‚‚ = Râ‚‘Â¹Â²áµ€*p
    qÂ¹Â¹, qÂ¹Â² = Râ‚‘Â¹Â²áµ€*pâ‚
    qÂ²Â¹, qÂ²Â² = Râ‚‘Â¹Â²áµ€*pâ‚‚
    
    Î· = qâ‚/qâ‚‚
    Î·Â¹Â¹ = qÂ¹Â¹/qâ‚‚
    Î·Â¹Â² = qÂ¹Â²/qâ‚‚
    Î·Â²Â¹ = qÂ²Â¹/qâ‚‚
    Î·Â²Â² = qÂ²Â²/qâ‚‚

    Gáµ€uâ‚ = @SMatrix [0 0 Î·/lâ‚™; 0 0 1/lâ‚™; 0 -1/lâ‚™ 0]
    Gáµ€Î˜â‚ = @SMatrix [Î·Â¹Â²/2 -Î·Â¹Â¹/2 0; 0 0 0; 0 0 0]
    Gáµ€uâ‚‚ = -Gáµ€uâ‚
    Gáµ€Î˜â‚‚ = @SMatrix [Î·Â²Â²/2 -Î·Â²Â¹/2 0; 0 0 0; 0 0 0]

    Dâ‚ƒ = (ID3 - vâ‚*vâ‚')/lâ‚™

    return Râ‚‘, ruâ‚, ruâ‚‚, Î·, (Î·Â¹Â¹, Î·Â¹Â², Î·Â²Â¹, Î·Â²Â²), Gáµ€uâ‚, Gáµ€Î˜â‚, Gáµ€uâ‚‚, Gáµ€Î˜â‚‚, Dâ‚ƒ
end




@inline function toangle(R::AbstractMatrix{T}) where T

    if abs((tr(R)-1)/2) < 1
        norm_v = max(acos((tr(R)-1)/2), 10*eps(T))
    else
        norm_v = 10*eps(T)
    end

    n_v = (1/(2*sin(norm_v))) * @SVector [R[3,2]-R[2,3], R[1,3]-R[3,1], R[2,1]-R[1,2]]

    return norm_v*n_v

end


@inline function skew(vec)

    return @SMatrix [0       -vec[3] vec[2] ;
                     vec[3]  0       -vec[1];
                     -vec[2] vec[1]  0      ]

end

# Get the inverse of skew symmetric matrix from toangle
@inline function Tâ‚›â»Â¹(Î˜::AbstractVector{T}) where T

    Î˜_norm = norm(Î˜)

    if Î˜_norm < 10*eps(T)
        Tâ‚›â»Â¹ = SMatrix{3,3,T,9}(1,0,0,0,1,0,0,0,1)
    else
        SÎ˜ = skew(Î˜)
        sinÎ˜2, cosÎ˜2 = sincos(Î˜_norm/2)
        Tâ‚›â»Â¹ = ID3 - SÎ˜/2 + (sinÎ˜2-Î˜_norm/2*cosÎ˜2)/(sinÎ˜2*Î˜_norm^2)*SÎ˜*SÎ˜
    end

    return Tâ‚›â»Â¹

end


@inline function Tâ‚›(Î˜::AbstractVector{T}) where T

    Î˜_norm = norm(Î˜)

    if Î˜_norm < 10*eps(T)
        Tâ‚› = SMatrix{3,3,T,9}(1, 0, 0, 0, 1, 0, 0, 0, 1)
    else
        sinÎ˜, cosÎ˜ = sincos(Î˜_norm)
        SÎ˜ = skew(Î˜)
        Tâ‚› = ID3 + 2*(sin(Î˜_norm/2)/Î˜_norm)^2*SÎ˜ + (1-sin(Î˜_norm)/Î˜_norm)/Î˜_norm^2*(SÎ˜*SÎ˜)
    end

    return Tâ‚›

end


@inline function compute_Káµ¥(Î˜::AbstractVector{T}, v) where T

    Î˜norm = norm(Î˜)

    if Î˜norm < 10*eps(T)
        Káµ¥ = skew(v)/2
    else
        sinÎ˜, cosÎ˜ = sincos(Î˜norm)
        sinÎ˜2 = sin(Î˜norm/2)
        auxâ‚ = (2*sinÎ˜2/Î˜norm)^2

        u = Î˜/Î˜norm
        uvá¶œ = cross(u, v)
        uváµˆ = dot(u,v)
        UU = u*u'
        VU = v*u'
        UV = u*v'
    
        Káµ¥ =  (cosÎ˜-sinÎ˜/Î˜norm)/Î˜norm * (VU-uváµˆ*UU) + 
              (1-sinÎ˜/Î˜norm)/Î˜norm * (UV - 2*uváµˆ*UU + uváµˆ*ID3) -
              (sinÎ˜/Î˜norm-auxâ‚) * (uvá¶œ*u') +
              auxâ‚ * skew(v)/2
    
    end

    return Káµ¥

end


#  Compute Kâ±â¿áµ— matrix
@inline function KÌ„áµ¢â‚™â‚œ_beam(mat, geom, lâ‚€)
    
    KÌ„áµ¢â‚™â‚œuÌ„ = geom.A*mat.E/lâ‚€
    KÌ„áµ¢â‚™â‚œÎ˜Ì… = Diagonal(@SVector [mat.G*geom.J/lâ‚€, 4*mat.E*geom.Iâ‚ƒâ‚ƒ/lâ‚€, 4*mat.E*geom.Iâ‚‚â‚‚/lâ‚€])
    KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… = Diagonal(@SVector [-mat.G*geom.J/lâ‚€, 2*mat.E*geom.Iâ‚ƒâ‚ƒ/lâ‚€, 2*mat.E*geom.Iâ‚‚â‚‚/lâ‚€])
    
    return KÌ„áµ¢â‚™â‚œuÌ„, KÌ„áµ¢â‚™â‚œÎ˜Ì…, KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì…
    
end


@inline function KÌ„áµ¢â‚™â‚œ_beam12(mat, geom, lâ‚€)
    
    KÌ„áµ¢â‚™â‚œuÌ„ = geom.A*mat.E/lâ‚€
    KÌ„áµ¢â‚™â‚œÎ˜Ì… = @SMatrix [mat.G*geom.J/lâ‚€ 0 0;
                      0 4*mat.E*geom.Iâ‚ƒâ‚ƒ/lâ‚€ 0;
                      0 0 4*mat.E*geom.Iâ‚‚â‚‚/lâ‚€]
    KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… = @SMatrix [-mat.G*geom.J/lâ‚€ 0 0;
                       0 2*mat.E*geom.Iâ‚ƒâ‚ƒ/lâ‚€ 0;
                       0 0 2*mat.E*geom.Iâ‚‚â‚‚/lâ‚€]

    O13 = @SMatrix zeros(1,3)
    O31 = @SMatrix zeros(3,1)

    KÌ„áµ¢â‚™â‚œ = vcat(
        hcat(KÌ„áµ¢â‚™â‚œuÌ„, O13, O13),
        hcat(O31, KÌ„áµ¢â‚™â‚œÎ˜Ì…,  KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì…),
        hcat(O31, KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì…, KÌ„áµ¢â‚™â‚œÎ˜Ì…))

    
    return KÌ„áµ¢â‚™â‚œ
    
end


@inline function compute_Î·_Î¼(Î˜Ì„::AbstractVector{T}) where T

    Î˜ = norm(Î˜Ì„)

    if Î˜<10*eps(T)
        Î· = T(1/12)
        Î¼ = T(1/360)
    else
        sinÎ˜, cosÎ˜ = sincos(Î˜)
        sinÎ˜2 = sin(Î˜/2)
        Î· = ((2*sinÎ˜)-Î˜*(1+cosÎ˜))/(2*(Î˜^2)*sinÎ˜)
        Î¼ = (Î˜*(Î˜+sinÎ˜)-8*(sinÎ˜2)^2)/(4*(Î˜^4)*(sinÎ˜2)^2)
    end
    
    return Î·, Î¼

end




@inline function compute_KÌ„â‚•(Î˜Ì…, MÌ„, Tâ‚›â»Â¹Î˜Ì…, Î·, Î¼)

    Î˜Ì…MÌ„áµ€ = Î˜Ì…*MÌ„'
    MÌ„Î˜Ì…áµ€ = Î˜Ì…MÌ„áµ€'

    SÎ˜Ì… = skew(Î˜Ì…)
    SMÌ„ = skew(MÌ„)

    KÌ„â‚• =  ( Î·*(Î˜Ì…MÌ„áµ€ - 2*MÌ„Î˜Ì…áµ€ + dot(Î˜Ì…, MÌ„)*ID3) + Î¼*(SÎ˜Ì…*SÎ˜Ì…*MÌ„Î˜Ì…áµ€) - SMÌ„/2 ) * Tâ‚›â»Â¹Î˜Ì…

    return KÌ„â‚•

end




@inline function Pmatrices(Nâ‚, Nâ‚‚, Nâ‚ƒ, Nâ‚„, Nâ‚…, Nâ‚†, lâ‚™, Î·, Î·â‚â‚, Î·â‚â‚‚, Î·â‚‚â‚, Î·â‚‚â‚‚)

    Pâ‚PÂ¹ = @SMatrix [0 0 0; 0 (Nâ‚ƒ+Nâ‚„)/lâ‚™ 0; 0 0 (Nâ‚ƒ+Nâ‚„)/lâ‚™]
    Pâ‚PÂ² = @SMatrix [0 0 0; 0 0 Nâ‚ƒ; 0 -Nâ‚ƒ 0]
    Pâ‚PÂ³ = -Pâ‚PÂ¹
    Pâ‚Pâ´ = @SMatrix [0 0 0; 0 0 Nâ‚„; 0 -Nâ‚„ 0]

    Pâ‚‚PÂ¹ = @SMatrix [0 0 -Î·*(Nâ‚+Nâ‚‚)/lâ‚™; 0 0 -(Nâ‚…+Nâ‚†)/lâ‚™; 0 (Nâ‚…+Nâ‚†)/lâ‚™ 0]
    Pâ‚‚PÂ² = @SMatrix [-(Nâ‚‚*Î·â‚â‚‚)/2-Nâ‚*(Î·â‚â‚‚/2 - 1) (Î·â‚â‚*(Nâ‚+Nâ‚‚))/2 0; 0 Nâ‚… 0; 0 0 Nâ‚†]
    Pâ‚‚PÂ³ = -Pâ‚‚PÂ¹
    Pâ‚‚Pâ´ = @SMatrix [-(Nâ‚*Î·â‚‚â‚‚)/2-Nâ‚‚*(Î·â‚‚â‚‚/2 - 1) (Î·â‚‚â‚*(Nâ‚+Nâ‚‚))/2 0; 0 Nâ‚… 0; 0 0 Nâ‚†]


    return Pâ‚PÂ¹, Pâ‚PÂ², Pâ‚PÂ³, Pâ‚Pâ´, Pâ‚‚PÂ¹, Pâ‚‚PÂ², Pâ‚‚PÂ³, Pâ‚‚Pâ´

end




function compute(uâ‚, Î˜â‚, uâ‚‚, Î˜â‚‚, uÌ‡â‚, uÌ‡â‚‚, wÌ‡â‚, wÌ‡â‚‚, uÌˆâ‚, uÌˆâ‚‚, wÌˆâ‚, wÌˆâ‚‚, exact=false, additive=false, symmetrize=true)

    # Superscript Â¹ means matrix or vector associated to uâ‚
    # Superscript Â² means matrix or vector associated to Î˜â‚
    # Superscript Â³ means matrix or vector associated to uâ‚‚
    # Superscript â´ means matrix or vector associated to Î˜â‚‚

    Râ‚ = rotation_matrix(Î˜â‚)
    Râ‚‚ = rotation_matrix(Î˜â‚‚)

    xâ‚ =  Xâ‚ + uâ‚
    xâ‚‚ =  Xâ‚‚ + uâ‚‚
    
    lâ‚™ = norm(xâ‚‚ - xâ‚)

    uÌ„ = lâ‚™ - lâ‚€

    Râ‚‘, rÂ¹, rÂ³, Î·, Î·s, Gáµ€Â¹, Gáµ€Â², Gáµ€Â³, Gáµ€â´, Dâ‚ƒ = local_Râ‚‘_and_aux(xâ‚, xâ‚‚, Râ‚, Râ‚‚, Râ‚‘â°[:,2], lâ‚™)


    RÌ…â‚ = Râ‚‘' * Râ‚ * Râ‚‘â°
    RÌ…â‚‚ = Râ‚‘' * Râ‚‚ * Râ‚‘â°

    Î˜Ì…â‚ = toangle(RÌ…â‚)
    Î˜Ì…â‚‚ = toangle(RÌ…â‚‚)

    if exact
        Tâ‚›â»Â¹Î˜Ì…â‚ = Tâ‚›â»Â¹(Î˜Ì…â‚)
        Tâ‚›â»Â¹Î˜Ì…â‚‚ = Tâ‚›â»Â¹(Î˜Ì…â‚‚)
    end


    PÂ¹Â¹ = -Gáµ€Â¹ 
    PÂ²Â¹ = PÂ¹Â¹
    PÂ¹Â² = ID3-Gáµ€Â²
    PÂ²Â² = -Gáµ€Â²
    PÂ¹Â³ = -Gáµ€Â³
    PÂ²Â³ = PÂ¹Â³
    PÂ¹â´ = -Gáµ€â´
    PÂ²â´ = ID3-Gáµ€â´


    # BÌ„âº = [r; PEáµ€]
    BÌ„âºÂ¹ = rÂ¹
    BÌ„âºÂ³ = rÂ³
    BÌ„âºÂ¹Â¹ = PÂ¹Â¹ * Râ‚‘'
    BÌ„âºÂ²Â¹ = BÌ„âºÂ¹Â¹
    BÌ„âºÂ¹Â² = PÂ¹Â² * Râ‚‘'
    BÌ„âºÂ²Â² = PÂ²Â² * Râ‚‘'
    BÌ„âºÂ¹Â³ = PÂ¹Â³ * Râ‚‘'
    BÌ„âºÂ²Â³ = BÌ„âºÂ¹Â³
    BÌ„âºÂ¹â´ = PÂ¹â´ * Râ‚‘'
    BÌ„âºÂ²â´ = PÂ²â´ * Râ‚‘'

    
    # B = BÌ„BÌ„âº
    BÂ¹ = BÌ„âºÂ¹
    BÂ³ = BÌ„âºÂ³
    BÂ¹Â¹ = exact ?  Tâ‚›â»Â¹Î˜Ì…â‚ * BÌ„âºÂ¹Â¹ : BÌ„âºÂ¹Â¹
    BÂ¹Â² = exact ?  Tâ‚›â»Â¹Î˜Ì…â‚ * BÌ„âºÂ¹Â² : BÌ„âºÂ¹Â²
    BÂ¹Â³ = exact ?  Tâ‚›â»Â¹Î˜Ì…â‚ * BÌ„âºÂ¹Â³ : BÌ„âºÂ¹Â³
    BÂ¹â´ = exact ?  Tâ‚›â»Â¹Î˜Ì…â‚ * BÌ„âºÂ¹â´ : BÌ„âºÂ¹â´
    BÂ²Â¹ = exact ?  Tâ‚›â»Â¹Î˜Ì…â‚‚ * BÌ„âºÂ²Â¹ : BÌ„âºÂ²Â¹
    BÂ²Â² = exact ?  Tâ‚›â»Â¹Î˜Ì…â‚‚ * BÌ„âºÂ²Â² : BÌ„âºÂ²Â²
    BÂ²Â³ = exact ?  Tâ‚›â»Â¹Î˜Ì…â‚‚ * BÌ„âºÂ²Â³ : BÌ„âºÂ²Â³
    BÂ²â´ = exact ?  Tâ‚›â»Â¹Î˜Ì…â‚‚ * BÌ„âºÂ²â´ : BÌ„âºÂ²â´

    

    KÌ„áµ¢â‚™â‚œuÌ„, KÌ„áµ¢â‚™â‚œÎ˜Ì…, KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… = KÌ„áµ¢â‚™â‚œ_beam(mat, geom, lâ‚€)

    # TÌ„áµ¢â‚™â‚œ = KÌ„áµ¢â‚™â‚œ DÌ„
    TÌ„áµ¢â‚™â‚œuÌ„  = KÌ„áµ¢â‚™â‚œuÌ„  * uÌ„
    TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚ = KÌ„áµ¢â‚™â‚œÎ˜Ì…  * Î˜Ì…â‚ + KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * Î˜Ì…â‚‚
    TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚‚ = KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * Î˜Ì…â‚ + KÌ„áµ¢â‚™â‚œÎ˜Ì…  * Î˜Ì…â‚‚

    strain_energy = (uÌ„*TÌ„áµ¢â‚™â‚œuÌ„ + dot(Î˜Ì…â‚, TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚) + dot(Î˜Ì…â‚‚, TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚‚))/2


    # Táµ¢â‚™â‚œ = Báµ€ TÌ„áµ¢â‚™â‚œ
    Táµ¢â‚™â‚œÂ¹ = BÂ¹'*TÌ„áµ¢â‚™â‚œuÌ„ + BÂ¹Â¹'*TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚ + BÂ²Â¹'*TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚‚
    Táµ¢â‚™â‚œÂ² =             BÂ¹Â²'*TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚ + BÂ²Â²'*TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚‚
    Táµ¢â‚™â‚œÂ³ = BÂ³'*TÌ„áµ¢â‚™â‚œuÌ„ + BÂ¹Â³'*TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚ + BÂ²Â³'*TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚‚
    Táµ¢â‚™â‚œâ´ =             BÂ¹â´'*TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚ + BÂ²â´'*TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚‚

    if additive

        Tâ‚›Î˜â‚ = Tâ‚›(Î˜â‚)
        Tâ‚›Î˜â‚‚ = Tâ‚›(Î˜â‚‚)

        Tâ‚‘Â¹ = Táµ¢â‚™â‚œÂ¹
        Tâ‚‘Â² = Tâ‚›Î˜â‚' * Táµ¢â‚™â‚œÂ²
        Tâ‚‘Â³ = Táµ¢â‚™â‚œÂ³
        Tâ‚‘â´ = Tâ‚›Î˜â‚‚' * Táµ¢â‚™â‚œâ´

    else

        Tâ‚‘Â¹ = Táµ¢â‚™â‚œÂ¹
        Tâ‚‘Â² = Táµ¢â‚™â‚œÂ²
        Tâ‚‘Â³ = Táµ¢â‚™â‚œÂ³
        Tâ‚‘â´ = Táµ¢â‚™â‚œâ´

    end

    # Force
    Tâ‚‘ = [Tâ‚‘Â¹; Tâ‚‘Â²; Tâ‚‘Â³; Tâ‚‘â´]


    # [NÌ„ MÌ„âºâ‚ MÌ„âºâ‚‚] = BÌ„áµ€ TÌ„áµ¢â‚™â‚œ
    NÌ„   = TÌ„áµ¢â‚™â‚œuÌ„
    MÌ„âºâ‚ = exact ? Tâ‚›â»Â¹Î˜Ì…â‚' * TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚  : TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚
    MÌ„âºâ‚‚ = exact ? Tâ‚›â»Â¹Î˜Ì…â‚‚' * TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚‚  : TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚‚


    # Qâ‚› = Páµ€ [MÌ„âºâ‚ MÌ„âºâ‚‚]
    Qâ‚›Â¹ = PÂ¹Â¹' * MÌ„âºâ‚ + PÂ²Â¹' * MÌ„âºâ‚‚
    Qâ‚›Â² = PÂ¹Â²' * MÌ„âºâ‚ + PÂ²Â²' * MÌ„âºâ‚‚
    Qâ‚›Â³ = PÂ¹Â³' * MÌ„âºâ‚ + PÂ²Â³' * MÌ„âºâ‚‚
    Qâ‚›â´ = PÂ¹â´' * MÌ„âºâ‚ + PÂ²â´' * MÌ„âºâ‚‚
    

    # Q = S(Qâ‚›)
    QÂ¹ = skew(Qâ‚›Â¹)
    QÂ² = skew(Qâ‚›Â²)
    QÂ³ = skew(Qâ‚›Â³)
    Qâ´ = skew(Qâ‚›â´)

    a = @SVector [0, Î·*(MÌ„âºâ‚[1] + MÌ„âºâ‚‚[1])/lâ‚™ + (MÌ„âºâ‚[2] + MÌ„âºâ‚‚[2])/lâ‚™, (MÌ„âºâ‚[3] + MÌ„âºâ‚‚[3])/lâ‚™]


    # DNÌ„ (DNÌ„Â¹Â¹ = DNÌ„Â³Â³ = -DNÌ„Â¹Â³ = -DNÌ„Â³Â¹)
    DNÌ„Â¹Â¹ = Dâ‚ƒ*NÌ„

    #QGáµ€
    QGáµ€Â¹Â¹ = QÂ¹*Gáµ€Â¹
    QGáµ€Â¹Â² = QÂ¹*Gáµ€Â²
    QGáµ€Â¹â´ = QÂ¹*Gáµ€â´

    QGáµ€Â²Â² = QÂ²*Gáµ€Â²
    QGáµ€Â²Â³ = QÂ²*Gáµ€Â³
    QGáµ€Â²â´ = QÂ²*Gáµ€â´

    QGáµ€Â³â´ = QÂ³*Gáµ€â´

    QGáµ€â´â´ = Qâ´*Gáµ€â´

    if !symmetrize
        QGáµ€Â²Â¹ = QÂ²*Gáµ€Â¹
        QGáµ€Â³Â² = QÂ³*Gáµ€Â²
        QGáµ€â´Â¹ = Qâ´*Gáµ€Â¹
        QGáµ€â´Â² = Qâ´*Gáµ€Â²
        QGáµ€â´Â³ = -QGáµ€â´Â¹
    end


    # EGa (diagonal)
    # Note: Râ‚‘*Ga = 0 for Î˜ indices because Râ‚‘*Gáµ€Î˜' has only non-zero values in the first column and a = [0 ...]
    EGaÂ¹ = Râ‚‘*Gáµ€Â¹'*a

    # EGar (EGarÂ¹Â¹ = EGarÂ³Â³ = -EGarÂ³Â¹ = -EGarÂ¹Â³)
    EGarÂ¹Â¹ = EGaÂ¹*rÂ¹

    # Kâ‚˜ = DNÌ„ - EQGáµ€Eáµ€ + EGar
    Kâ‚˜Â¹Â¹ = DNÌ„Â¹Â¹ - Râ‚‘*QGáµ€Â¹Â¹*Râ‚‘' + EGarÂ¹Â¹
    Kâ‚˜Â¹Â² =      - Râ‚‘*QGáµ€Â¹Â²*Râ‚‘'
    Kâ‚˜Â¹Â³ = -Kâ‚˜Â¹Â¹
    Kâ‚˜Â¹â´ =      - Râ‚‘*QGáµ€Â¹â´*Râ‚‘'
    
    Kâ‚˜Â²Â² =      - Râ‚‘*QGáµ€Â²Â²*Râ‚‘'
    Kâ‚˜Â²Â³ =      - Râ‚‘*QGáµ€Â²Â³*Râ‚‘'
    Kâ‚˜Â²â´ =      - Râ‚‘*QGáµ€Â²â´*Râ‚‘'

    Kâ‚˜Â³Â³ = Kâ‚˜Â¹Â¹
    Kâ‚˜Â³â´ =      - Râ‚‘*QGáµ€Â³â´*Râ‚‘'

    Kâ‚˜â´â´ =      - Râ‚‘*QGáµ€â´â´*Râ‚‘'

    if !symmetrize
        Kâ‚˜Â²Â¹ =      - Râ‚‘*QGáµ€Â²Â¹*Râ‚‘'
        Kâ‚˜Â³Â¹ = Kâ‚˜Â¹Â³
        Kâ‚˜Â³Â² =      - Râ‚‘*QGáµ€Â³Â²*Râ‚‘'
        Kâ‚˜â´Â¹ =      - Râ‚‘*QGáµ€â´Â¹*Râ‚‘'
        Kâ‚˜â´Â² =      - Râ‚‘*QGáµ€â´Â²*Râ‚‘'
        Kâ‚˜â´Â³ =      - Râ‚‘*QGáµ€â´Â³*Râ‚‘'
    end


    # KÌƒ

    if exact

        Î·â‚, Î¼â‚ = compute_Î·_Î¼(Î˜Ì…â‚)
        Î·â‚‚, Î¼â‚‚ = compute_Î·_Î¼(Î˜Ì…â‚‚)

        MÌ„â‚ = TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚
        MÌ„â‚‚ = TÌ„áµ¢â‚™â‚œÎ˜Ì…â‚‚

        KÌ„â‚•â‚ = compute_KÌ„â‚•(Î˜Ì…â‚, MÌ„â‚, Tâ‚›â»Â¹Î˜Ì…â‚, Î·â‚, Î¼â‚)
        KÌ„â‚•â‚‚ = compute_KÌ„â‚•(Î˜Ì…â‚‚, MÌ„â‚‚, Tâ‚›â»Â¹Î˜Ì…â‚‚, Î·â‚‚, Î¼â‚‚)

    end


    KÌƒÂ¹Â¹ = exact ?  BÌ„âºÂ¹Â¹' * KÌ„â‚•â‚ * BÌ„âºÂ¹Â¹  +  BÌ„âºÂ²Â¹' * KÌ„â‚•â‚‚ * BÌ„âºÂ²Â¹  +  Kâ‚˜Â¹Â¹   :   Kâ‚˜Â¹Â¹ 
    KÌƒÂ¹Â² = exact ?  BÌ„âºÂ¹Â¹' * KÌ„â‚•â‚ * BÌ„âºÂ¹Â²  +  BÌ„âºÂ²Â¹' * KÌ„â‚•â‚‚ * BÌ„âºÂ²Â²  +  Kâ‚˜Â¹Â²   :   Kâ‚˜Â¹Â² 
    KÌƒÂ¹Â³ = exact ?  BÌ„âºÂ¹Â¹' * KÌ„â‚•â‚ * BÌ„âºÂ¹Â³  +  BÌ„âºÂ²Â¹' * KÌ„â‚•â‚‚ * BÌ„âºÂ²Â³  +  Kâ‚˜Â¹Â³   :   Kâ‚˜Â¹Â³ 
    KÌƒÂ¹â´ = exact ?  BÌ„âºÂ¹Â¹' * KÌ„â‚•â‚ * BÌ„âºÂ¹â´  +  BÌ„âºÂ²Â¹' * KÌ„â‚•â‚‚ * BÌ„âºÂ²â´  +  Kâ‚˜Â¹â´   :   Kâ‚˜Â¹â´ 

    KÌƒÂ²Â² = exact ?  BÌ„âºÂ¹Â²' * KÌ„â‚•â‚ * BÌ„âºÂ¹Â²  +  BÌ„âºÂ²Â²' * KÌ„â‚•â‚‚ * BÌ„âºÂ²Â²  +  Kâ‚˜Â²Â²   :   Kâ‚˜Â²Â² 
    KÌƒÂ²Â³ = exact ?  BÌ„âºÂ¹Â²' * KÌ„â‚•â‚ * BÌ„âºÂ¹Â³  +  BÌ„âºÂ²Â²' * KÌ„â‚•â‚‚ * BÌ„âºÂ²Â³  +  Kâ‚˜Â²Â³   :   Kâ‚˜Â²Â³ 
    KÌƒÂ²â´ = exact ?  BÌ„âºÂ¹Â²' * KÌ„â‚•â‚ * BÌ„âºÂ¹â´  +  BÌ„âºÂ²Â²' * KÌ„â‚•â‚‚ * BÌ„âºÂ²â´  +  Kâ‚˜Â²â´   :   Kâ‚˜Â²â´ 

    KÌƒÂ³Â³ = exact ?  BÌ„âºÂ¹Â³' * KÌ„â‚•â‚ * BÌ„âºÂ¹Â³  +  BÌ„âºÂ²Â³' * KÌ„â‚•â‚‚ * BÌ„âºÂ²Â³  +  Kâ‚˜Â³Â³   :   Kâ‚˜Â³Â³ 
    KÌƒÂ³â´ = exact ?  BÌ„âºÂ¹Â³' * KÌ„â‚•â‚ * BÌ„âºÂ¹â´  +  BÌ„âºÂ²Â³' * KÌ„â‚•â‚‚ * BÌ„âºÂ²â´  +  Kâ‚˜Â³â´   :   Kâ‚˜Â³â´ 

    KÌƒâ´â´ = exact ?  BÌ„âºÂ¹â´' * KÌ„â‚•â‚ * BÌ„âºÂ¹â´  +  BÌ„âºÂ²â´' * KÌ„â‚•â‚‚ * BÌ„âºÂ²â´  +  Kâ‚˜â´â´   :   Kâ‚˜â´â´ 

    if !symmetrize

        KÌƒÂ²Â¹ = exact ?  BÌ„âºÂ¹Â²' * KÌ„â‚•â‚ * BÌ„âºÂ¹Â¹  +  BÌ„âºÂ²Â²' * KÌ„â‚•â‚‚ * BÌ„âºÂ²Â¹  +  Kâ‚˜Â²Â¹   :   Kâ‚˜Â²Â¹ 
        KÌƒÂ³Â¹ = exact ?  BÌ„âºÂ¹Â³' * KÌ„â‚•â‚ * BÌ„âºÂ¹Â¹  +  BÌ„âºÂ²Â³' * KÌ„â‚•â‚‚ * BÌ„âºÂ²Â¹  +  Kâ‚˜Â³Â¹   :   Kâ‚˜Â³Â¹ 
        KÌƒÂ³Â² = exact ?  BÌ„âºÂ¹Â³' * KÌ„â‚•â‚ * BÌ„âºÂ¹Â²  +  BÌ„âºÂ²Â³' * KÌ„â‚•â‚‚ * BÌ„âºÂ²Â²  +  Kâ‚˜Â³Â²   :   Kâ‚˜Â³Â² 
        KÌƒâ´Â¹ = exact ?  BÌ„âºÂ¹â´' * KÌ„â‚•â‚ * BÌ„âºÂ¹Â¹  +  BÌ„âºÂ²â´' * KÌ„â‚•â‚‚ * BÌ„âºÂ²Â¹  +  Kâ‚˜â´Â¹   :   Kâ‚˜â´Â¹ 
        KÌƒâ´Â² = exact ?  BÌ„âºÂ¹â´' * KÌ„â‚•â‚ * BÌ„âºÂ¹Â²  +  BÌ„âºÂ²â´' * KÌ„â‚•â‚‚ * BÌ„âºÂ²Â²  +  Kâ‚˜â´Â²   :   Kâ‚˜â´Â² 
        KÌƒâ´Â³ = exact ?  BÌ„âºÂ¹â´' * KÌ„â‚•â‚ * BÌ„âºÂ¹Â³  +  BÌ„âºÂ²â´' * KÌ„â‚•â‚‚ * BÌ„âºÂ²Â³  +  Kâ‚˜â´Â³   :   Kâ‚˜â´Â³ 

    end


    # Báµ€Káµ¢â‚™â‚œB
    
    Báµ€Káµ¢â‚™â‚œBÂ¹Â¹ = BÂ¹' * KÌ„áµ¢â‚™â‚œuÌ„ * BÂ¹      +      BÂ¹Â¹' * (KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ¹Â¹  +  KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ²Â¹)  +  BÂ²Â¹' * (KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ¹Â¹  +  KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ²Â¹)    
    Báµ€Káµ¢â‚™â‚œBÂ¹Â² =                              BÂ¹Â¹' * (KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ¹Â²  +  KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ²Â²)  +  BÂ²Â¹' * (KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ¹Â²  +  KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ²Â²)    
    Báµ€Káµ¢â‚™â‚œBÂ¹Â³ = BÂ¹' * KÌ„áµ¢â‚™â‚œuÌ„ * BÂ³      +      BÂ¹Â¹' * (KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ¹Â³  +  KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ²Â³)  +  BÂ²Â¹' * (KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ¹Â³  +  KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ²Â³)    
    Báµ€Káµ¢â‚™â‚œBÂ¹â´ =                              BÂ¹Â¹' * (KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ¹â´  +  KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ²â´)  +  BÂ²Â¹' * (KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ¹â´  +  KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ²â´)    
        
    Báµ€Káµ¢â‚™â‚œBÂ²Â² =                              BÂ¹Â²' * (KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ¹Â²  +  KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ²Â²)  +  BÂ²Â²' * (KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ¹Â²  +  KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ²Â²)    
    Báµ€Káµ¢â‚™â‚œBÂ²Â³ =                              BÂ¹Â²' * (KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ¹Â³  +  KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ²Â³)  +  BÂ²Â²' * (KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ¹Â³  +  KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ²Â³)    
    Báµ€Káµ¢â‚™â‚œBÂ²â´ =                              BÂ¹Â²' * (KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ¹â´  +  KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ²â´)  +  BÂ²Â²' * (KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ¹â´  +  KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ²â´)    
       
    Báµ€Káµ¢â‚™â‚œBÂ³Â³ = BÂ³' * KÌ„áµ¢â‚™â‚œuÌ„ * BÂ³      +      BÂ¹Â³' * (KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ¹Â³  +  KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ²Â³)  +  BÂ²Â³' * (KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ¹Â³  +  KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ²Â³)    
    Báµ€Káµ¢â‚™â‚œBÂ³â´ =                              BÂ¹Â³' * (KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ¹â´  +  KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ²â´)  +  BÂ²Â³' * (KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ¹â´  +  KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ²â´)    
        
    Báµ€Káµ¢â‚™â‚œBâ´â´ =                              BÂ¹â´' * (KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ¹â´  +  KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ²â´)  +  BÂ²â´' * (KÌ„áµ¢â‚™â‚œÎ˜Ì…Î˜Ì… * BÂ¹â´  +  KÌ„áµ¢â‚™â‚œÎ˜Ì… * BÂ²â´)    

    Káµ¢â‚™â‚œÂ¹Â¹ =  Báµ€Káµ¢â‚™â‚œBÂ¹Â¹   +    KÌƒÂ¹Â¹
    Káµ¢â‚™â‚œÂ¹Â² =  Báµ€Káµ¢â‚™â‚œBÂ¹Â²   +    KÌƒÂ¹Â²
    Káµ¢â‚™â‚œÂ¹Â³ =  Báµ€Káµ¢â‚™â‚œBÂ¹Â³   +    KÌƒÂ¹Â³
    Káµ¢â‚™â‚œÂ¹â´ =  Báµ€Káµ¢â‚™â‚œBÂ¹â´   +    KÌƒÂ¹â´

    Káµ¢â‚™â‚œÂ²Â² =  Báµ€Káµ¢â‚™â‚œBÂ²Â²   +    KÌƒÂ²Â²
    Káµ¢â‚™â‚œÂ²Â³ =  Báµ€Káµ¢â‚™â‚œBÂ²Â³   +    KÌƒÂ²Â³
    Káµ¢â‚™â‚œÂ²â´ =  Báµ€Káµ¢â‚™â‚œBÂ²â´   +    KÌƒÂ²â´
    
    Káµ¢â‚™â‚œÂ³Â³ =  Báµ€Káµ¢â‚™â‚œBÂ³Â³   +    KÌƒÂ³Â³
    Káµ¢â‚™â‚œÂ³â´ =  Báµ€Káµ¢â‚™â‚œBÂ³â´   +    KÌƒÂ³â´

    Káµ¢â‚™â‚œâ´â´ =  Báµ€Káµ¢â‚™â‚œBâ´â´   +    KÌƒâ´â´

    if !symmetrize
        Káµ¢â‚™â‚œÂ²Â¹ =  Báµ€Káµ¢â‚™â‚œBÂ¹Â²'  +    KÌƒÂ²Â¹
        Káµ¢â‚™â‚œÂ³Â¹ =  Báµ€Káµ¢â‚™â‚œBÂ¹Â³'  +    KÌƒÂ³Â¹
        Káµ¢â‚™â‚œÂ³Â² =  Báµ€Káµ¢â‚™â‚œBÂ²Â³'  +    KÌƒÂ³Â²
        Káµ¢â‚™â‚œâ´Â¹ =  Báµ€Káµ¢â‚™â‚œBÂ¹â´'  +    KÌƒâ´Â¹
        Káµ¢â‚™â‚œâ´Â² =  Báµ€Káµ¢â‚™â‚œBÂ²â´'  +    KÌƒâ´Â²
        Káµ¢â‚™â‚œâ´Â³ =  Báµ€Káµ¢â‚™â‚œBÂ³â´'  +    KÌƒâ´Â³
    end

    if additive

        Káµ¥â‚ = compute_Káµ¥(Î˜â‚, Táµ¢â‚™â‚œÂ²)
        Káµ¥â‚‚ = compute_Káµ¥(Î˜â‚‚, Táµ¢â‚™â‚œâ´)

        Káµ¢â‚™â‚œÂ¹Â² =         Káµ¢â‚™â‚œÂ¹Â² * Tâ‚›Î˜â‚
        Káµ¢â‚™â‚œÂ¹â´ =         Káµ¢â‚™â‚œÂ¹â´ * Tâ‚›Î˜â‚‚

        Káµ¢â‚™â‚œÂ²Â¹ = Tâ‚›Î˜â‚' * Káµ¢â‚™â‚œÂ²Â¹
        Káµ¢â‚™â‚œÂ²Â² = Tâ‚›Î˜â‚' * Káµ¢â‚™â‚œÂ²Â² * Tâ‚›Î˜â‚ + Káµ¥â‚
        Káµ¢â‚™â‚œÂ²Â³ = Tâ‚›Î˜â‚' * Káµ¢â‚™â‚œÂ²Â³
        Káµ¢â‚™â‚œÂ²â´ = Tâ‚›Î˜â‚' * Káµ¢â‚™â‚œÂ²â´ * Tâ‚›Î˜â‚‚

        Káµ¢â‚™â‚œÂ³Â² =         Káµ¢â‚™â‚œÂ³Â² * Tâ‚›Î˜â‚
        Káµ¢â‚™â‚œÂ³â´ =         Káµ¢â‚™â‚œÂ³â´ * Tâ‚›Î˜â‚‚

        Káµ¢â‚™â‚œâ´Â¹ = Tâ‚›Î˜â‚‚' * Káµ¢â‚™â‚œâ´Â¹
        Káµ¢â‚™â‚œâ´Â² = Tâ‚›Î˜â‚‚' * Káµ¢â‚™â‚œâ´Â² * Tâ‚›Î˜â‚
        Káµ¢â‚™â‚œâ´Â³ = Tâ‚›Î˜â‚‚' * Káµ¢â‚™â‚œâ´Â³
        Káµ¢â‚™â‚œâ´â´ = Tâ‚›Î˜â‚‚' * Káµ¢â‚™â‚œâ´â´ * Tâ‚›Î˜â‚‚ + Káµ¥â‚‚

    end

    if symmetrize
        K = hcat(vcat(Káµ¢â‚™â‚œÂ¹Â¹, Káµ¢â‚™â‚œÂ¹Â²', Káµ¢â‚™â‚œÂ¹Â³', Káµ¢â‚™â‚œÂ¹â´'), vcat(Káµ¢â‚™â‚œÂ¹Â², Káµ¢â‚™â‚œÂ²Â², Káµ¢â‚™â‚œÂ²Â³', Káµ¢â‚™â‚œÂ²â´'), vcat(Káµ¢â‚™â‚œÂ¹Â³, Káµ¢â‚™â‚œÂ²Â³, Káµ¢â‚™â‚œÂ³Â³, Káµ¢â‚™â‚œÂ³â´'), vcat(Káµ¢â‚™â‚œÂ¹â´, Káµ¢â‚™â‚œÂ²â´, Káµ¢â‚™â‚œÂ³â´, Káµ¢â‚™â‚œâ´â´))
    else
        K = hcat(vcat(Káµ¢â‚™â‚œÂ¹Â¹, Káµ¢â‚™â‚œÂ²Â¹, Káµ¢â‚™â‚œÂ³Â¹, Káµ¢â‚™â‚œâ´Â¹), vcat(Káµ¢â‚™â‚œÂ¹Â², Káµ¢â‚™â‚œÂ²Â², Káµ¢â‚™â‚œÂ³Â², Káµ¢â‚™â‚œâ´Â²), vcat(Káµ¢â‚™â‚œÂ¹Â³, Káµ¢â‚™â‚œÂ²Â³, Káµ¢â‚™â‚œÂ³Â³, Káµ¢â‚™â‚œâ´Â³), vcat(Káµ¢â‚™â‚œÂ¹â´, Káµ¢â‚™â‚œÂ²â´, Káµ¢â‚™â‚œÂ³â´, Káµ¢â‚™â‚œâ´â´))
    end


    # 
    UÌ‡â‚ = Râ‚‘' * uÌ‡â‚
    UÌ‡â‚‚ = Râ‚‘' * uÌ‡â‚‚
    WÌ‡â‚ = Râ‚‘' * wÌ‡â‚
    WÌ‡â‚‚ = Râ‚‘' * wÌ‡â‚‚
    
    UÌˆâ‚ = Râ‚‘' * uÌˆâ‚
    UÌˆâ‚‚ = Râ‚‘' * uÌˆâ‚‚
    WÌˆâ‚ = Râ‚‘' * wÌˆâ‚
    WÌˆâ‚‚ = Râ‚‘' * wÌˆâ‚‚

    SUÌ‡â‚ = skew(UÌ‡â‚)
    SUÌ‡â‚‚ = skew(UÌ‡â‚‚)
    SWÌ‡â‚ = skew(WÌ‡â‚)
    SWÌ‡â‚‚ = skew(WÌ‡â‚‚)

    SuÌ‡â‚ = skew(uÌ‡â‚)
    SuÌ‡â‚‚ = skew(uÌ‡â‚‚)
    SwÌ‡â‚ = skew(wÌ‡â‚)
    SwÌ‡â‚‚ = skew(wÌ‡â‚‚)

    WÌ‡áµ‰ = Gáµ€Â¹ * UÌ‡â‚ + Gáµ€Â² * WÌ‡â‚ + Gáµ€Â³ * UÌ‡â‚‚ + Gáµ€â´ * WÌ‡â‚‚
    SWÌ‡áµ‰ = skew(WÌ‡áµ‰)

    
    rdÌ‡ = dot(rÂ¹, uÌ‡â‚) + dot(rÂ³, uÌ‡â‚‚)
    
    

    
    
    T = Float64
    # initialise the local matrices used in the Gauss loop
    kinetic_energy = zero(T)
    
    Tâ‚–Â¹ = zeros(Vec3{T})
    Tâ‚–Â² = zeros(Vec3{T})
    Tâ‚–Â³ = zeros(Vec3{T})
    Tâ‚–â´ = zeros(Vec3{T})

    MÂ¹Â¹ = zeros(Mat33{T})
    MÂ¹Â² = zeros(Mat33{T})
    MÂ¹Â³ = zeros(Mat33{T})
    MÂ¹â´ = zeros(Mat33{T})
    MÂ²Â² = zeros(Mat33{T})
    MÂ²Â³ = zeros(Mat33{T})
    MÂ²â´ = zeros(Mat33{T})
    MÂ³Â³ = zeros(Mat33{T})
    MÂ³â´ = zeros(Mat33{T})
    Mâ´â´ = zeros(Mat33{T})
    

    Câ‚–Â¹Â¹ = zeros(Mat33{T})
    Câ‚–Â¹Â² = zeros(Mat33{T})
    Câ‚–Â¹Â³ = zeros(Mat33{T})
    Câ‚–Â¹â´ = zeros(Mat33{T})
    Câ‚–Â²Â¹ = zeros(Mat33{T})
    Câ‚–Â²Â² = zeros(Mat33{T})
    Câ‚–Â²Â³ = zeros(Mat33{T})
    Câ‚–Â²â´ = zeros(Mat33{T})
    Câ‚–Â³Â¹ = zeros(Mat33{T})
    Câ‚–Â³Â² = zeros(Mat33{T})
    Câ‚–Â³Â³ = zeros(Mat33{T})
    Câ‚–Â³â´ = zeros(Mat33{T})
    Câ‚–â´Â¹ = zeros(Mat33{T})
    Câ‚–â´Â² = zeros(Mat33{T})
    Câ‚–â´Â³ = zeros(Mat33{T})
    Câ‚–â´â´ = zeros(Mat33{T})

    # cycle among the Gauss positions
    for iG in 1:comp.ná´³

        zá´³ = comp.zá´³[iG]
        Ï‰á´³ = comp.Ï‰á´³[iG]

        Î¾ = lâ‚€*(zá´³+1)/2

        # Shape functions
        Nâ‚ = 1-Î¾/lâ‚€
        Nâ‚‚ = 1-Nâ‚
        Nâ‚ƒ = Î¾*(1-Î¾/lâ‚€)^2
        Nâ‚„ = -(1-Î¾/lâ‚€)*((Î¾^2)/lâ‚€)
        Nâ‚… = (1-3*Î¾/lâ‚€)*(1-Î¾/lâ‚€)
        Nâ‚† = (3*Î¾/lâ‚€-2)*(Î¾/lâ‚€)
        Nâ‚‡ = Nâ‚ƒ+Nâ‚„
        Nâ‚ˆ = Nâ‚…+Nâ‚†-1


        uáµ— = @SVector [0, Nâ‚ƒ*Î˜Ì…â‚[3] + Nâ‚„*Î˜Ì…â‚‚[3], -Nâ‚ƒ*Î˜Ì…â‚[2] + -Nâ‚„*Î˜Ì…â‚‚[2]]
        Î˜Ì„  = @SVector [Nâ‚*Î˜Ì…â‚[1] + Nâ‚‚*Î˜Ì…â‚‚[1], Nâ‚…*Î˜Ì…â‚[2] + Nâ‚†*Î˜Ì…â‚‚[2], Nâ‚…*Î˜Ì…â‚[3] + Nâ‚†*Î˜Ì…â‚‚[3]]

        Suáµ— = skew(uáµ—)
        SÎ˜Ì„ = skew(Î˜Ì„)

        RÌ„ = ID3 + SÎ˜Ì„

        IÌ„áµ¨ = RÌ„*mat.Jáµ¨*RÌ„'
        Aáµ¨ = mat.Aáµ¨

        Pâ‚PÂ¹ = @SMatrix [0 0 0; 0 Nâ‚‡/lâ‚™ 0;0 0 Nâ‚‡/lâ‚™]
        Pâ‚PÂ² = @SMatrix [0 0 0; 0 0 Nâ‚ƒ;0 -Nâ‚ƒ 0]
        Pâ‚PÂ³ = -Pâ‚PÂ¹
        Pâ‚Pâ´ = @SMatrix [0 0 0; 0 0 Nâ‚„;0 -Nâ‚„ 0]

        Hâ‚Â¹ = Nâ‚*ID3 + Pâ‚PÂ¹ - Suáµ—*Gáµ€Â¹
        Hâ‚Â² =          Pâ‚PÂ² - Suáµ—*Gáµ€Â²
        Hâ‚Â³ = Nâ‚‚*ID3 + Pâ‚PÂ³ - Suáµ—*Gáµ€Â³
        Hâ‚â´ =          Pâ‚Pâ´ - Suáµ—*Gáµ€â´

        Hâ‚‚Â¹ = @SMatrix [0 0 0; 0  0 -Nâ‚ˆ/lâ‚™;0 Nâ‚ˆ/lâ‚™ 0]
        Hâ‚‚Â² = Diagonal(@SVector [Nâ‚, Nâ‚…, Nâ‚…])
        Hâ‚‚Â³ = -Hâ‚‚Â¹
        Hâ‚‚â´ = Diagonal(@SVector [Nâ‚‚, Nâ‚†, Nâ‚†])

        uÌ‡áµ— =  Pâ‚PÂ¹ * UÌ‡â‚ +  Pâ‚PÂ² * WÌ‡â‚ + Pâ‚PÂ³ * UÌ‡â‚‚ + Pâ‚PÂ² * WÌ‡â‚‚

        SuÌ‡áµ— = skew(uÌ‡áµ—)
        
        Nâ‚‡rdÌ‡ = Nâ‚‡/lâ‚™^2 * rdÌ‡
        HÌ‡â‚Â¹ = Diagonal(@SVector [0, -Nâ‚‡rdÌ‡, -Nâ‚‡rdÌ‡]) - SuÌ‡áµ— * Gáµ€Â¹
        HÌ‡â‚Â² =                                      - SuÌ‡áµ— * Gáµ€Â²
        HÌ‡â‚â´ =                                      - SuÌ‡áµ— * Gáµ€â´

        Nâ‚ˆrdÌ‡ = Nâ‚ˆ/lâ‚™^2 * rdÌ‡
        HÌ‡â‚‚Â¹ = @SMatrix [0 0 0; 0 0 Nâ‚ˆrdÌ‡; 0 -Nâ‚ˆrdÌ‡ 0]

        # hâ‚ = Hâ‚Â¹ * UÌ‡â‚ + Hâ‚Â² * WÌ‡â‚ + Hâ‚Â³ * UÌ‡â‚‚ + Hâ‚â´ * WÌ‡â‚‚
        # hâ‚‚ = Hâ‚‚Â¹ * UÌ‡â‚ + Hâ‚‚Â² * WÌ‡â‚ + Hâ‚‚Â³ * UÌ‡â‚‚ + Hâ‚‚â´ * WÌ‡â‚‚
        hâ‚ = Hâ‚Â¹ * uÌ‡â‚ + Hâ‚Â² * wÌ‡â‚ + Hâ‚Â³ * uÌ‡â‚‚ + Hâ‚â´ * wÌ‡â‚‚
        hâ‚‚ = Hâ‚‚Â¹ * uÌ‡â‚ + Hâ‚‚Â² * wÌ‡â‚ + Hâ‚‚Â³ * uÌ‡â‚‚ + Hâ‚‚â´ * wÌ‡â‚‚
        Shâ‚ = skew(hâ‚)
        Shâ‚‚ = skew(hâ‚‚)

        Câ‚Â¹ = SWÌ‡áµ‰ * Hâ‚Â¹ + HÌ‡â‚Â¹ - Hâ‚Â¹ * SWÌ‡áµ‰
        Câ‚Â² = SWÌ‡áµ‰ * Hâ‚Â² + HÌ‡â‚Â² - Hâ‚Â² * SWÌ‡áµ‰
        Câ‚Â³ = -Câ‚Â¹
        Câ‚â´ = SWÌ‡áµ‰ * Hâ‚â´ + HÌ‡â‚â´ - Hâ‚â´ * SWÌ‡áµ‰

        Câ‚‚Â¹ = SWÌ‡áµ‰ * Hâ‚‚Â¹ + HÌ‡â‚‚Â¹ - Hâ‚‚Â¹ * SWÌ‡áµ‰
        Câ‚‚Â² = SWÌ‡áµ‰ * Hâ‚‚Â²       - Hâ‚‚Â² * SWÌ‡áµ‰
        Câ‚‚Â³ = -Câ‚‚Â¹
        Câ‚‚â´ = SWÌ‡áµ‰ * Hâ‚‚â´       - Hâ‚‚â´ * SWÌ‡áµ‰

        # Hâ‚Fâ‚ = Hâ‚Â¹ * SUÌ‡â‚ + Hâ‚Â² * SWÌ‡â‚ + Hâ‚Â³ * SUÌ‡â‚‚ + Hâ‚â´ * SWÌ‡â‚‚
        # Hâ‚‚Fâ‚ = Hâ‚‚Â¹ * SUÌ‡â‚ + Hâ‚‚Â² * SWÌ‡â‚ + Hâ‚‚Â³ * SUÌ‡â‚‚ + Hâ‚‚â´ * SWÌ‡â‚‚
        Hâ‚Fâ‚ = Hâ‚Â¹ * SuÌ‡â‚ + Hâ‚Â² * SwÌ‡â‚ + Hâ‚Â³ * SuÌ‡â‚‚ + Hâ‚â´ * SwÌ‡â‚‚
        Hâ‚‚Fâ‚ = Hâ‚‚Â¹ * SuÌ‡â‚ + Hâ‚‚Â² * SwÌ‡â‚ + Hâ‚‚Â³ * SuÌ‡â‚‚ + Hâ‚‚â´ * SwÌ‡â‚‚

        Aâ‚DÌ‡rEÂ¹ = @SMatrix [0 0 0; uÌ‡â‚[2]-uÌ‡â‚‚[2] 0 0; uÌ‡â‚[3]-uÌ‡â‚‚[3] 0 0]
        Câ‚ƒÂ¹ = -Shâ‚*Gáµ€Â¹ + Nâ‚‡/lâ‚™^2*Aâ‚DÌ‡rEÂ¹ + SWÌ‡áµ‰*Pâ‚PÂ¹ + Hâ‚Fâ‚*Gáµ€Â¹
        Câ‚ƒÂ² = -Shâ‚*Gáµ€Â² +                  SWÌ‡áµ‰*Pâ‚PÂ² + Hâ‚Fâ‚*Gáµ€Â²
        Câ‚ƒÂ³ = -Câ‚ƒÂ¹
        Câ‚ƒâ´ = -Shâ‚*Gáµ€â´ +                  SWÌ‡áµ‰*Pâ‚Pâ´ + Hâ‚Fâ‚*Gáµ€â´

        Aâ‚‚DÌ‡rEÂ¹ = @SMatrix [0 0 0; -uÌ‡â‚[3]+uÌ‡â‚‚[3] 0 0; uÌ‡â‚[2]-uÌ‡â‚‚[2] 0 0]
        Câ‚„Â¹ = -Shâ‚‚*Gáµ€Â¹ + Nâ‚ˆ/lâ‚™^2*Aâ‚‚DÌ‡rEÂ¹ + Hâ‚‚Fâ‚*Gáµ€Â¹
        Câ‚„Â² = -Shâ‚‚*Gáµ€Â²                  + Hâ‚‚Fâ‚*Gáµ€Â²
        Câ‚„Â³ = -Câ‚„Â¹
        Câ‚„â´ = -Shâ‚‚*Gáµ€â´                  + Hâ‚‚Fâ‚*Gáµ€â´

        uÌ‡â‚€ = Râ‚‘ * (Hâ‚Â¹ * UÌ‡â‚ + Hâ‚Â² * WÌ‡â‚ + Hâ‚Â³ * UÌ‡â‚‚ + Hâ‚â´ * WÌ‡â‚‚)

        Hâ‚Eáµ€dÌˆ = Hâ‚Â¹ * UÌˆâ‚ + Hâ‚Â² * WÌˆâ‚ + Hâ‚Â³ * UÌˆâ‚‚ + Hâ‚â´ * WÌˆâ‚‚
        Câ‚Eáµ€dÌ‡ = Câ‚Â¹ * UÌ‡â‚ + Câ‚Â² * WÌ‡â‚ + Câ‚Â³ * UÌ‡â‚‚ + Câ‚â´ * WÌ‡â‚‚
        Râ‚‘áµ€uÌˆâ‚€ = Hâ‚Eáµ€dÌˆ + Câ‚Eáµ€dÌ‡

        wÌ‡â‚€ = Râ‚‘ * (Hâ‚‚Â¹ * UÌ‡â‚ + Hâ‚‚Â² * WÌ‡â‚ + Hâ‚‚Â³ * UÌ‡â‚‚ + Hâ‚‚â´ * WÌ‡â‚‚)

        Hâ‚‚Eáµ€dÌˆ = Hâ‚‚Â¹ * UÌˆâ‚ + Hâ‚‚Â² * WÌˆâ‚ + Hâ‚‚Â³ * UÌˆâ‚‚ + Hâ‚‚â´ * WÌˆâ‚‚
        Câ‚‚Eáµ€dÌ‡ = Câ‚‚Â¹ * UÌ‡â‚ + Câ‚‚Â² * WÌ‡â‚ + Câ‚‚Â³ * UÌ‡â‚‚ + Câ‚‚â´ * WÌ‡â‚‚
        Râ‚‘áµ€wÌˆâ‚€ = Hâ‚‚Eáµ€dÌˆ + Câ‚‚Eáµ€dÌ‡

        WÌ‡â‚€ = Gáµ€Â¹ * UÌ‡â‚ + Gáµ€Â² * WÌ‡â‚ + Gáµ€Â³ * UÌ‡â‚‚ + Gáµ€â´ * WÌ‡â‚‚ 
        SWÌ‡â‚€ = skew(WÌ‡â‚€)
        IÌ„áµ¨Râ‚‘áµ€wÌˆâ‚€ = IÌ„áµ¨*Râ‚‘áµ€wÌˆâ‚€
        SWÌ‡â‚€IÌ„áµ¨ = SWÌ‡â‚€*IÌ„áµ¨
        SWÌ‡â‚€IÌ„áµ¨WÌ‡â‚€ = SWÌ‡â‚€IÌ„áµ¨*WÌ‡â‚€
        Tâ‚–Â¹ += Ï‰á´³ * (Aáµ¨*Hâ‚Â¹'*Râ‚‘áµ€uÌˆâ‚€ + Hâ‚‚Â¹'*(IÌ„áµ¨Râ‚‘áµ€wÌˆâ‚€ + SWÌ‡â‚€IÌ„áµ¨WÌ‡â‚€))
        Tâ‚–Â² += Ï‰á´³ * (Aáµ¨*Hâ‚Â²'*Râ‚‘áµ€uÌˆâ‚€ + Hâ‚‚Â²'*(IÌ„áµ¨Râ‚‘áµ€wÌˆâ‚€ + SWÌ‡â‚€IÌ„áµ¨WÌ‡â‚€))
        Tâ‚–Â³ += Ï‰á´³ * (Aáµ¨*Hâ‚Â³'*Râ‚‘áµ€uÌˆâ‚€ + Hâ‚‚Â³'*(IÌ„áµ¨Râ‚‘áµ€wÌˆâ‚€ + SWÌ‡â‚€IÌ„áµ¨WÌ‡â‚€))
        Tâ‚–â´ += Ï‰á´³ * (Aáµ¨*Hâ‚â´'*Râ‚‘áµ€uÌˆâ‚€ + Hâ‚‚â´'*(IÌ„áµ¨Râ‚‘áµ€wÌˆâ‚€ + SWÌ‡â‚€IÌ„áµ¨WÌ‡â‚€))


        MÂ¹Â¹ += Ï‰á´³ * (Aáµ¨*Hâ‚Â¹'*Hâ‚Â¹ + Hâ‚‚Â¹'*IÌ„áµ¨*Hâ‚‚Â¹)
        MÂ¹Â² += Ï‰á´³ * (Aáµ¨*Hâ‚Â¹'*Hâ‚Â² + Hâ‚‚Â¹'*IÌ„áµ¨*Hâ‚‚Â²)
        MÂ¹Â³ += Ï‰á´³ * (Aáµ¨*Hâ‚Â¹'*Hâ‚Â³ + Hâ‚‚Â¹'*IÌ„áµ¨*Hâ‚‚Â³)
        MÂ¹â´ += Ï‰á´³ * (Aáµ¨*Hâ‚Â¹'*Hâ‚â´ + Hâ‚‚Â¹'*IÌ„áµ¨*Hâ‚‚â´)

        MÂ²Â² += Ï‰á´³ * (Aáµ¨*Hâ‚Â²'*Hâ‚Â² + Hâ‚‚Â²'*IÌ„áµ¨*Hâ‚‚Â²)
        MÂ²Â³ += Ï‰á´³ * (Aáµ¨*Hâ‚Â²'*Hâ‚Â³ + Hâ‚‚Â²'*IÌ„áµ¨*Hâ‚‚Â³)
        MÂ²â´ += Ï‰á´³ * (Aáµ¨*Hâ‚Â²'*Hâ‚â´ + Hâ‚‚Â²'*IÌ„áµ¨*Hâ‚‚â´)

        MÂ³Â³ += Ï‰á´³ * (Aáµ¨*Hâ‚Â³'*Hâ‚Â³ + Hâ‚‚Â³'*IÌ„áµ¨*Hâ‚‚Â³)
        MÂ³â´ += Ï‰á´³ * (Aáµ¨*Hâ‚Â³'*Hâ‚â´ + Hâ‚‚Â³'*IÌ„áµ¨*Hâ‚‚â´)

        Mâ´â´ += Ï‰á´³ * (Aáµ¨*Hâ‚â´'*Hâ‚â´ + Hâ‚‚â´'*IÌ„áµ¨*Hâ‚‚â´)


        SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ = SWÌ‡â‚€IÌ„áµ¨ - skew(IÌ„áµ¨*WÌ‡â‚€)

        Câ‚–Â¹Â¹ += Ï‰á´³ * (Aáµ¨*Hâ‚Â¹'*(Câ‚Â¹ + Câ‚ƒÂ¹) + Hâ‚‚Â¹'*IÌ„áµ¨*(Câ‚‚Â¹ + Câ‚„Â¹) + Hâ‚‚Â¹' * SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚Â¹ )
        Câ‚–Â¹Â² += Ï‰á´³ * (Aáµ¨*Hâ‚Â¹'*(Câ‚Â² + Câ‚ƒÂ²) + Hâ‚‚Â¹'*IÌ„áµ¨*(Câ‚‚Â² + Câ‚„Â²) + Hâ‚‚Â¹' * SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚Â² )
        Câ‚–Â¹Â³ += Ï‰á´³ * (Aáµ¨*Hâ‚Â¹'*(Câ‚Â³ + Câ‚ƒÂ³) + Hâ‚‚Â¹'*IÌ„áµ¨*(Câ‚‚Â³ + Câ‚„Â³) + Hâ‚‚Â¹' * SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚Â³ )
        Câ‚–Â¹â´ += Ï‰á´³ * (Aáµ¨*Hâ‚Â¹'*(Câ‚â´ + Câ‚ƒâ´) + Hâ‚‚Â¹'*IÌ„áµ¨*(Câ‚‚â´ + Câ‚„â´) + Hâ‚‚Â¹' * SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚â´ )

        Câ‚–Â²Â¹ += Ï‰á´³ * (Aáµ¨*Hâ‚Â²'*(Câ‚Â¹ + Câ‚ƒÂ¹) + Hâ‚‚Â²'*IÌ„áµ¨*(Câ‚‚Â¹ + Câ‚„Â¹) + Hâ‚‚Â²' * SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚Â¹ )
        Câ‚–Â²Â² += Ï‰á´³ * (Aáµ¨*Hâ‚Â²'*(Câ‚Â² + Câ‚ƒÂ²) + Hâ‚‚Â²'*IÌ„áµ¨*(Câ‚‚Â² + Câ‚„Â²) + Hâ‚‚Â²' * SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚Â² )
        Câ‚–Â²Â³ += Ï‰á´³ * (Aáµ¨*Hâ‚Â²'*(Câ‚Â³ + Câ‚ƒÂ³) + Hâ‚‚Â²'*IÌ„áµ¨*(Câ‚‚Â³ + Câ‚„Â³) + Hâ‚‚Â²' * SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚Â³ )
        Câ‚–Â²â´ += Ï‰á´³ * (Aáµ¨*Hâ‚Â²'*(Câ‚â´ + Câ‚ƒâ´) + Hâ‚‚Â²'*IÌ„áµ¨*(Câ‚‚â´ + Câ‚„â´) + Hâ‚‚Â²' * SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚â´ )

        Câ‚–Â³Â¹ += Ï‰á´³ * (Aáµ¨*Hâ‚Â³'*(Câ‚Â¹ + Câ‚ƒÂ¹) + Hâ‚‚Â³'*IÌ„áµ¨*(Câ‚‚Â¹ + Câ‚„Â¹) + Hâ‚‚Â³' * SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚Â¹ )
        Câ‚–Â³Â² += Ï‰á´³ * (Aáµ¨*Hâ‚Â³'*(Câ‚Â² + Câ‚ƒÂ²) + Hâ‚‚Â³'*IÌ„áµ¨*(Câ‚‚Â² + Câ‚„Â²) + Hâ‚‚Â³' * SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚Â² )
        Câ‚–Â³Â³ += Ï‰á´³ * (Aáµ¨*Hâ‚Â³'*(Câ‚Â³ + Câ‚ƒÂ³) + Hâ‚‚Â³'*IÌ„áµ¨*(Câ‚‚Â³ + Câ‚„Â³) + Hâ‚‚Â³' * SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚Â³ )
        Câ‚–Â³â´ += Ï‰á´³ * (Aáµ¨*Hâ‚Â³'*(Câ‚â´ + Câ‚ƒâ´) + Hâ‚‚Â³'*IÌ„áµ¨*(Câ‚‚â´ + Câ‚„â´) + Hâ‚‚Â³' * SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚â´ )

        Câ‚–â´Â¹ += Ï‰á´³ * (Aáµ¨*Hâ‚â´'*(Câ‚Â¹ + Câ‚ƒÂ¹) + Hâ‚‚â´'*IÌ„áµ¨*(Câ‚‚Â¹ + Câ‚„Â¹) + Hâ‚‚â´' * SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚Â¹ )
        Câ‚–â´Â² += Ï‰á´³ * (Aáµ¨*Hâ‚â´'*(Câ‚Â² + Câ‚ƒÂ²) + Hâ‚‚â´'*IÌ„áµ¨*(Câ‚‚Â² + Câ‚„Â²) + Hâ‚‚â´' * SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚Â² )
        Câ‚–â´Â³ += Ï‰á´³ * (Aáµ¨*Hâ‚â´'*(Câ‚Â³ + Câ‚ƒÂ³) + Hâ‚‚â´'*IÌ„áµ¨*(Câ‚‚Â³ + Câ‚„Â³) + Hâ‚‚â´' * SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚Â³ )
        Câ‚–â´â´ += Ï‰á´³ * (Aáµ¨*Hâ‚â´'*(Câ‚â´ + Câ‚ƒâ´) + Hâ‚‚â´'*IÌ„áµ¨*(Câ‚‚â´ + Câ‚„â´) + Hâ‚‚â´' * SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚â´ )



        # kinetic energy
        IÌ„áµ¨áµ = Râ‚‘*IÌ„áµ¨*Râ‚‘'
        kinetic_energy += Ï‰á´³ * (Aáµ¨*uÌ‡â‚€'*uÌ‡â‚€ + wÌ‡â‚€'*IÌ„áµ¨áµ*wÌ‡â‚€)

    end

    Tâ‚–Â¹ = lâ‚€/2*Râ‚‘*Tâ‚–Â¹
    Tâ‚–Â² = lâ‚€/2*Râ‚‘*Tâ‚–Â²
    Tâ‚–Â³ = lâ‚€/2*Râ‚‘*Tâ‚–Â³
    Tâ‚–â´ = lâ‚€/2*Râ‚‘*Tâ‚–â´


    MÂ¹Â¹ = lâ‚€/2* Râ‚‘ * MÂ¹Â¹ * Râ‚‘'
    MÂ¹Â² = lâ‚€/2* Râ‚‘ * MÂ¹Â² * Râ‚‘'
    MÂ¹Â³ = lâ‚€/2* Râ‚‘ * MÂ¹Â³ * Râ‚‘'
    MÂ¹â´ = lâ‚€/2* Râ‚‘ * MÂ¹â´ * Râ‚‘'
    MÂ²Â² = lâ‚€/2* Râ‚‘ * MÂ²Â² * Râ‚‘'
    MÂ²Â³ = lâ‚€/2* Râ‚‘ * MÂ²Â³ * Râ‚‘'
    MÂ²â´ = lâ‚€/2* Râ‚‘ * MÂ²â´ * Râ‚‘'
    MÂ³Â³ = lâ‚€/2* Râ‚‘ * MÂ³Â³ * Râ‚‘'
    MÂ³â´ = lâ‚€/2* Râ‚‘ * MÂ³â´ * Râ‚‘'
    Mâ´â´ = lâ‚€/2* Râ‚‘ * Mâ´â´ * Râ‚‘'

    Câ‚–Â¹Â¹ = lâ‚€/2* Râ‚‘ * Câ‚–Â¹Â¹ * Râ‚‘'
    Câ‚–Â¹Â² = lâ‚€/2* Râ‚‘ * Câ‚–Â¹Â² * Râ‚‘'
    Câ‚–Â¹Â³ = lâ‚€/2* Râ‚‘ * Câ‚–Â¹Â³ * Râ‚‘'
    Câ‚–Â¹â´ = lâ‚€/2* Râ‚‘ * Câ‚–Â¹â´ * Râ‚‘'
    Câ‚–Â²Â¹ = lâ‚€/2* Râ‚‘ * Câ‚–Â²Â¹ * Râ‚‘'
    Câ‚–Â²Â² = lâ‚€/2* Râ‚‘ * Câ‚–Â²Â² * Râ‚‘'
    Câ‚–Â²Â³ = lâ‚€/2* Râ‚‘ * Câ‚–Â²Â³ * Râ‚‘'
    Câ‚–Â²â´ = lâ‚€/2* Râ‚‘ * Câ‚–Â²â´ * Râ‚‘'
    Câ‚–Â³Â¹ = lâ‚€/2* Râ‚‘ * Câ‚–Â³Â¹ * Râ‚‘'
    Câ‚–Â³Â² = lâ‚€/2* Râ‚‘ * Câ‚–Â³Â² * Râ‚‘'
    Câ‚–Â³Â³ = lâ‚€/2* Râ‚‘ * Câ‚–Â³Â³ * Râ‚‘'
    Câ‚–Â³â´ = lâ‚€/2* Râ‚‘ * Câ‚–Â³â´ * Râ‚‘'
    Câ‚–â´Â¹ = lâ‚€/2* Râ‚‘ * Câ‚–â´Â¹ * Râ‚‘'
    Câ‚–â´Â² = lâ‚€/2* Râ‚‘ * Câ‚–â´Â² * Râ‚‘'
    Câ‚–â´Â³ = lâ‚€/2* Râ‚‘ * Câ‚–â´Â³ * Râ‚‘'
    Câ‚–â´â´ = lâ‚€/2* Râ‚‘ * Câ‚–â´â´ * Râ‚‘'

    kinetic_energy = lâ‚€/2* kinetic_energy


    Tâ‚– = [Tâ‚–Â¹; Tâ‚–Â²; Tâ‚–Â³; Tâ‚–â´]
    M = hcat(vcat(MÂ¹Â¹, MÂ¹Â²', MÂ¹Â³', MÂ¹â´'), vcat(MÂ¹Â², MÂ²Â², MÂ²Â³', MÂ²â´'), vcat(MÂ¹Â³, MÂ²Â³, MÂ³Â³, MÂ³â´'), vcat(MÂ¹â´, MÂ²â´, MÂ³â´, Mâ´â´))
    Câ‚– = hcat(vcat(Câ‚–Â¹Â¹, Câ‚–Â²Â¹, Câ‚–Â³Â¹, Câ‚–â´Â¹), vcat(Câ‚–Â¹Â², Câ‚–Â²Â², Câ‚–Â³Â², Câ‚–â´Â²), vcat(Câ‚–Â¹Â³, Câ‚–Â²Â³, Câ‚–Â³Â³, Câ‚–â´Â³), vcat(Câ‚–Â¹â´, Câ‚–Â²â´, Câ‚–Â³â´, Câ‚–â´â´))
    

    return strain_energy, kinetic_energy, Tâ‚‘, Tâ‚–, K, M, Câ‚–



        # if !isnothing(sdf)

        #     xá´³ = Nâ‚*xâ‚ + Nâ‚‚*xâ‚‚ + Râ‚‘*uáµ—
        #     pâ‚™, pâ€²â‚™, Pic_eps, gâ‚™, âˆ‚gâ‚™âˆ‚x, âˆ‚Â²gâ‚™âˆ‚xÂ² =  get_contact_GP(xá´³, comp.Îµá¶œ, sdf, T)

        #     sol_GP.xGP[e.indGP[iG]] = xá´³
        #     sol_GP.gGP[e.indGP[iG]] = gâ‚™/sdf.r
        #     sol_GP.status[e.indGP[iG]] = 0
        #     sol_GP.fGP_N[e.indGP[iG]] = zeros(Vec3{T})
        #     sol_GP.fGP_T[e.indGP[iG]] = zeros(Vec3{T})

        #     if pâ‚™ != 0

        #         Iâˆ‚gâ‚™âˆ‚x = ID3 - âˆ‚gâ‚™âˆ‚x*âˆ‚gâ‚™âˆ‚x'
        #         gÌ‡â‚œ = Iâˆ‚gâ‚™âˆ‚x*Râ‚‘*hâ‚
        #         gÌ‡â‚œÂ² = dot(gÌ‡â‚œ, gÌ‡â‚œ)
                
        #         ğ“–â‚™ = âˆ‚gâ‚™âˆ‚x
        #         ğ“–â‚œ = -comp.Î¼*gÌ‡â‚œ/sqrt(gÌ‡â‚œÂ²+comp.Îµâ‚œ)

        #         sol_GP.fGP_N[e.indGP[iG]] = pâ‚™*ğ“–â‚™
        #         sol_GP.fGP_T[e.indGP[iG]] = pâ‚™*ğ“–â‚œ
        #         sol_GP.status[e.indGP[iG]] = 1

        #         ğ“– = ğ“–â‚™ + ğ“–â‚œ
        #         ğ“¯á¶œ = pâ‚™ * ğ“–

        #         ğ“•á¶œ = Râ‚‘' * ğ“¯á¶œ

        #         Hâ‚áµ€ğ“•á¶œÂ¹ = Hâ‚Â¹' * ğ“•á¶œ
        #         Hâ‚áµ€ğ“•á¶œÂ² = Hâ‚Â²' * ğ“•á¶œ
        #         Hâ‚áµ€ğ“•á¶œÂ³ = Hâ‚Â³' * ğ“•á¶œ
        #         Hâ‚áµ€ğ“•á¶œâ´ = Hâ‚â´' * ğ“•á¶œ

        #         Tá¶œÂ¹ += Ï‰á´³*lâ‚€/2 * (Râ‚‘ * Hâ‚áµ€ğ“•á¶œÂ¹)
        #         Tá¶œÂ² += Ï‰á´³*lâ‚€/2 * (Râ‚‘ * Hâ‚áµ€ğ“•á¶œÂ²)
        #         Tá¶œÂ³ += Ï‰á´³*lâ‚€/2 * (Râ‚‘ * Hâ‚áµ€ğ“•á¶œÂ³)
        #         Tá¶œâ´ += Ï‰á´³*lâ‚€/2 * (Râ‚‘ * Hâ‚áµ€ğ“•á¶œâ´)

        #         SÌ‚Hâ‚áµ€ğ“•á¶œÂ¹ = skew(Hâ‚áµ€ğ“•á¶œÂ¹)
        #         SÌ‚Hâ‚áµ€ğ“•á¶œÂ² = skew(Hâ‚áµ€ğ“•á¶œÂ²)
        #         SÌ‚Hâ‚áµ€ğ“•á¶œÂ³ = skew(Hâ‚áµ€ğ“•á¶œÂ³)
        #         SÌ‚Hâ‚áµ€ğ“•á¶œâ´ = skew(Hâ‚áµ€ğ“•á¶œâ´)

        #         tÂ¹â‚â‚ = -Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œÂ¹ * Gáµ€Â¹ * Râ‚‘'
        #         tÂ¹â‚â‚‚ = -Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œÂ¹ * Gáµ€Â² * Râ‚‘'
        #         tÂ¹â‚â‚ƒ = -Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œÂ¹ * Gáµ€Â³ * Râ‚‘'
        #         tÂ¹â‚â‚„ = -Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œÂ¹ * Gáµ€â´ * Râ‚‘'

        #         tÂ¹â‚‚â‚ = -Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œÂ² * Gáµ€Â¹ * Râ‚‘'
        #         tÂ¹â‚‚â‚‚ = -Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œÂ² * Gáµ€Â² * Râ‚‘'
        #         tÂ¹â‚‚â‚ƒ = -Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œÂ² * Gáµ€Â³ * Râ‚‘'
        #         tÂ¹â‚‚â‚„ = -Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œÂ² * Gáµ€â´ * Râ‚‘'

        #         tÂ¹â‚ƒâ‚ = -Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œÂ³ * Gáµ€Â¹ * Râ‚‘'
        #         tÂ¹â‚ƒâ‚‚ = -Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œÂ³ * Gáµ€Â² * Râ‚‘'
        #         tÂ¹â‚ƒâ‚ƒ = -Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œÂ³ * Gáµ€Â³ * Râ‚‘'
        #         tÂ¹â‚ƒâ‚„ = -Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œÂ³ * Gáµ€â´ * Râ‚‘'

        #         tÂ¹â‚„â‚ = -Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œâ´ * Gáµ€Â¹ * Râ‚‘'
        #         tÂ¹â‚„â‚‚ = -Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œâ´ * Gáµ€Â² * Râ‚‘'
        #         tÂ¹â‚„â‚ƒ = -Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œâ´ * Gáµ€Â³ * Râ‚‘'
        #         tÂ¹â‚„â‚„ = -Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œâ´ * Gáµ€â´ * Râ‚‘'



        #         A = @SMatrix[0 0 0; ğ“•á¶œ[2]*vâ‚[1] ğ“•á¶œ[2]*vâ‚[2] ğ“•á¶œ[2]*vâ‚[3]; ğ“•á¶œ[3]*vâ‚[1] ğ“•á¶œ[3]*vâ‚[2] ğ“•á¶œ[3]*vâ‚[3]]

        #         Aâ‚áµ€ğ“•á¶œrâ‚â‚ = A
        #         Aâ‚áµ€ğ“•á¶œrâ‚â‚ƒ = -A
        #         Aâ‚áµ€ğ“•á¶œrâ‚ƒâ‚ = -A
        #         Aâ‚áµ€ğ“•á¶œrâ‚ƒâ‚ƒ = A

        #         Sğ“•á¶œ = skew(ğ“•á¶œ)


        #         tÂ²â‚â‚ = Nâ‚‡/lâ‚™^2 * Râ‚‘ * Aâ‚áµ€ğ“•á¶œrâ‚â‚ - Râ‚‘ * Gáµ€Â¹' * Sğ“•á¶œ * Pâ‚PÂ¹ * Râ‚‘'
        #         tÂ²â‚â‚‚ =                         - Râ‚‘ * Gáµ€Â¹' * Sğ“•á¶œ * Pâ‚PÂ² * Râ‚‘'
        #         tÂ²â‚â‚ƒ = Nâ‚‡/lâ‚™^2 * Râ‚‘ * Aâ‚áµ€ğ“•á¶œrâ‚â‚ƒ - Râ‚‘ * Gáµ€Â¹' * Sğ“•á¶œ * Pâ‚PÂ³ * Râ‚‘'
        #         tÂ²â‚â‚„ =                         - Râ‚‘ * Gáµ€Â¹' * Sğ“•á¶œ * Pâ‚Pâ´ * Râ‚‘'

        #         tÂ²â‚‚â‚ =                         - Râ‚‘ * Gáµ€Â²' * Sğ“•á¶œ * Pâ‚PÂ¹ * Râ‚‘'
        #         tÂ²â‚‚â‚‚ =                         - Râ‚‘ * Gáµ€Â²' * Sğ“•á¶œ * Pâ‚PÂ² * Râ‚‘'
        #         tÂ²â‚‚â‚ƒ =                         - Râ‚‘ * Gáµ€Â²' * Sğ“•á¶œ * Pâ‚PÂ³ * Râ‚‘'
        #         tÂ²â‚‚â‚„ =                         - Râ‚‘ * Gáµ€Â²' * Sğ“•á¶œ * Pâ‚Pâ´ * Râ‚‘'

        #         tÂ²â‚ƒâ‚ = Nâ‚‡/lâ‚™^2 * Râ‚‘ * Aâ‚áµ€ğ“•á¶œrâ‚ƒâ‚ - Râ‚‘ * Gáµ€Â³' * Sğ“•á¶œ * Pâ‚PÂ¹ * Râ‚‘'
        #         tÂ²â‚ƒâ‚‚ =                         - Râ‚‘ * Gáµ€Â³' * Sğ“•á¶œ * Pâ‚PÂ² * Râ‚‘'
        #         tÂ²â‚ƒâ‚ƒ = Nâ‚‡/lâ‚™^2 * Râ‚‘ * Aâ‚áµ€ğ“•á¶œrâ‚ƒâ‚ƒ - Râ‚‘ * Gáµ€Â³' * Sğ“•á¶œ * Pâ‚PÂ³ * Râ‚‘'
        #         tÂ²â‚ƒâ‚„ =                         - Râ‚‘ * Gáµ€Â³' * Sğ“•á¶œ * Pâ‚Pâ´ * Râ‚‘'

        #         tÂ²â‚„â‚ =                         - Râ‚‘ * Gáµ€â´' * Sğ“•á¶œ * Pâ‚PÂ¹ * Râ‚‘'
        #         tÂ²â‚„â‚‚ =                         - Râ‚‘ * Gáµ€â´' * Sğ“•á¶œ * Pâ‚PÂ² * Râ‚‘'
        #         tÂ²â‚„â‚ƒ =                         - Râ‚‘ * Gáµ€â´' * Sğ“•á¶œ * Pâ‚PÂ³ * Râ‚‘'
        #         tÂ²â‚„â‚„ =                         - Râ‚‘ * Gáµ€â´' * Sğ“•á¶œ * Pâ‚Pâ´ * Râ‚‘'



        #         tÂ³â‚â‚ = -Râ‚‘ * Hâ‚Â¹ * Sğ“•á¶œ * Gáµ€Â¹ * Râ‚‘'
        #         tÂ³â‚â‚‚ = -Râ‚‘ * Hâ‚Â¹ * Sğ“•á¶œ * Gáµ€Â² * Râ‚‘'
        #         tÂ³â‚â‚ƒ = -Râ‚‘ * Hâ‚Â¹ * Sğ“•á¶œ * Gáµ€Â³ * Râ‚‘'
        #         tÂ³â‚â‚„ = -Râ‚‘ * Hâ‚Â¹ * Sğ“•á¶œ * Gáµ€â´ * Râ‚‘'

        #         tÂ³â‚‚â‚ = -Râ‚‘ * Hâ‚Â² * Sğ“•á¶œ * Gáµ€Â¹ * Râ‚‘'
        #         tÂ³â‚‚â‚‚ = -Râ‚‘ * Hâ‚Â² * Sğ“•á¶œ * Gáµ€Â² * Râ‚‘'
        #         tÂ³â‚‚â‚ƒ = -Râ‚‘ * Hâ‚Â² * Sğ“•á¶œ * Gáµ€Â³ * Râ‚‘'
        #         tÂ³â‚‚â‚„ = -Râ‚‘ * Hâ‚Â² * Sğ“•á¶œ * Gáµ€â´ * Râ‚‘'

        #         tÂ³â‚ƒâ‚ = -Râ‚‘ * Hâ‚Â³ * Sğ“•á¶œ * Gáµ€Â¹ * Râ‚‘'
        #         tÂ³â‚ƒâ‚‚ = -Râ‚‘ * Hâ‚Â³ * Sğ“•á¶œ * Gáµ€Â² * Râ‚‘'
        #         tÂ³â‚ƒâ‚ƒ = -Râ‚‘ * Hâ‚Â³ * Sğ“•á¶œ * Gáµ€Â³ * Râ‚‘'
        #         tÂ³â‚ƒâ‚„ = -Râ‚‘ * Hâ‚Â³ * Sğ“•á¶œ * Gáµ€â´ * Râ‚‘'

        #         tÂ³â‚„â‚ = -Râ‚‘ * Hâ‚â´ * Sğ“•á¶œ * Gáµ€Â¹ * Râ‚‘'
        #         tÂ³â‚„â‚‚ = -Râ‚‘ * Hâ‚â´ * Sğ“•á¶œ * Gáµ€Â² * Râ‚‘'
        #         tÂ³â‚„â‚ƒ = -Râ‚‘ * Hâ‚â´ * Sğ“•á¶œ * Gáµ€Â³ * Râ‚‘'
        #         tÂ³â‚„â‚„ = -Râ‚‘ * Hâ‚â´ * Sğ“•á¶œ * Gáµ€â´ * Râ‚‘'




        #         âˆ‚gâ‚™âˆ‚xRâ‚‘hâ‚âˆ‚Â²gâ‚™âˆ‚xÂ² = -dot(âˆ‚gâ‚™âˆ‚x, Râ‚‘ * hâ‚) * âˆ‚Â²gâ‚™âˆ‚xÂ²
        #         Râ‚‘áµ€âˆ‚Â²gâ‚™âˆ‚xÂ²Râ‚‘hâ‚ = Râ‚‘' * âˆ‚Â²gâ‚™âˆ‚xÂ² * Râ‚‘ * hâ‚
        #         ğ“â‚Â¹ =  âˆ‚gâ‚™âˆ‚xRâ‚‘hâ‚âˆ‚Â²gâ‚™âˆ‚xÂ² * Râ‚‘ * Hâ‚Â¹ * Râ‚‘' - âˆ‚gâ‚™âˆ‚x * (Râ‚‘ * Hâ‚Â¹ * Râ‚‘áµ€âˆ‚Â²gâ‚™âˆ‚xÂ²Râ‚‘hâ‚)'
        #         ğ“â‚Â² =  âˆ‚gâ‚™âˆ‚xRâ‚‘hâ‚âˆ‚Â²gâ‚™âˆ‚xÂ² * Râ‚‘ * Hâ‚Â² * Râ‚‘' - âˆ‚gâ‚™âˆ‚x * (Râ‚‘ * Hâ‚Â² * Râ‚‘áµ€âˆ‚Â²gâ‚™âˆ‚xÂ²Râ‚‘hâ‚)'
        #         ğ“â‚Â³ =  âˆ‚gâ‚™âˆ‚xRâ‚‘hâ‚âˆ‚Â²gâ‚™âˆ‚xÂ² * Râ‚‘ * Hâ‚Â³ * Râ‚‘' - âˆ‚gâ‚™âˆ‚x * (Râ‚‘ * Hâ‚Â³ * Râ‚‘áµ€âˆ‚Â²gâ‚™âˆ‚xÂ²Râ‚‘hâ‚)'
        #         ğ“â‚â´ =  âˆ‚gâ‚™âˆ‚xRâ‚‘hâ‚âˆ‚Â²gâ‚™âˆ‚xÂ² * Râ‚‘ * Hâ‚â´ * Râ‚‘' - âˆ‚gâ‚™âˆ‚x * (Râ‚‘ * Hâ‚â´ * Râ‚‘áµ€âˆ‚Â²gâ‚™âˆ‚xÂ²Râ‚‘hâ‚)'

        #         Iâˆ‚gâ‚™âˆ‚xRâ‚‘Shâ‚ = - Iâˆ‚gâ‚™âˆ‚x * Râ‚‘ * Shâ‚
        #         ğ“â‚‚Â¹ = Iâˆ‚gâ‚™âˆ‚xRâ‚‘Shâ‚ * Gáµ€Â¹ * Râ‚‘'
        #         ğ“â‚‚Â² = Iâˆ‚gâ‚™âˆ‚xRâ‚‘Shâ‚ * Gáµ€Â² * Râ‚‘'
        #         ğ“â‚‚Â³ = Iâˆ‚gâ‚™âˆ‚xRâ‚‘Shâ‚ * Gáµ€Â³ * Râ‚‘'
        #         ğ“â‚‚â´ = Iâˆ‚gâ‚™âˆ‚xRâ‚‘Shâ‚ * Gáµ€â´ * Râ‚‘'

        #         ğ“â‚ƒÂ¹ = Iâˆ‚gâ‚™âˆ‚x * Nâ‚‡/lâ‚™^2 * Râ‚‘ * Aâ‚DÌ‡rÂ¹ + Râ‚‘ * skew(Gáµ€Â¹ * UÌ‡â‚) * Pâ‚PÂ¹ * Râ‚‘'
        #         ğ“â‚ƒÂ² =                                  Râ‚‘ * skew(Gáµ€Â² * WÌ‡â‚) * Pâ‚PÂ² * Râ‚‘'
        #         ğ“â‚ƒÂ³ = Iâˆ‚gâ‚™âˆ‚x * Nâ‚‡/lâ‚™^2 * Râ‚‘ * Aâ‚DÌ‡rÂ³ + Râ‚‘ * skew(Gáµ€Â³ * UÌ‡â‚‚) * Pâ‚PÂ³ * Râ‚‘'
        #         ğ“â‚ƒâ´ =                                  Râ‚‘ * skew(Gáµ€â´ * WÌ‡â‚‚) * Pâ‚Pâ´ * Râ‚‘'



        #         # eq110 in [2]
        #         Inn = ID3 - âˆ‚gâ‚™âˆ‚x*âˆ‚gâ‚™âˆ‚x'
        #         dgT = Inn*Râ‚‘*H1G*E'*DÌ‡
        #         dgTdgT = dot(dgT,dgT)
                
        #         G_eN = âˆ‚gâ‚™âˆ‚x


                

        #     end


    
end


# # information from node 1 and 2
const Xâ‚ = @SVector [0.91, 0.58, 0.68]
const Xâ‚‚ = @SVector [0.97, 0.04, 0.41]

const lâ‚€ = norm(Xâ‚‚-Xâ‚)

uâ‚ = @SVector [0.8, 0.5, 0.1]
uâ‚‚ = @SVector [0.9, 0.52, 0.14]

Î˜â‚ = @SVector [-0.2423, 0.9047, 0.5896]
Î˜â‚‚ = @SVector [-0.2394, 0.8994, 0.5902]


uÌ‡â‚ = @SVector [0.01, 0.02, -0.01]
uÌ‡â‚‚ = @SVector [0.013, -0.02, -0.015]

wÌ‡â‚ = @SVector [-0.02423, 0.009047, 0.005896]
wÌ‡â‚‚ = @SVector [-0.002394, 0.008994, 0.005902]

uÌˆâ‚ = @SVector [0.008, 0.005, 0.001]
uÌˆâ‚‚ = @SVector [0.009, 0.0052, 0.0014]

wÌˆâ‚ = @SVector [-0.002423, 0.009047, 0.005896]
wÌˆâ‚‚ = @SVector [-0.002394, 0.008994, 0.005902]


const mat = (E = 1., G = 0.1, Jáµ¨ = Diagonal(@SVector [20, 10, 10]), Aáµ¨ = 0.01)
const geom = (A = 0.01, J = 0.01, Iâ‚ƒâ‚ƒ = 0.01, Iâ‚‚â‚‚ = 0.01)
const comp = (ná´³ = 3, zá´³ = @SVector[-sqrt(3/5), 0, sqrt(3/5)], Ï‰á´³ = @SVector[5/9, 8/9, 5/9] )


const Râ‚‘â° = local_Râ°(Xâ‚, Xâ‚‚)


# using BenchmarkTools

# @btime Tâ±â¿áµ—($x)
# @btime Kâ±â¿áµ—($x)



function compare(test, correct, disp=true)
    m = maximum(correct)
    if disp
        display(test)
        display(correct)
        display(test - correct)
    end
    return maximum(abs.(test - correct))/m
end


function finitediff_statics(exact=false, additive=false, symmetrize=true)

    _, _, ftest, _, Ktest, _, _ = compute(uâ‚, Î˜â‚, uâ‚‚, Î˜â‚‚, uÌ‡â‚, uÌ‡â‚‚, wÌ‡â‚, wÌ‡â‚‚, uÌˆâ‚, uÌˆâ‚‚, wÌˆâ‚, wÌˆâ‚‚, exact, additive, symmetrize)

    H = zeros(12,12)
    F = zeros(12)
    Îµ = 1e-6


    for i in 1:12
        uâ‚âº = uâ‚â» = uâ‚
        Î˜â‚âº = Î˜â‚â» = Î˜â‚
        uâ‚‚âº = uâ‚‚â» = uâ‚‚
        Î˜â‚‚âº = Î˜â‚‚â» = Î˜â‚‚
        if i in [1,2,3,7,8,9]
            Î” = @SVector [k==mod1(i,3) ? Îµ : 0 for k in 1:3]
            if i in [1,2,3]
                uâ‚âº = uâ‚ + Î”
                uâ‚â» = uâ‚ - Î”
            else
                uâ‚‚âº = uâ‚‚ + Î”
                uâ‚‚â» = uâ‚‚ - Î”
            end
        else
            Î˜ = i in [4,5,6] ? Î˜â‚ : Î˜â‚‚
            Î” = @SVector [k==mod1(i,3) ? Îµ : 0 for k in 1:3]
            if additive
                Î˜âº = Î”
                Î˜â» = -Î”
            else
                Î˜âº = toangle(rotation_matrix(Î”) * rotation_matrix(Î˜))
                Î˜â» = toangle(rotation_matrix(-Î”) * rotation_matrix(Î˜))
            end
            if i in [4,5,6]
                Î˜â‚âº = Î˜âº
                Î˜â‚â» = Î˜â»
            else
                Î˜â‚‚âº = Î˜âº
                Î˜â‚‚â» = Î˜â»
            end
        end

        eâº, _, fâº, _, _, _, _ = compute(uâ‚âº, Î˜â‚âº, uâ‚‚âº, Î˜â‚‚âº, uÌ‡â‚, uÌ‡â‚‚, wÌ‡â‚, wÌ‡â‚‚, uÌˆâ‚, uÌˆâ‚‚, wÌˆâ‚, wÌˆâ‚‚, true, false, false)
        eâ», _, fâ», _, _, _, _ = compute(uâ‚â», Î˜â‚â», uâ‚‚â», Î˜â‚‚â», uÌ‡â‚, uÌ‡â‚‚, wÌ‡â‚, wÌ‡â‚‚, uÌˆâ‚, uÌˆâ‚‚, wÌˆâ‚, wÌˆâ‚‚, true, false, false)
        F[i] = (eâº-eâ»)/(2*Îµ)
        H[:, i] .= (fâº-fâ»)/(2*Îµ)
    end

    return compare(ftest, F), compare(Ktest, H)

end





finitediff_statics(true, false, false)






function finitediff_dynamic(exact=false, additive=false, symmetrize=true)

    _, _, _, ftest, _, _, _ = compute(uâ‚, Î˜â‚, uâ‚‚, Î˜â‚‚, uÌ‡â‚, uÌ‡â‚‚, wÌ‡â‚, wÌ‡â‚‚, uÌˆâ‚, uÌˆâ‚‚, wÌˆâ‚, wÌˆâ‚‚, exact, additive, symmetrize)

    H = zeros(12,12)
    F = zeros(12)
    Îµ = 1e-6


    for i in 1:12
        uâ‚âº = uâ‚â» = uâ‚
        Î˜â‚âº = Î˜â‚â» = Î˜â‚
        uâ‚‚âº = uâ‚‚â» = uâ‚‚
        Î˜â‚‚âº = Î˜â‚‚â» = Î˜â‚‚
        if i in [1,2,3,7,8,9]
            Î” = @SVector [k==mod1(i,3) ? Îµ : 0 for k in 1:3]
            if i in [1,2,3]
                uâ‚âº = uâ‚ + Î”
                uâ‚â» = uâ‚ - Î”
            else
                uâ‚‚âº = uâ‚‚ + Î”
                uâ‚‚â» = uâ‚‚ - Î”
            end
        else
            Î˜ = i in [4,5,6] ? Î˜â‚ : Î˜â‚‚
            Î” = @SVector [k==mod1(i,3) ? Îµ : 0 for k in 1:3]
            if additive
                Î˜âº = Î”
                Î˜â» = -Î”
            else
                Î˜âº = toangle(rotation_matrix(Î”) * rotation_matrix(Î˜))
                Î˜â» = toangle(rotation_matrix(-Î”) * rotation_matrix(Î˜))
            end
            if i in [4,5,6]
                Î˜â‚âº = Î˜âº
                Î˜â‚â» = Î˜â»
            else
                Î˜â‚‚âº = Î˜âº
                Î˜â‚‚â» = Î˜â»
            end
        end

        _, eâº, _, _, _, _, _ = compute(uâ‚âº, Î˜â‚âº, uâ‚‚âº, Î˜â‚‚âº, uÌ‡â‚, uÌ‡â‚‚, wÌ‡â‚, wÌ‡â‚‚, uÌˆâ‚, uÌˆâ‚‚, wÌˆâ‚, wÌˆâ‚‚, true, false, false)
        _, eâ», _, _, _, _, _ = compute(uâ‚â», Î˜â‚â», uâ‚‚â», Î˜â‚‚â», uÌ‡â‚, uÌ‡â‚‚, wÌ‡â‚, wÌ‡â‚‚, uÌˆâ‚, uÌˆâ‚‚, wÌˆâ‚, wÌˆâ‚‚, true, false, false)
        F[i] = (eâº-eâ»)/(2*Îµ)
    end

    return compare(ftest, F)

end

finitediff_dynamic()