
# Rotate using Rodrigue's formula
@inline function rotation_matrix(ฮ::AbstractVecOrMat{T}) where T
    
    ฮ_norm = norm(ฮ)
    if ฮ_norm > 10*eps(T)
        sinฮ = sin(ฮ_norm)
        Sฮ = skew(ฮ)
        R = ID3 + sinฮ/ฮ_norm*Sฮ +  2*(sin(ฮ_norm/2)/ฮ_norm)^2 * Sฮ*Sฮ
        return R
    else
        return SMatrix{3,3,T,9}(1,0,0,0,1,0,0,0,1)
    end

end


@inline function local_Rโฐ(xโ, xโ)

    vโ = xโ - xโ
    l = norm(vโ)
    vโ = vโ/l
    eโ = @SVector [0,1,0]
    eโ = @SVector [0,0,1]

    if ( vโ[1] > 1e-8*l ) || ( vโ[2] > 1e-8*l )
        aux = cross(eโ, vโ)
        vโ = aux/norm(aux)
    else
        T = eltype(vโ)
        vโ = T.(eโ)
    end
    
    vโ = cross(vโ, vโ)

    Rโ = [vโ vโ vโ]

    return Rโ

end


    



@inline function local_Rโ_and_aux(xโ, xโ, Rโ, Rโ, RโโฐEโ, lโ)

    vโ = (xโ - xโ)/lโ
    pโ = Rโ * RโโฐEโ
    pโ = Rโ * RโโฐEโ
    p = (pโ+pโ)/2
    vโ = cross(vโ, p)
    vโ = vโ / norm(vโ)
    vโ = cross(vโ, vโ)

    Rโ = [vโ vโ vโ]

    ruโ = -vโ'
    ruโ = vโ'

    Rโยนยฒแต = Rโ[:, SOneTo(2)]'

    qโ, qโ = Rโยนยฒแต*p
    qยนยน, qยนยฒ = Rโยนยฒแต*pโ
    qยฒยน, qยฒยฒ = Rโยนยฒแต*pโ
    
    ฮท = qโ/qโ
    ฮทยนยน = qยนยน/qโ
    ฮทยนยฒ = qยนยฒ/qโ
    ฮทยฒยน = qยฒยน/qโ
    ฮทยฒยฒ = qยฒยฒ/qโ

    Gแตuโ = @SMatrix [0 0 ฮท/lโ; 0 0 1/lโ; 0 -1/lโ 0]
    Gแตuโ = -Gแตuโ
    Gแตฮโ = @SMatrix [ฮทยนยฒ/2 -ฮทยนยน/2 0; 0 0 0; 0 0 0]
    Gแตฮโ = @SMatrix [ฮทยฒยฒ/2 -ฮทยฒยน/2 0; 0 0 0; 0 0 0]

    Dโ = (ID3 - vโ*vโ')/lโ

    return Rโ, ruโ, ruโ, ฮท, Gแตuโ, Gแตฮโ, Gแตuโ, Gแตฮโ, Dโ
end




@inline function toangle(R::AbstractMatrix{T}) where T

    if abs((tr(R)-1)/2) < 1
        norm_v = max(acos((tr(R)-1)/2), 10*eps(T))
    else
        norm_v = 10*eps(T)
    end

    n_v = (1/(2*sin(norm_v))) * @SVector [R[3,2]-R[2,3], R[1,3]-R[3,1], R[2,1]-R[1,2]]

    return norm_v*n_v

end


@inline function skew(vec)

    return @SMatrix [0       -vec[3] vec[2] ;
                     vec[3]  0       -vec[1];
                     -vec[2] vec[1]  0      ]

end

# Get the inverse of skew symmetric matrix from toangle
@inline function Tโโปยน(ฮ::AbstractVector{T}) where T

    ฮ_norm = norm(ฮ)

    if ฮ_norm < 10*eps(T)
        Tโโปยน = SMatrix{3,3,T,9}(1,0,0,0,1,0,0,0,1)
    else
        Sฮ = skew(ฮ)
        sinฮ2, cosฮ2 = sincos(ฮ_norm/2)
        Tโโปยน = ID3 - Sฮ/2 + (sinฮ2-ฮ_norm/2*cosฮ2)/(sinฮ2*ฮ_norm^2)*Sฮ*Sฮ
    end

    return Tโโปยน

end


@inline function Tโ(ฮ::AbstractVector{T}) where T

    ฮ_norm = norm(ฮ)

    if ฮ_norm < 10*eps(T)
        Tโ = SMatrix{3,3,T,9}(1, 0, 0, 0, 1, 0, 0, 0, 1)
    else
        Sฮ = skew(ฮ)
        Tโ = ID3 + 2*(sin(ฮ_norm/2)/ฮ_norm)^2*Sฮ + (1-sin(ฮ_norm)/ฮ_norm)/ฮ_norm^2*(Sฮ*Sฮ)
    end

    return Tโ

end


@inline function compute_Kแตฅ(ฮ::AbstractVector{T}, v) where T

    ฮnorm = norm(ฮ)

    if ฮnorm < 10*eps(T)
        Kแตฅ = skew(v)/2
    else
        sinฮ, cosฮ = sincos(ฮnorm)
        sinฮ2 = sin(ฮnorm/2)
        aux = (2*sinฮ2/ฮnorm)^2

        u = ฮ/ฮnorm
        uvแถ = cross(u, v)
        uvแต = dot(u,v)
        UU = u*u'
        VU = v*u'
        UV = u*v'
    
        Kแตฅ =  (cosฮ-sinฮ/ฮnorm)/ฮnorm * (VU-uvแต*UU) + 
              (1-sinฮ/ฮnorm)/ฮnorm * (UV - 2*uvแต*UU + uvแต*ID3) -
              (sinฮ/ฮnorm-aux) * (uvแถ*u') +
              aux * skew(v)/2
    
    end

    return Kแตฅ

end


#  Compute Kint matrix
@inline function Kฬโฑโฟแต_beam(E, G, Iโ, A, Iโโ, Iโโ, lโ)
    
    Kฬโฑโฟแตuฬ = A*E/lโ
    Kฬโฑโฟแตฮฬ = Diagonal(@SVector [G*Iโ/lโ, 4*E*Iโโ/lโ, 4*E*Iโโ/lโ])
    Kฬโฑโฟแตฮฬฮฬ = Diagonal(@SVector [-G*Iโ/lโ, 2*E*Iโโ/lโ, 2*E*Iโโ/lโ])
    
    return Kฬโฑโฟแตuฬ, Kฬโฑโฟแตฮฬ, Kฬโฑโฟแตฮฬฮฬ
    
end




@inline function compute_ฮท_ฮผ(ฮฬ::AbstractVector{T}) where T

    ฮ = norm(ฮฬ)

    if ฮ<10*eps(T)
        ฮท = T(1/12)
        ฮผ = T(1/360)
    else
        sinฮ, cosฮ = sincos(ฮ)
        sinฮ2 = sin(ฮ/2)
        ฮท = ((2*sinฮ)-ฮ*(1+cosฮ))/(2*(ฮ^2)*sinฮ)
        ฮผ = (ฮ*(ฮ+sinฮ)-8*(sinฮ2)^2)/(4*(ฮ^4)*(sinฮ2)^2)
    end
    
    return ฮท, ฮผ

end




@inline function compute_Kฬโ(ฮฬ, Mฬ, Tโโปยนฮฬ, ฮท, ฮผ)

    ฮฬMฬแต = ฮฬ*Mฬ'
    Mฬฮฬแต = ฮฬMฬแต'

    Sฮฬ = skew(ฮฬ)
    SMฬ = skew(Mฬ)

    Kฬโ =  ( ฮท*(ฮฬMฬแต - 2*Mฬฮฬแต + dot(ฮฬ, Mฬ)*ID3) + ฮผ*(Sฮฬ*Sฮฬ*Mฬฮฬแต) - SMฬ/2 ) * Tโโปยนฮฬ

    return Kฬโ

end




@inline function Pmatrices(Nโ, Nโ, Nโ, Nโ, Nโ, Nโ, lโ, ฮท, ฮทโโ, ฮทโโ, ฮทโโ, ฮทโโ)

    PโPยน = @SMatrix [0 0 0; 0 (Nโ+Nโ)/lโ 0; 0 0 (Nโ+Nโ)/lโ]
    PโPยฒ = @SMatrix [0 0 0; 0 0 Nโ; 0 -Nโ 0]
    PโPยณ = -PโPยน
    PโPโด = @SMatrix [0 0 0; 0 0 Nโ; 0 -Nโ 0]

    PโPยน = @SMatrix [0 0 -ฮท*(Nโ+Nโ)/lโ; 0 0 -(Nโ+Nโ)/lโ; 0 (Nโ+Nโ)/lโ 0]
    PโPยฒ = @SMatrix [-(Nโ*ฮทโโ)/2-Nโ*(ฮทโโ/2 - 1) (ฮทโโ*(Nโ+Nโ))/2 0; 0 Nโ 0; 0 0 Nโ]
    PโPยณ = -PโPยน
    PโPโด = @SMatrix [-(Nโ*ฮทโโ)/2-Nโ*(ฮทโโ/2 - 1) (ฮทโโ*(Nโ+Nโ))/2 0; 0 Nโ 0; 0 0 Nโ]


    return PโPยน, PโPยฒ, PโPยณ, PโPโด, PโPยน, PโPยฒ, PโPยณ, PโPโด

end








function compute(uโ::AbstractVector{T}, uโ, Rโ, Rโ, ฮRโ, ฮRโ, uฬโ, uฬโ, wฬโ, wฬโ, uฬโ, uฬโ, wฬโ, wฬโ, constants, exact=true, isdynamic=true) where T

    # Superscript ยน means matrix or vector associated to uโ
    # Superscript ยฒ means matrix or vector associated to ฮโ
    # Superscript ยณ means matrix or vector associated to uโ
    # Superscript โด means matrix or vector associated to ฮโ

    init, gausspoints_info, beamproperties, contactparams, sdf, ฮt, gausspoints = constants
    iB, Xโ, Xโ, lโ, Rโโฐ = init
    nG, ฯG, zG = gausspoints_info
    @unpack Kฬโฑโฟแต, Jแตจ, Aแตจ, damping = beamproperties
    
    contactsearch = !(isnothing(sdf) || isnothing(contactparams))

    xโ =  Xโ + uโ
    xโ =  Xโ + uโ
    
    lโ = norm(xโ - xโ)

    uฬ = lโ - lโ

    Rโ, rยน, rยณ, ฮท, Gแตยน, Gแตยฒ, Gแตยณ, Gแตโด, Dโ = local_Rโ_and_aux(xโ, xโ, Rโ, Rโ, Rโโฐ[:,2], lโ)


    Rฬโ = Rโ' * Rโ * Rโโฐ
    Rฬโ = Rโ' * Rโ * Rโโฐ

    ฮฬโ = toangle(Rฬโ)
    ฮฬโ = toangle(Rฬโ)

    if exact
        Tโโปยนฮฬโ = Tโโปยน(ฮฬโ)
        Tโโปยนฮฬโ = Tโโปยน(ฮฬโ)
    end


    Pยนยน = -Gแตยน 
    Pยฒยน = Pยนยน
    Pยนยฒ = ID3-Gแตยฒ
    Pยฒยฒ = -Gแตยฒ
    Pยนโด = -Gแตโด
    Pยฒโด = ID3-Gแตโด


    # Bฬโบ = [r; PEแต]
    Bฬโบยน = rยน
    Bฬโบยนยน = Pยนยน * Rโ'
    Bฬโบยฒยน = Bฬโบยนยน
    Bฬโบยนยฒ = Pยนยฒ * Rโ'
    Bฬโบยฒยฒ = Pยฒยฒ * Rโ'
    Bฬโบยนโด = Pยนโด * Rโ'
    Bฬโบยฒโด = Pยฒโด * Rโ'

    
    # B = BฬBฬโบ
    Bยน = Bฬโบยน
    Bยนยน = exact ?  Tโโปยนฮฬโ * Bฬโบยนยน : Bฬโบยนยน
    Bยนยฒ = exact ?  Tโโปยนฮฬโ * Bฬโบยนยฒ : Bฬโบยนยฒ
    Bยนโด = exact ?  Tโโปยนฮฬโ * Bฬโบยนโด : Bฬโบยนโด
    Bยฒยน = exact ?  Tโโปยนฮฬโ * Bฬโบยฒยน : Bฬโบยฒยน
    Bยฒยฒ = exact ?  Tโโปยนฮฬโ * Bฬโบยฒยฒ : Bฬโบยฒยฒ
    Bยฒโด = exact ?  Tโโปยนฮฬโ * Bฬโบยฒโด : Bฬโบยฒโด

    

    Kฬโฑโฟแตuฬ, Kฬโฑโฟแตฮฬ, Kฬโฑโฟแตฮฬฮฬ = Kฬโฑโฟแต

    # Tฬโฑโฟแต = Kฬโฑโฟแต Dฬ
    Tฬโฑโฟแตuฬ  = Kฬโฑโฟแตuฬ  * uฬ
    Tฬโฑโฟแตฮฬโ = Kฬโฑโฟแตฮฬ  * ฮฬโ + Kฬโฑโฟแตฮฬฮฬ * ฮฬโ
    Tฬโฑโฟแตฮฬโ = Kฬโฑโฟแตฮฬฮฬ * ฮฬโ + Kฬโฑโฟแตฮฬ  * ฮฬโ

    strain_energy = (uฬ*Tฬโฑโฟแตuฬ + dot(ฮฬโ, Tฬโฑโฟแตฮฬโ) + dot(ฮฬโ, Tฬโฑโฟแตฮฬโ))/2

    # Tโฑโฟแต = Bแต Tฬโฑโฟแต
    Tโฑโฟแตยน = Bยน'*Tฬโฑโฟแตuฬ + Bยนยน'*Tฬโฑโฟแตฮฬโ + Bยฒยน'*Tฬโฑโฟแตฮฬโ
    Tโฑโฟแตยฒ =             Bยนยฒ'*Tฬโฑโฟแตฮฬโ + Bยฒยฒ'*Tฬโฑโฟแตฮฬโ
    Tโฑโฟแตยณ = -Tโฑโฟแตยน
    Tโฑโฟแตโด =             Bยนโด'*Tฬโฑโฟแตฮฬโ + Bยฒโด'*Tฬโฑโฟแตฮฬโ



    # Force
    Tโฑโฟแต = [Tโฑโฟแตยน; Tโฑโฟแตยฒ; Tโฑโฟแตยณ; Tโฑโฟแตโด]


    # [Nฬ Mฬโบโ Mฬโบโ] = Bฬแต Tฬโฑโฟแต
    Nฬ   = Tฬโฑโฟแตuฬ
    Mฬโบโ = exact ? Tโโปยนฮฬโ' * Tฬโฑโฟแตฮฬโ  : Tฬโฑโฟแตฮฬโ
    Mฬโบโ = exact ? Tโโปยนฮฬโ' * Tฬโฑโฟแตฮฬโ  : Tฬโฑโฟแตฮฬโ


    # Qโ = Pแต [Mฬโบโ Mฬโบโ]
    Qโยน = Pยนยน' * Mฬโบโ + Pยฒยน' * Mฬโบโ
    Qโยฒ = Pยนยฒ' * Mฬโบโ + Pยฒยฒ' * Mฬโบโ
    Qโโด = Pยนโด' * Mฬโบโ + Pยฒโด' * Mฬโบโ
    

    # Q = S(Qโ)
    Qยน = skew(Qโยน)
    Qยฒ = skew(Qโยฒ)
    Qโด = skew(Qโโด)

    a = @SVector [0, ฮท*(Mฬโบโ[1] + Mฬโบโ[1])/lโ + (Mฬโบโ[2] + Mฬโบโ[2])/lโ, (Mฬโบโ[3] + Mฬโบโ[3])/lโ]


    # DNฬ (DNฬยนยน = DNฬยณยณ = -DNฬยนยณ = -DNฬยณยน)
    DNฬยนยน = Dโ*Nฬ

    #QGแต
    QGแตยนยน = Qยน*Gแตยน
    QGแตยนยฒ = Qยน*Gแตยฒ
    QGแตยนโด = Qยน*Gแตโด

    QGแตยฒยฒ = Qยฒ*Gแตยฒ
    QGแตยฒโด = Qยฒ*Gแตโด

    QGแตโดโด = Qโด*Gแตโด


    # EGa (diagonal)
    # Note: Rโ*Ga = 0 for ฮ indices because Rโ*Gแตฮ' has only non-zero values in the first column and a = [0 ...]
    EGaยน = Rโ*Gแตยน'*a

    # EGar (EGarยนยน = EGarยณยณ = -EGarยณยน = -EGarยนยณ)
    EGarยนยน = EGaยน*rยน

    # Kโ = DNฬ - EQGแตEแต + EGar
    Kโยนยน = DNฬยนยน - Rโ*QGแตยนยน*Rโ' + EGarยนยน
    Kโยนยฒ =      - Rโ*QGแตยนยฒ*Rโ'
    Kโยนโด =      - Rโ*QGแตยนโด*Rโ'
    
    Kโยฒยฒ =      - Rโ*QGแตยฒยฒ*Rโ'
    Kโยฒโด =      - Rโ*QGแตยฒโด*Rโ'

    Kโโดโด =      - Rโ*QGแตโดโด*Rโ'


    # Kฬ

    if exact

        ฮทโ, ฮผโ = compute_ฮท_ฮผ(ฮฬโ)
        ฮทโ, ฮผโ = compute_ฮท_ฮผ(ฮฬโ)

        Mฬโ = Tฬโฑโฟแตฮฬโ
        Mฬโ = Tฬโฑโฟแตฮฬโ

        Kฬโโ = compute_Kฬโ(ฮฬโ, Mฬโ, Tโโปยนฮฬโ, ฮทโ, ฮผโ)
        Kฬโโ = compute_Kฬโ(ฮฬโ, Mฬโ, Tโโปยนฮฬโ, ฮทโ, ฮผโ)

    end


    Kฬยนยน = exact ?  Bฬโบยนยน' * Kฬโโ * Bฬโบยนยน  +  Bฬโบยฒยน' * Kฬโโ * Bฬโบยฒยน  +  Kโยนยน   :   Kโยนยน 
    Kฬยนยฒ = exact ?  Bฬโบยนยน' * Kฬโโ * Bฬโบยนยฒ  +  Bฬโบยฒยน' * Kฬโโ * Bฬโบยฒยฒ  +  Kโยนยฒ   :   Kโยนยฒ 
    Kฬยนโด = exact ?  Bฬโบยนยน' * Kฬโโ * Bฬโบยนโด  +  Bฬโบยฒยน' * Kฬโโ * Bฬโบยฒโด  +  Kโยนโด   :   Kโยนโด 

    Kฬยฒยฒ = exact ?  Bฬโบยนยฒ' * Kฬโโ * Bฬโบยนยฒ  +  Bฬโบยฒยฒ' * Kฬโโ * Bฬโบยฒยฒ  +  Kโยฒยฒ   :   Kโยฒยฒ 
    Kฬยฒโด = exact ?  Bฬโบยนยฒ' * Kฬโโ * Bฬโบยนโด  +  Bฬโบยฒยฒ' * Kฬโโ * Bฬโบยฒโด  +  Kโยฒโด   :   Kโยฒโด 

    Kฬโดโด = exact ?  Bฬโบยนโด' * Kฬโโ * Bฬโบยนโด  +  Bฬโบยฒโด' * Kฬโโ * Bฬโบยฒโด  +  Kโโดโด   :   Kโโดโด 


    # BแตKโฑโฟแตB
    
    BแตKโฑโฟแตBยนยน = Bยน' * Kฬโฑโฟแตuฬ * Bยน      +      Bยนยน' * (Kฬโฑโฟแตฮฬ * Bยนยน  +  Kฬโฑโฟแตฮฬฮฬ * Bยฒยน)  +  Bยฒยน' * (Kฬโฑโฟแตฮฬฮฬ * Bยนยน  +  Kฬโฑโฟแตฮฬ * Bยฒยน)    
    BแตKโฑโฟแตBยนยฒ =                              Bยนยน' * (Kฬโฑโฟแตฮฬ * Bยนยฒ  +  Kฬโฑโฟแตฮฬฮฬ * Bยฒยฒ)  +  Bยฒยน' * (Kฬโฑโฟแตฮฬฮฬ * Bยนยฒ  +  Kฬโฑโฟแตฮฬ * Bยฒยฒ)     
    BแตKโฑโฟแตBยนโด =                              Bยนยน' * (Kฬโฑโฟแตฮฬ * Bยนโด  +  Kฬโฑโฟแตฮฬฮฬ * Bยฒโด)  +  Bยฒยน' * (Kฬโฑโฟแตฮฬฮฬ * Bยนโด  +  Kฬโฑโฟแตฮฬ * Bยฒโด)    
        
    BแตKโฑโฟแตBยฒยฒ =                              Bยนยฒ' * (Kฬโฑโฟแตฮฬ * Bยนยฒ  +  Kฬโฑโฟแตฮฬฮฬ * Bยฒยฒ)  +  Bยฒยฒ' * (Kฬโฑโฟแตฮฬฮฬ * Bยนยฒ  +  Kฬโฑโฟแตฮฬ * Bยฒยฒ)      
    BแตKโฑโฟแตBยฒโด =                              Bยนยฒ' * (Kฬโฑโฟแตฮฬ * Bยนโด  +  Kฬโฑโฟแตฮฬฮฬ * Bยฒโด)  +  Bยฒยฒ' * (Kฬโฑโฟแตฮฬฮฬ * Bยนโด  +  Kฬโฑโฟแตฮฬ * Bยฒโด)      
        
    BแตKโฑโฟแตBโดโด =                              Bยนโด' * (Kฬโฑโฟแตฮฬ * Bยนโด  +  Kฬโฑโฟแตฮฬฮฬ * Bยฒโด)  +  Bยฒโด' * (Kฬโฑโฟแตฮฬฮฬ * Bยนโด  +  Kฬโฑโฟแตฮฬ * Bยฒโด)    

    Kโฑโฟแตยนยน =  BแตKโฑโฟแตBยนยน   +    Kฬยนยน
    Kโฑโฟแตยนยฒ =  BแตKโฑโฟแตBยนยฒ   +    Kฬยนยฒ
    Kโฑโฟแตยนยณ =  -Kโฑโฟแตยนยน
    Kโฑโฟแตยนโด =  BแตKโฑโฟแตBยนโด   +    Kฬยนโด

    Kโฑโฟแตยฒยฒ =  BแตKโฑโฟแตBยฒยฒ   +    Kฬยฒยฒ
    Kโฑโฟแตยฒยณ =  -Kโฑโฟแตยนยฒ'
    Kโฑโฟแตยฒโด =  BแตKโฑโฟแตBยฒโด   +    Kฬยฒโด
    
    Kโฑโฟแตยณยณ =  Kโฑโฟแตยนยน
    Kโฑโฟแตยณโด =  -Kโฑโฟแตยนโด

    Kโฑโฟแตโดโด =  BแตKโฑโฟแตBโดโด   +    Kฬโดโด



    Kโฑโฟแต = hcat(vcat(Kโฑโฟแตยนยน, Kโฑโฟแตยนยฒ', Kโฑโฟแตยนยณ', Kโฑโฟแตยนโด'), vcat(Kโฑโฟแตยนยฒ, Kโฑโฟแตยฒยฒ, Kโฑโฟแตยฒยณ', Kโฑโฟแตยฒโด'), vcat(Kโฑโฟแตยนยณ, Kโฑโฟแตยฒยณ, Kโฑโฟแตยณยณ, Kโฑโฟแตยณโด'), vcat(Kโฑโฟแตยนโด, Kโฑโฟแตยฒโด, Kโฑโฟแตยณโด, Kโฑโฟแตโดโด))






    kinetic_energy = zero(T)

    Tแตยน = zeros(Vec3{T})
    Tแตยฒ = zeros(Vec3{T})
    Tแตยณ = zeros(Vec3{T})
    Tแตโด = zeros(Vec3{T})


    Mยนยน = zeros(Mat33{T})
    Mยนยฒ = zeros(Mat33{T})
    Mยนยณ = zeros(Mat33{T})
    Mยนโด = zeros(Mat33{T})
    Mยฒยน = zeros(Mat33{T})
    Mยฒยฒ = zeros(Mat33{T})
    Mยฒยณ = zeros(Mat33{T})
    Mยฒโด = zeros(Mat33{T})
    Mยณยน = zeros(Mat33{T})
    Mยณยฒ = zeros(Mat33{T})
    Mยณยณ = zeros(Mat33{T})
    Mยณโด = zeros(Mat33{T})
    Mโดยน = zeros(Mat33{T})
    Mโดยฒ = zeros(Mat33{T})
    Mโดยณ = zeros(Mat33{T})
    Mโดโด = zeros(Mat33{T})

    Cแตยนยน = zeros(Mat33{T})
    Cแตยนยฒ = zeros(Mat33{T})
    Cแตยนยณ = zeros(Mat33{T})
    Cแตยนโด = zeros(Mat33{T})
    Cแตยฒยน = zeros(Mat33{T})
    Cแตยฒยฒ = zeros(Mat33{T})
    Cแตยฒยณ = zeros(Mat33{T})
    Cแตยฒโด = zeros(Mat33{T})
    Cแตยณยน = zeros(Mat33{T})
    Cแตยณยฒ = zeros(Mat33{T})
    Cแตยณยณ = zeros(Mat33{T})
    Cแตยณโด = zeros(Mat33{T})
    Cแตโดยน = zeros(Mat33{T})
    Cแตโดยฒ = zeros(Mat33{T})
    Cแตโดยณ = zeros(Mat33{T})
    Cแตโดโด = zeros(Mat33{T})




    contact_energy = zero(T)
        

    Tแถยน = zeros(Vec3{T})
    Tแถยฒ = zeros(Vec3{T})
    Tแถยณ = zeros(Vec3{T})
    Tแถโด = zeros(Vec3{T})



    Kแถยนยน = zeros(Mat33{T})
    Kแถยนยฒ = zeros(Mat33{T})
    Kแถยนยณ = zeros(Mat33{T})
    Kแถยนโด = zeros(Mat33{T})
    Kแถยฒยน = zeros(Mat33{T})
    Kแถยฒยฒ = zeros(Mat33{T})
    Kแถยฒยณ = zeros(Mat33{T})
    Kแถยฒโด = zeros(Mat33{T})
    Kแถยณยน = zeros(Mat33{T})
    Kแถยณยฒ = zeros(Mat33{T})
    Kแถยณยณ = zeros(Mat33{T})
    Kแถยณโด = zeros(Mat33{T})
    Kแถโดยน = zeros(Mat33{T})
    Kแถโดยฒ = zeros(Mat33{T})
    Kแถโดยณ = zeros(Mat33{T})
    Kแถโดโด = zeros(Mat33{T})

    Cแถยนยน = zeros(Mat33{T})
    Cแถยนยฒ = zeros(Mat33{T})
    Cแถยนยณ = zeros(Mat33{T})
    Cแถยนโด = zeros(Mat33{T})
    Cแถยฒยน = zeros(Mat33{T})
    Cแถยฒยฒ = zeros(Mat33{T})
    Cแถยฒยณ = zeros(Mat33{T})
    Cแถยฒโด = zeros(Mat33{T})
    Cแถยณยน = zeros(Mat33{T})
    Cแถยณยฒ = zeros(Mat33{T})
    Cแถยณยณ = zeros(Mat33{T})
    Cแถยณโด = zeros(Mat33{T})
    Cแถโดยน = zeros(Mat33{T})
    Cแถโดยฒ = zeros(Mat33{T})
    Cแถโดยณ = zeros(Mat33{T})
    Cแถโดโด = zeros(Mat33{T})

        
    if isdynamic
        
        Uฬโ = Rโ' * uฬโ
        Uฬโ = Rโ' * uฬโ
        Wฬโ = Rโ' * wฬโ
        Wฬโ = Rโ' * wฬโ
        
        Uฬโ = Rโ' * uฬโ
        Uฬโ = Rโ' * uฬโ
        Wฬโ = Rโ' * wฬโ
        Wฬโ = Rโ' * wฬโ

        SUฬโ = skew(Uฬโ)
        SUฬโ = skew(Uฬโ)
        SWฬโ = skew(Wฬโ)
        SWฬโ = skew(Wฬโ)

        Wฬแต = Gแตยน * Uฬโ + Gแตยฒ * Wฬโ + Gแตยณ * Uฬโ + Gแตโด * Wฬโ
        SWฬแต = skew(Wฬแต)

        rdฬ = dot(rยน, uฬโ) + dot(rยณ, uฬโ)


        GแตยนRโแต = Gแตยน * Rโ'
        GแตยฒRโแต = Gแตยฒ * Rโ'
        GแตโดRโแต = Gแตโด * Rโ'

        RโGยน = Rโ * Gแตยน'
        RโGยฒ = Rโ * Gแตยฒ'
        RโGโด = Rโ * Gแตโด'


        # cycle among the Gauss positions
        for iG in 1:nG

            zแดณ = zG[iG]
            ฯแดณ = ฯG[iG]

            ฮพ = lโ*(zแดณ+1)/2

            # Shape functions
            Nโ = 1-ฮพ/lโ
            Nโ = 1-Nโ
            Nโ = ฮพ*(1-ฮพ/lโ)^2
            Nโ = -(1-ฮพ/lโ)*((ฮพ^2)/lโ)
            Nโ = (1-3*ฮพ/lโ)*(1-ฮพ/lโ)
            Nโ = (3*ฮพ/lโ-2)*(ฮพ/lโ)
            Nโ = Nโ+Nโ
            Nโ = Nโ+Nโ-1


            uแต = @SVector [0, Nโ*ฮฬโ[3] + Nโ*ฮฬโ[3], -Nโ*ฮฬโ[2] + -Nโ*ฮฬโ[2]]
            ฮฬ  = @SVector [Nโ*ฮฬโ[1] + Nโ*ฮฬโ[1], Nโ*ฮฬโ[2] + Nโ*ฮฬโ[2], Nโ*ฮฬโ[3] + Nโ*ฮฬโ[3]]

            Suแต = skew(uแต)
            Sฮฬ = skew(ฮฬ)

            Rฬ = ID3 + Sฮฬ

            Iฬแตจ = Rฬ*Jแตจ*Rฬ'

            Nโlโ = Nโ/lโ
            Nโlโยฒ = Nโlโ/lโ
            Nโlโ = Nโ/lโ
            Nโlโยฒ = Nโlโ/lโ

            PโPยน = @SMatrix [0 0 0; 0 Nโlโ 0;0 0 Nโlโ]
            PโPยฒ = @SMatrix [0 0 0; 0 0 Nโ;0 -Nโ 0]
            PโPยณ = -PโPยน
            PโPโด = @SMatrix [0 0 0; 0 0 Nโ;0 -Nโ 0]

            Hโยน = Nโ*ID3 + PโPยน - Suแต*Gแตยน
            Hโยฒ =          PโPยฒ - Suแต*Gแตยฒ
            Hโยณ = Nโ*ID3 + PโPยณ - Suแต*Gแตยณ
            Hโโด =          PโPโด - Suแต*Gแตโด

            Hโยน = @SMatrix [0 0 0; 0  0 -Nโlโ;0 Nโlโ 0]
            Hโยฒ = Diagonal(@SVector [Nโ, Nโ, Nโ])
            Hโยณ = -Hโยน
            Hโโด = Diagonal(@SVector [Nโ, Nโ, Nโ])


            uฬแต =  PโPยน * Uฬโ +  PโPยฒ * Wฬโ + PโPยณ * Uฬโ + PโPโด * Wฬโ

            Suฬแต = skew(uฬแต)
            
            Nโrdฬ = Nโlโยฒ * rdฬ
            Hฬโยน = Diagonal(@SVector [0, -Nโrdฬ, -Nโrdฬ]) - Suฬแต * Gแตยน
            Hฬโยฒ =                                      - Suฬแต * Gแตยฒ
            Hฬโโด =                                      - Suฬแต * Gแตโด

            Nโrdฬ = Nโlโยฒ * rdฬ
            Hฬโยน = @SMatrix [0 0 0; 0 0 Nโrdฬ; 0 -Nโrdฬ 0]

            hโ = Hโยน * Uฬโ + Hโยฒ * Wฬโ + Hโยณ * Uฬโ + Hโโด * Wฬโ
            hโ = Hโยน * Uฬโ + Hโยฒ * Wฬโ + Hโยณ * Uฬโ + Hโโด * Wฬโ
            Shโ = skew(hโ)
            Shโ = skew(hโ)

            Cโยน = SWฬแต * Hโยน + Hฬโยน - Hโยน * SWฬแต
            Cโยฒ = SWฬแต * Hโยฒ + Hฬโยฒ - Hโยฒ * SWฬแต
            Cโยณ = -Cโยน
            Cโโด = SWฬแต * Hโโด + Hฬโโด - Hโโด * SWฬแต

            Cโยน = SWฬแต * Hโยน + Hฬโยน - Hโยน * SWฬแต
            Cโยฒ = SWฬแต * Hโยฒ       - Hโยฒ * SWฬแต
            Cโยณ = -Cโยน
            Cโโด = SWฬแต * Hโโด       - Hโโด * SWฬแต

            HโFโ = Hโยน * SUฬโ + Hโยฒ * SWฬโ + Hโยณ * SUฬโ + Hโโด * SWฬโ
            HโFโ = Hโยน * SUฬโ + Hโยฒ * SWฬโ + Hโยณ * SUฬโ + Hโโด * SWฬโ

            AโDฬrEยน = @SMatrix [0 0 0; Uฬโ[2]-Uฬโ[2] 0 0; Uฬโ[3]-Uฬโ[3] 0 0]
            Cโยน = -Shโ*Gแตยน + Nโlโยฒ*AโDฬrEยน + SWฬแต*PโPยน + HโFโ*Gแตยน
            Cโยฒ = -Shโ*Gแตยฒ +                  SWฬแต*PโPยฒ + HโFโ*Gแตยฒ
            Cโโด = -Shโ*Gแตโด +                  SWฬแต*PโPโด + HโFโ*Gแตโด

            AโDฬrEยน = @SMatrix [0 0 0; -Uฬโ[3]+Uฬโ[3] 0 0; Uฬโ[2]-Uฬโ[2] 0 0]
            Cโยน = -Shโ*Gแตยน + Nโlโยฒ*AโDฬrEยน + HโFโ*Gแตยน
            Cโยฒ = -Shโ*Gแตยฒ                  + HโFโ*Gแตยฒ
            Cโโด = -Shโ*Gแตโด                  + HโFโ*Gแตโด

            uฬโ = Rโ * hโ

            HโEแตdฬ = Hโยน * Uฬโ + Hโยฒ * Wฬโ + Hโยณ * Uฬโ + Hโโด * Wฬโ
            CโEแตdฬ = Cโยน * Uฬโ + Cโยฒ * Wฬโ + Cโยณ * Uฬโ + Cโโด * Wฬโ
            Rโแตuฬโ = HโEแตdฬ + CโEแตdฬ

            Wฬโ = hโ
            wฬโ = Rโ * Wฬโ

            HโEแตdฬ = Hโยน * Uฬโ + Hโยฒ * Wฬโ + Hโยณ * Uฬโ + Hโโด * Wฬโ
            CโEแตdฬ = Cโยน * Uฬโ + Cโยฒ * Wฬโ + Cโยณ * Uฬโ + Cโโด * Wฬโ
            Rโแตwฬโ = HโEแตdฬ + CโEแตdฬ

            SWฬโ = skew(Wฬโ)
            IฬแตจRโแตwฬโ = Iฬแตจ*Rโแตwฬโ
            SWฬโIฬแตจ = SWฬโ*Iฬแตจ
            SWฬโIฬแตจWฬโ = SWฬโIฬแตจ*Wฬโ
            IฬแตจRโแตwฬโSWฬโIฬแตจWฬโ = IฬแตจRโแตwฬโ + SWฬโIฬแตจWฬโ
            AแตจHโยนแต = Aแตจ*Hโยน'
            AแตจHโยฒแต = Aแตจ*Hโยฒ'
            AแตจHโยณแต = Aแตจ*Hโยณ'
            AแตจHโโดแต = Aแตจ*Hโโด'

            TแตยนG = ฯแดณ * (AแตจHโยนแต*Rโแตuฬโ + Hโยน'*IฬแตจRโแตwฬโSWฬโIฬแตจWฬโ)
            Tแตยน += TแตยนG
            Tแตยฒ += ฯแดณ * (AแตจHโยฒแต*Rโแตuฬโ + Hโยฒ'*IฬแตจRโแตwฬโSWฬโIฬแตจWฬโ)
            Tแตยณ += -TแตยนG + ฯแดณ * Aแตจ * Rโแตuฬโ
            Tแตโด += ฯแดณ * (AแตจHโโดแต*Rโแตuฬโ + Hโโด'*IฬแตจRโแตwฬโSWฬโIฬแตจWฬโ)


            if damping>0
                TแตยนG = ฯแดณ * damping*(AแตจHโยนแต*hโ + Hโยน'*Iฬแตจ*hโ)
                Tแตยน += TแตยนG
                Tแตยฒ += ฯแดณ * damping*(AแตจHโยฒแต*hโ + Hโยฒ'*Iฬแตจ*hโ)
                Tแตยณ += -TแตยนG + ฯแดณ * Aแตจ * damping * hโ
                Tแตโด += ฯแดณ * damping*(AแตจHโโดแต*hโ + Hโโด'*Iฬแตจ*hโ)
            end


            MยนยนG = ฯแดณ * (AแตจHโยนแต*Hโยน + Hโยน'*Iฬแตจ*Hโยน)
            MยนยฒG = ฯแดณ * (AแตจHโยนแต*Hโยฒ + Hโยน'*Iฬแตจ*Hโยฒ)
            MยนโดG = ฯแดณ * (AแตจHโยนแต*Hโโด + Hโยน'*Iฬแตจ*Hโโด)

            MยฒยฒG = ฯแดณ * (AแตจHโยฒแต*Hโยฒ + Hโยฒ'*Iฬแตจ*Hโยฒ)
            MยฒโดG = ฯแดณ * (AแตจHโยฒแต*Hโโด + Hโยฒ'*Iฬแตจ*Hโโด)
            
            MโดโดG = ฯแดณ * (AแตจHโโดแต*Hโโด + Hโโด'*Iฬแตจ*Hโโด)


            Mยนยน += MยนยนG
            Mยนยฒ += MยนยฒG
            Mยนยณ += -MยนยนG + ฯแดณ * AแตจHโยนแต
            Mยนโด += MยนโดG

            Mยฒยฒ += MยฒยฒG
            Mยฒยณ += -MยนยฒG' + ฯแดณ * AแตจHโยฒแต
            Mยฒโด += MยฒโดG

            Mยณยณ += MยนยนG + ฯแดณ * Aแตจ * (ID3 - Hโยน - Hโยน')
            Mยณโด += -MยนโดG + ฯแดณ * Aแตจ*Hโโด
            
            Mโดโด += MโดโดG


            SWฬโIฬแตจmSIฬแตจWฬโ = SWฬโIฬแตจ - skew(Iฬแตจ*Wฬโ)

            AแตจCโยนCโยน = Aแตจ*(Cโยน + Cโยน)
            AแตจCโยนCโยฒ = Aแตจ*(Cโยฒ + Cโยฒ)
            AแตจCโยนCโโด = Aแตจ*(Cโโด + Cโโด)

            IฬแตจCโยนCโยนSWฬโIฬแตจmSIฬแตจWฬโHโยน = Iฬแตจ*(Cโยน + Cโยน) + SWฬโIฬแตจmSIฬแตจWฬโ * Hโยน
            IฬแตจCโยฒCโยนSWฬโIฬแตจmSIฬแตจWฬโHโยฒ = Iฬแตจ*(Cโยฒ + Cโยฒ) + SWฬโIฬแตจmSIฬแตจWฬโ * Hโยฒ
            IฬแตจCโโดCโยนSWฬโIฬแตจmSIฬแตจWฬโHโโด = Iฬแตจ*(Cโโด + Cโโด) + SWฬโIฬแตจmSIฬแตจWฬโ * Hโโด


            CแตยนยนG = ฯแดณ * ( Hโยน'*AแตจCโยนCโยน + Hโยน'* IฬแตจCโยนCโยนSWฬโIฬแตจmSIฬแตจWฬโHโยน ) 
            CแตยนยฒG = ฯแดณ * ( Hโยน'*AแตจCโยนCโยฒ + Hโยน'* IฬแตจCโยฒCโยนSWฬโIฬแตจmSIฬแตจWฬโHโยฒ ) 
            CแตยนโดG = ฯแดณ * ( Hโยน'*AแตจCโยนCโโด + Hโยน'* IฬแตจCโโดCโยนSWฬโIฬแตจmSIฬแตจWฬโHโโด ) 
 
            CแตยฒยนG = ฯแดณ * ( Hโยฒ'*AแตจCโยนCโยน + Hโยฒ'* IฬแตจCโยนCโยนSWฬโIฬแตจmSIฬแตจWฬโHโยน ) 
            CแตยฒยฒG = ฯแดณ * ( Hโยฒ'*AแตจCโยนCโยฒ + Hโยฒ'* IฬแตจCโยฒCโยนSWฬโIฬแตจmSIฬแตจWฬโHโยฒ ) 
            CแตยฒโดG = ฯแดณ * ( Hโยฒ'*AแตจCโยนCโโด + Hโยฒ'* IฬแตจCโโดCโยนSWฬโIฬแตจmSIฬแตจWฬโHโโด ) 
 
            CแตโดยนG = ฯแดณ * ( Hโโด'*AแตจCโยนCโยน + Hโโด'* IฬแตจCโยนCโยนSWฬโIฬแตจmSIฬแตจWฬโHโยน ) 
            CแตโดยฒG = ฯแดณ * ( Hโโด'*AแตจCโยนCโยฒ + Hโโด'* IฬแตจCโยฒCโยนSWฬโIฬแตจmSIฬแตจWฬโHโยฒ ) 
            CแตโดโดG = ฯแดณ * ( Hโโด'*AแตจCโยนCโโด + Hโโด'* IฬแตจCโโดCโยนSWฬโIฬแตจmSIฬแตจWฬโHโโด ) 


            Cแตยนยน += CแตยนยนG
            Cแตยนยฒ += CแตยนยฒG
            Cแตยนโด += CแตยนโดG

            Cแตยฒยน += CแตยฒยนG
            Cแตยฒยฒ += CแตยฒยฒG
            Cแตยฒโด += CแตยฒโดG

            Cแตยณยน += -CแตยนยนG + ฯแดณ * AแตจCโยนCโยน
            Cแตยณยฒ += -CแตยนยฒG + ฯแดณ * AแตจCโยนCโยฒ
            Cแตยณโด += -CแตยนโดG + ฯแดณ * AแตจCโยนCโโด

            Cแตโดยน += CแตโดยนG
            Cแตโดยฒ += CแตโดยฒG
            Cแตโดโด += CแตโดโดG
            
            # kinetic energy
            Iฬแตจแต = Rโ*Iฬแตจ*Rโ'
            kinetic_energy += ฯแดณ/2 * (Aแตจ*uฬโ'*uฬโ + wฬโ'*Iฬแตจแต*wฬโ)

            if contactsearch

                xแดณ = Nโ*xโ + Nโ*xโ + Rโ*uแต
                gausspoints.pos[(iB-1)*3 + iG] = xแดณ

                gฬโ = sdf.r/4
            
                if incontact(xแดณ, sdf, gฬโ)

                    gโ, โgโโx, โยฒgโโxยฒ = contact_gap(xแดณ, sdf)

                    @unpack kโ, ฮทโ, ฮผ, ฮตแต, kโ, ฮทโ, uฬโ = contactparams
                    ฮผstick = 1E2

                    pโ, pโฒโ, ฮโ = regularize_gโ(gโ, gฬโ)
                    ฮทโ, ฮทโฒโ = smoothstep(ฮทโ, gโ, gฬโ)

                    uฬโ_mag = dot(uฬโ, โgโโx)
                    uฬโ = uฬโ_mag*โgโโx
                    uฬโ = uฬโ - uฬโ
                    uฬโยฒ = dot(uฬโ, uฬโ)
        
                    contact_energy += ฯแดณ*kโ*ฮโ
                    
                    ๐ฏโฟ = kโ * pโ * โgโโx - ฮทโ * uฬโ

                    ฮดโ =  gausspoints.ฮดโ[(iB-1)*3 + iG]
                    ฮดโ = ฮดโ + ฮt*norm(uฬโ)

                    ฮผสณแตแต = ฮผ/sqrt(uฬโยฒ+ฮตแต)
                    
                    if  norm(uฬโ) <= uฬโ
                        # if  gausspoints.status[(iB-1)*3 + iG] == 1
                        #     ฮดโ = ฮผสณแตแต*pโ/kโ - ฮทโ/kโ*sqrt(uฬโยฒ+ฮตแต)
                        # end 
                        gausspoints.status[(iB-1)*3 + iG] = 2
                        # break
                    elseif norm(uฬโ) > uฬโ
                        gausspoints.status[(iB-1)*3 + iG] = 1
                        # break
                    end
                    # elseif gausspoints.status[(iB-1)*3 + iG] == 1 && norm(uฬโ) <= uฬโ

                    #     gausspoints.status[(iB-1)*3 + iG] = 2
                    #     # ฮดโ = ฮผสณแตแต*pโ/kโ - ฮทโ/kโ*sqrt(uฬโยฒ+ฮตแต)
                    #     break
                        
                    # elseif gausspoints.status[(iB-1)*3 + iG] == 2
                        
                    #     ๐ฏแต = - kโ * ฮดโ * uฬโ/sqrt(uฬโยฒ+ฮตแต) - ฮทโ*uฬโ

                    #     if norm(๐ฏแต) > ฮผstick*pโ && norm(uฬโ) > uฬโ
                    #         gausspoints.status[(iB-1)*3 + iG] = 1
                    #     end 
                    #     break

                    # end
                    gausspoints.ฮดโ[(iB-1)*3 + iG] =  ฮดโ

                    ๐ฏแต = zeros(Vec3)
                    if gausspoints.status[(iB-1)*3 + iG] == 1
                        ๐ฏแต = - kโ * pโ * ฮผสณแตแต * uฬโ   
                    elseif gausspoints.status[(iB-1)*3 + iG] == 2
                        ๐ฏแต = - kโ * ฮดโ * uฬโ/sqrt(uฬโยฒ+ฮตแต) - ฮทโ*uฬโ
                    end

              
                    ๐ฏแถ = ๐ฏโฟ + ๐ฏแต

                    ๐แถ = Rโ' * ๐ฏแถ

                    RโHโยนRโแต = Rโ * Hโยน * Rโ'
                    RโHโยฒRโแต = Rโ * Hโยฒ * Rโ'
                    RโHโยณRโแต = Rโ * Hโยณ * Rโ'
                    RโHโโดRโแต = Rโ * Hโโด * Rโ'
        
                    Tแถยน += ฯแดณ * (RโHโยนRโแต' * ๐ฏแถ)
                    Tแถยฒ += ฯแดณ * (RโHโยฒRโแต' * ๐ฏแถ)
                    Tแถยณ += ฯแดณ * (RโHโยณRโแต' * ๐ฏแถ)
                    Tแถโด += ฯแดณ * (RโHโโดRโแต' * ๐ฏแถ)

        
                    SฬHโแต๐แถยน = skew(Hโยน' * ๐แถ)
                    SฬHโแต๐แถยฒ = skew(Hโยฒ' * ๐แถ)
                    SฬHโแต๐แถยณ = skew(Hโยณ' * ๐แถ)
                    SฬHโแต๐แถโด = skew(Hโโด' * ๐แถ)
        
                    RโSฬHโแต๐แถยน = Rโ * SฬHโแต๐แถยน
                    tโยนยน = -RโSฬHโแต๐แถยน * GแตยนRโแต
                    tโยนยฒ = -RโSฬHโแต๐แถยน * GแตยฒRโแต
                    tโยนยณ = -tโยนยน
                    tโยนโด = -RโSฬHโแต๐แถยน * GแตโดRโแต
        
                    RโSฬHโแต๐แถยฒ = Rโ * SฬHโแต๐แถยฒ
                    tโยฒยน = -RโSฬHโแต๐แถยฒ * GแตยนRโแต
                    tโยฒยฒ = -RโSฬHโแต๐แถยฒ * GแตยฒRโแต
                    tโยฒยณ = -tโยฒยน
                    tโยฒโด = -RโSฬHโแต๐แถยฒ * GแตโดRโแต
        
                    RโSฬHโแต๐แถยณ = Rโ * SฬHโแต๐แถยณ
                    tโยณยน = -RโSฬHโแต๐แถยณ * GแตยนRโแต
                    tโยณยฒ = -RโSฬHโแต๐แถยณ * GแตยฒRโแต
                    tโยณยณ = -tโยณยน
                    tโยณโด = -RโSฬHโแต๐แถยณ * GแตโดRโแต
        
                    RโSฬHโแต๐แถโด = Rโ * SฬHโแต๐แถโด
                    tโโดยน = -RโSฬHโแต๐แถโด * GแตยนRโแต
                    tโโดยฒ = -RโSฬHโแต๐แถโด * GแตยฒRโแต
                    tโโดยณ = -tโโดยน
                    tโโดโด = -RโSฬHโแต๐แถโด * GแตโดRโแต
        
        
                    vโ = rยณ
                    Aโแต๐แถrโโ = @SMatrix[0 0 0; ๐แถ[2]*vโ[1] ๐แถ[2]*vโ[2] ๐แถ[2]*vโ[3]; ๐แถ[3]*vโ[1] ๐แถ[3]*vโ[2] ๐แถ[3]*vโ[3]]
        
                    S๐แถ = skew(๐แถ)
        
                    S๐แถPโPยนRโแต = S๐แถ * PโPยน * Rโ'
                    S๐แถPโPยฒRโแต = S๐แถ * PโPยฒ * Rโ'
                    S๐แถPโPโดRโแต = S๐แถ * PโPโด * Rโ'
                    
                    tโยนยน = Nโlโยฒ * Rโ * Aโแต๐แถrโโ - RโGยน * S๐แถPโPยนRโแต
                    tโยนยฒ =                       - RโGยน * S๐แถPโPยฒRโแต
                    tโยนยณ = -tโยนยน
                    tโยนโด =                       - RโGยน * S๐แถPโPโดRโแต
        
                    tโยฒยน =                       - RโGยฒ * S๐แถPโPยนRโแต
                    tโยฒยฒ =                       - RโGยฒ * S๐แถPโPยฒRโแต
                    tโยฒยณ = -tโยฒยน
                    tโยฒโด =                       - RโGยฒ * S๐แถPโPโดRโแต
        
                    tโยณยน = tโยนยณ
                    tโยณยฒ = -tโยนยฒ
                    tโยณยณ = tโยนยน
                    tโยณโด = -tโยนโด
        
                    tโโดยน =                       - RโGโด * S๐แถPโPยนRโแต
                    tโโดยฒ =                       - RโGโด * S๐แถPโPยฒRโแต
                    tโโดยณ = -tโโดยน
                    tโโดโด =                       - RโGโด * S๐แถPโPโดRโแต
        
                    RโHโแตยนS๐แถ = Rโ * Hโยน' * S๐แถ
                    RโHโแตยฒS๐แถ = Rโ * Hโยฒ' * S๐แถ
                    RโHโแตยณS๐แถ = Rโ * Hโยณ' * S๐แถ
                    RโHโแตโดS๐แถ = Rโ * Hโโด' * S๐แถ
        
                    tโยนยน = RโHโแตยนS๐แถ * GแตยนRโแต
                    tโยนยฒ = RโHโแตยนS๐แถ * GแตยฒRโแต
                    tโยนยณ = -tโยนยน
                    tโยนโด = RโHโแตยนS๐แถ * GแตโดRโแต
        
                    tโยฒยน = RโHโแตยฒS๐แถ * GแตยนRโแต
                    tโยฒยฒ = RโHโแตยฒS๐แถ * GแตยฒRโแต
                    tโยฒยณ = -tโยฒยน
                    tโยฒโด = RโHโแตยฒS๐แถ * GแตโดRโแต
        
                    tโยณยน = RโHโแตยณS๐แถ * GแตยนRโแต
                    tโยณยฒ = RโHโแตยณS๐แถ * GแตยฒRโแต
                    tโยณยณ = -tโยณยน
                    tโยณโด = RโHโแตยณS๐แถ * GแตโดRโแต
        
                    tโโดยน = RโHโแตโดS๐แถ * GแตยนRโแต
                    tโโดยฒ = RโHโแตโดS๐แถ * GแตยฒRโแต
                    tโโดยณ = -tโโดยน
                    tโโดโด = RโHโแตโดS๐แถ * GแตโดRโแต

        
                    aux = dot(โgโโx, uฬโ) * โยฒgโโxยฒ + โgโโx * (โยฒgโโxยฒ * uฬโ)'
        
                    ๐โยน =  aux * RโHโยนRโแต
                    ๐โยฒ =  aux * RโHโยฒRโแต
                    ๐โยณ =  aux * RโHโยณRโแต
                    ๐โโด =  aux * RโHโโดRโแต

        

                    RโShโ = Rโ * Shโ
                    ๐โยน = - RโShโ * GแตยนRโแต
                    ๐โยฒ = - RโShโ * GแตยฒRโแต
                    ๐โโด = - RโShโ * GแตโดRโแต

                    AโDฬrยน = @SMatrix [0 0 0; vโ[1]*(Uฬโ[2]-Uฬโ[2]) vโ[2]*(Uฬโ[2]-Uฬโ[2]) vโ[3]*(Uฬโ[2]-Uฬโ[2]);vโ[1]*(Uฬโ[3]-Uฬโ[3]) vโ[2]*(Uฬโ[3]-Uฬโ[3]) vโ[3]*(Uฬโ[3]-Uฬโ[3])]
        
                    RโSGแตDฬ = Rโ * skew(Gแตยน * Uฬโ + Gแตยฒ * Wฬโ + Gแตยณ * Uฬโ + Gแตโด * Wฬโ)
                    ๐โยน = Nโlโยฒ * Rโ * AโDฬrยน + RโSGแตDฬ * PโPยน * Rโ'
                    ๐โยฒ =                      RโSGแตDฬ * PโPยฒ * Rโ'
                    ๐โโด =                      RโSGแตDฬ * PโPโด * Rโ'
        
                    RโHโSDฬ = Rโ*HโFโ
                    ๐โยน = RโHโSDฬ * GแตยนRโแต
                    ๐โยฒ = RโHโSDฬ * GแตยฒRโแต
                    ๐โโด = RโHโSDฬ * GแตโดRโแต
        
                    โuฬโโdยน = ๐โยน + ๐โยน + ๐โยน
                    โuฬโโdยฒ = ๐โยฒ + ๐โยฒ + ๐โยฒ
                    โuฬโโdยณ = -โuฬโโdยน
                    โuฬโโdโด = ๐โโด + ๐โโด + ๐โโด


                    nn = โgโโx*โgโโx'
        
                    โuฬโโdยน = ๐โยน + nn * โuฬโโdยน
                    โuฬโโdยฒ = ๐โยฒ + nn * โuฬโโdยฒ
                    โuฬโโdยณ = ๐โยณ + nn * โuฬโโdยณ
                    โuฬโโdโด = ๐โโด + nn * โuฬโโdโด

                    # uฬโ = uฬโ - uฬโ
                    โuฬโโdยน = โuฬโโdยน - โuฬโโdยน
                    โuฬโโdยฒ = โuฬโโdยฒ - โuฬโโdยฒ
                    โuฬโโdยณ = โuฬโโdยณ - โuฬโโdยณ
                    โuฬโโdโด = โuฬโโdโด - โuฬโโdโด


                    โuฬโโdฬยน = nn * RโHโยนRโแต
                    โuฬโโdฬยฒ = nn * RโHโยฒRโแต
                    โuฬโโdฬยณ = nn * RโHโยณRโแต
                    โuฬโโdฬโด = nn * RโHโโดRโแต

                    โuฬโโdฬยน = RโHโยนRโแต
                    โuฬโโdฬยฒ = RโHโยฒRโแต
                    โuฬโโdฬยณ = RโHโยณRโแต
                    โuฬโโdฬโด = RโHโโดRโแต


                    # uฬโ = uฬโ - uฬโ
                    โuฬโโdฬยน = โuฬโโdฬยน - โuฬโโdฬยน
                    โuฬโโdฬยฒ = โuฬโโdฬยฒ - โuฬโโdฬยฒ
                    โuฬโโdฬยณ = โuฬโโdฬยณ - โuฬโโdฬยณ
                    โuฬโโdฬโด = โuฬโโdฬโด - โuฬโโdฬโด


                    aux = kโ*pโฒโ*nn + kโ*pโ*โยฒgโโxยฒ - ฮทโฒโ*uฬโ*โgโโx'
                    Kแถโฟยน = aux * RโHโยนRโแต - ฮทโ*โuฬโโdยน
                    Kแถโฟยฒ = aux * RโHโยฒRโแต - ฮทโ*โuฬโโdยฒ
                    Kแถโฟยณ = aux * RโHโยณRโแต - ฮทโ*โuฬโโdยณ
                    Kแถโฟโด = aux * RโHโโดRโแต - ฮทโ*โuฬโโdโด

                    Cแถโฟยน = - ฮทโ * nn * โuฬโโdฬยน
                    Cแถโฟยฒ = - ฮทโ * nn * โuฬโโdฬยฒ
                    Cแถโฟยณ = - ฮทโ * nn * โuฬโโdฬยณ
                    Cแถโฟโด = - ฮทโ * nn * โuฬโโdฬโด


                    Kแถแตยน = zeros(Mat33)
                    Kแถแตยฒ = zeros(Mat33)
                    Kแถแตยณ = zeros(Mat33)
                    Kแถแตโด = zeros(Mat33)

                    Cแถแตยน = zeros(Mat33)
                    Cแถแตยฒ = zeros(Mat33)
                    Cแถแตยณ = zeros(Mat33)
                    Cแถแตโด = zeros(Mat33)

                    if gausspoints.status[(iB-1)*3 + iG] == 1


                        aux1 = - ฮผสณแตแต * kโ * pโฒโ * uฬโ * โgโโx'
                        aux2 = - ฮผสณแตแต * kโ * pโ*(ID3 - 1/(uฬโยฒ+ฮตแต)*uฬโ*uฬโ')
                        Kแถแตยน = aux1 * RโHโยนRโแต + aux2 * โuฬโโdยน
                        Kแถแตยฒ = aux1 * RโHโยฒRโแต + aux2 * โuฬโโdยฒ
                        Kแถแตยณ = aux1 * RโHโยณRโแต + aux2 * โuฬโโdยณ
                        Kแถแตโด = aux1 * RโHโโดRโแต + aux2 * โuฬโโdโด

                        Cแถแตยน = aux2 * โuฬโโdฬยน
                        Cแถแตยฒ = aux2 * โuฬโโdฬยฒ
                        Cแถแตยณ = aux2 * โuฬโโdฬยณ
                        Cแถแตโด = aux2 * โuฬโโdฬโด

                    elseif gausspoints.status[(iB-1)*3 + iG] == 2

                        aux = - kโ * ฮดโ/sqrt(uฬโยฒ+ฮตแต) * (ID3 - 1/(uฬโยฒ+ฮตแต)*uฬโ*uฬโ' + ฮทโ*ID3)
                        Kแถแตยน = aux * โuฬโโdยน
                        Kแถแตยฒ = aux * โuฬโโdยฒ
                        Kแถแตยณ = aux * โuฬโโdยณ
                        Kแถแตโด = aux * โuฬโโdโด
    
                        Cแถแตยน = aux * โuฬโโdฬยน
                        Cแถแตยฒ = aux * โuฬโโdฬยฒ
                        Cแถแตยณ = aux * โuฬโโdฬยณ
                        Cแถแตโด = aux * โuฬโโdฬโด

                    end 

                    Kแถแถยน = Kแถโฟยน + Kแถแตยน
                    Kแถแถยฒ = Kแถโฟยฒ + Kแถแตยฒ
                    Kแถแถยณ = Kแถโฟยณ + Kแถแตยณ
                    Kแถแถโด = Kแถโฟโด + Kแถแตโด


                    tโยนยน = RโHโยนRโแต' * Kแถแถยน
                    tโยนยฒ = RโHโยนRโแต' * Kแถแถยฒ
                    tโยนยณ = RโHโยนRโแต' * Kแถแถยณ
                    tโยนโด = RโHโยนRโแต' * Kแถแถโด
        
                    tโยฒยน = RโHโยฒRโแต' * Kแถแถยน
                    tโยฒยฒ = RโHโยฒRโแต' * Kแถแถยฒ
                    tโยฒยณ = RโHโยฒRโแต' * Kแถแถยณ
                    tโยฒโด = RโHโยฒRโแต' * Kแถแถโด
        
                    tโยณยน = RโHโยณRโแต' * Kแถแถยน
                    tโยณยฒ = RโHโยณRโแต' * Kแถแถยฒ
                    tโยณยณ = RโHโยณRโแต' * Kแถแถยณ
                    tโยณโด = RโHโยณRโแต' * Kแถแถโด
        
                    tโโดยน = RโHโโดRโแต' * Kแถแถยน
                    tโโดยฒ = RโHโโดRโแต' * Kแถแถยฒ
                    tโโดยณ = RโHโโดRโแต' * Kแถแถยณ
                    tโโดโด = RโHโโดRโแต' * Kแถแถโด
        
        
                    Cแถแถยน = Cแถโฟยน + Cแถแตยน
                    Cแถแถยฒ = Cแถโฟยฒ + Cแถแตยฒ
                    Cแถแถยณ = Cแถโฟยณ + Cแถแตยณ
                    Cแถแถโด = Cแถโฟโด + Cแถแตโด
        
        
                    Kแถยนยน +=  ฯแดณ * (tโยนยน + tโยนยน + tโยนยน + tโยนยน)
                    Kแถยนยฒ +=  ฯแดณ * (tโยนยฒ + tโยนยฒ + tโยนยฒ + tโยนยฒ)
                    Kแถยนยณ +=  ฯแดณ * (tโยนยณ + tโยนยณ + tโยนยณ + tโยนยณ)
                    Kแถยนโด +=  ฯแดณ * (tโยนโด + tโยนโด + tโยนโด + tโยนโด)
        
                    Kแถยฒยน +=  ฯแดณ * (tโยฒยน + tโยฒยน + tโยฒยน + tโยฒยน)
                    Kแถยฒยฒ +=  ฯแดณ * (tโยฒยฒ + tโยฒยฒ + tโยฒยฒ + tโยฒยฒ)
                    Kแถยฒยณ +=  ฯแดณ * (tโยฒยณ + tโยฒยณ + tโยฒยณ + tโยฒยณ)
                    Kแถยฒโด +=  ฯแดณ * (tโยฒโด + tโยฒโด + tโยฒโด + tโยฒโด)
        
                    Kแถยณยน +=  ฯแดณ * (tโยณยน + tโยณยน + tโยณยน + tโยณยน)
                    Kแถยณยฒ +=  ฯแดณ * (tโยณยฒ + tโยณยฒ + tโยณยฒ + tโยณยฒ)
                    Kแถยณยณ +=  ฯแดณ * (tโยณยณ + tโยณยณ + tโยณยณ + tโยณยณ)
                    Kแถยณโด +=  ฯแดณ * (tโยณโด + tโยณโด + tโยณโด + tโยณโด)
        
                    Kแถโดยน +=  ฯแดณ * (tโโดยน + tโโดยน + tโโดยน + tโโดยน)
                    Kแถโดยฒ +=  ฯแดณ * (tโโดยฒ + tโโดยฒ + tโโดยฒ + tโโดยฒ)
                    Kแถโดยณ +=  ฯแดณ * (tโโดยณ + tโโดยณ + tโโดยณ + tโโดยณ)
                    Kแถโดโด +=  ฯแดณ * (tโโดโด + tโโดโด + tโโดโด + tโโดโด)
        
        
                    Cแถยนยน +=  ฯแดณ * RโHโยนRโแต' * Cแถแถยน
                    Cแถยนยฒ +=  ฯแดณ * RโHโยนRโแต' * Cแถแถยฒ
                    Cแถยนยณ +=  ฯแดณ * RโHโยนRโแต' * Cแถแถยณ
                    Cแถยนโด +=  ฯแดณ * RโHโยนRโแต' * Cแถแถโด
        
                    Cแถยฒยน +=  ฯแดณ * RโHโยฒRโแต' * Cแถแถยน
                    Cแถยฒยฒ +=  ฯแดณ * RโHโยฒRโแต' * Cแถแถยฒ
                    Cแถยฒยณ +=  ฯแดณ * RโHโยฒRโแต' * Cแถแถยณ
                    Cแถยฒโด +=  ฯแดณ * RโHโยฒRโแต' * Cแถแถโด
        
                    Cแถยณยน +=  ฯแดณ * RโHโยณRโแต' * Cแถแถยน
                    Cแถยณยฒ +=  ฯแดณ * RโHโยณRโแต' * Cแถแถยฒ
                    Cแถยณยณ +=  ฯแดณ * RโHโยณRโแต' * Cแถแถยณ
                    Cแถยณโด +=  ฯแดณ * RโHโยณRโแต' * Cแถแถโด
        
                    Cแถโดยน +=  ฯแดณ * RโHโโดRโแต' * Cแถแถยน
                    Cแถโดยฒ +=  ฯแดณ * RโHโโดRโแต' * Cแถแถยฒ
                    Cแถโดยณ +=  ฯแดณ * RโHโโดRโแต' * Cแถแถยณ
                    Cแถโดโด +=  ฯแดณ * RโHโโดRโแต' * Cแถแถโด
                
                
                else
                    gausspoints.ฮดโ[(iB-1)*3 + iG] = 0 
                    gausspoints.status[(iB-1)*3 + iG] = 0 
                end


            end


            
        end

        lโ2 = lโ/2
        lโ2Rโ = lโ2 * Rโ


        Tแตยน = lโ2Rโ*Tแตยน
        Tแตยฒ = lโ2Rโ*Tแตยฒ
        Tแตยณ = lโ2Rโ*Tแตยณ
        Tแตโด = lโ2Rโ*Tแตโด



        Mยนยน = lโ2Rโ * Mยนยน * Rโ'
        Mยนยฒ = lโ2Rโ * Mยนยฒ * Rโ'
        Mยนยณ = lโ2Rโ * Mยนยณ * Rโ'
        Mยนโด = lโ2Rโ * Mยนโด * Rโ'
        Mยฒยฒ = lโ2Rโ * Mยฒยฒ * Rโ'
        Mยฒยณ = lโ2Rโ * Mยฒยณ * Rโ'
        Mยฒโด = lโ2Rโ * Mยฒโด * Rโ'
        Mยณยณ = lโ2Rโ * Mยณยณ * Rโ'
        Mยณโด = lโ2Rโ * Mยณโด * Rโ'
        Mโดโด = lโ2Rโ * Mโดโด * Rโ'

        Cแตยนยน = lโ2Rโ * Cแตยนยน * Rโ' 
        Cแตยนยฒ = lโ2Rโ * Cแตยนยฒ * Rโ' 
        Cแตยนยณ = -Cแตยนยน             
        Cแตยนโด = lโ2Rโ * Cแตยนโด * Rโ' 
        Cแตยฒยน = lโ2Rโ * Cแตยฒยน * Rโ' 
        Cแตยฒยฒ = lโ2Rโ * Cแตยฒยฒ * Rโ' 
        Cแตยฒยณ = -Cแตยฒยน            
        Cแตยฒโด = lโ2Rโ * Cแตยฒโด * Rโ' 
        Cแตยณยน = lโ2Rโ * Cแตยณยน * Rโ'
        Cแตยณยฒ = lโ2Rโ * Cแตยณยฒ * Rโ' 
        Cแตยณยณ = -Cแตยณยน              
        Cแตยณโด = lโ2Rโ * Cแตยณโด * Rโ' 
        Cแตโดยน = lโ2Rโ * Cแตโดยน * Rโ' 
        Cแตโดยฒ = lโ2Rโ * Cแตโดยฒ * Rโ' 
        Cแตโดยณ = -Cแตโดยน
        Cแตโดโด = lโ2Rโ * Cแตโดโด * Rโ' 



        kinetic_energy = lโ2*kinetic_energy

        if damping>0
            Cแตยนยน += damping*Mยนยน
            Cแตยนยฒ += damping*Mยนยฒ
            Cแตยนยณ += damping*Mยนยณ
            Cแตยนโด += damping*Mยนโด
            Cแตยฒยน += damping*Mยนยฒ'
            Cแตยฒยฒ += damping*Mยฒยฒ
            Cแตยฒยณ += damping*Mยฒยณ
            Cแตยฒโด += damping*Mยฒโด
            Cแตยณยน += damping*Mยนยณ'
            Cแตยณยฒ += damping*Mยฒยณ'
            Cแตยณยณ += damping*Mยณยณ
            Cแตยณโด += damping*Mยณโด
            Cแตโดยน += damping*Mยนโด'
            Cแตโดยฒ += damping*Mยฒโด'
            Cแตโดยณ += damping*Mยณโด'
            Cแตโดโด += damping*Mโดโด
        end



        if exact
            
            ฮโ = toangle(ฮRโ)
            ฮโ = toangle(ฮRโ)
            
            Tโโปยนฮโ = Tโโปยน(ฮโ)
            Tโโปยนฮโ = Tโโปยน(ฮโ)

            Mยฒยน = Mยนยฒ' * Tโโปยนฮโ'
            Mยฒยฒ = Mยฒยฒ  * Tโโปยนฮโ' 
            Mยฒยณ = Mยฒยณ  * Tโโปยนฮโ'
            Mยฒโด = Mยฒโด  * Tโโปยนฮโ'
            Mยณยน = Mยนยณ'
            Mยณยฒ = Mยฒยณ'
            Mโดยน = Mยนโด' * Tโโปยนฮโ'
            Mโดยฒ = Mยฒโด' * Tโโปยนฮโ' 
            Mโดยณ = Mยณโด' * Tโโปยนฮโ'
            Mโดโด = Mโดโด  * Tโโปยนฮโ'

            Cแตยฒยน = Cแตยฒยน * Tโโปยนฮโ'
            Cแตยฒยฒ = Cแตยฒยฒ * Tโโปยนฮโ' 
            Cแตยฒยณ = Cแตยฒยณ * Tโโปยนฮโ'
            Cแตยฒโด = Cแตยฒโด * Tโโปยนฮโ'
            Cแตโดยน = Cแตโดยน * Tโโปยนฮโ'
            Cแตโดยฒ = Cแตโดยฒ * Tโโปยนฮโ' 
            Cแตโดยณ = Cแตโดยณ * Tโโปยนฮโ'
            Cแตโดโด = Cแตโดโด * Tโโปยนฮโ'

        else

            Mยฒยน = Mยนยฒ'
            Mยณยน = Mยนยณ'
            Mยณยฒ = Mยฒยณ'
            Mโดยน = Mยนโด' 
            Mโดยฒ = Mยฒโด'
            Mโดยณ = Mยณโด'

        end




        if contactsearch


            Tแถยน = lโ2*Tแถยน
            Tแถยฒ = lโ2*Tแถยฒ
            Tแถยณ = lโ2*Tแถยณ
            Tแถโด = lโ2*Tแถโด


            Cแถยนยน = lโ2 * Cแถยนยน 
            Cแถยนยฒ = lโ2 * Cแถยนยฒ 
            Cแถยนยณ = lโ2 * Cแถยนยณ 
            Cแถยนโด = lโ2 * Cแถยนโด 
            Cแถยฒยน = lโ2 * Cแถยฒยน 
            Cแถยฒยฒ = lโ2 * Cแถยฒยฒ 
            Cแถยฒยณ = lโ2 * Cแถยฒยณ 
            Cแถยฒโด = lโ2 * Cแถยฒโด 
            Cแถยณยน = lโ2 * Cแถยณยน 
            Cแถยณยฒ = lโ2 * Cแถยณยฒ 
            Cแถยณยณ = lโ2 * Cแถยณยณ 
            Cแถยณโด = lโ2 * Cแถยณโด 
            Cแถโดยน = lโ2 * Cแถโดยน 
            Cแถโดยฒ = lโ2 * Cแถโดยฒ 
            Cแถโดยณ = lโ2 * Cแถโดยณ 
            Cแถโดโด = lโ2 * Cแถโดโด 

            Kแถยนยน = lโ2 * Kแถยนยน
            Kแถยนยฒ = lโ2 * Kแถยนยฒ
            Kแถยนยณ = lโ2 * Kแถยนยณ
            Kแถยนโด = lโ2 * Kแถยนโด
            Kแถยฒยน = lโ2 * Kแถยฒยน
            Kแถยฒยฒ = lโ2 * Kแถยฒยฒ
            Kแถยฒยณ = lโ2 * Kแถยฒยณ
            Kแถยฒโด = lโ2 * Kแถยฒโด
            Kแถยณยน = lโ2 * Kแถยณยน
            Kแถยณยฒ = lโ2 * Kแถยณยฒ
            Kแถยณยณ = lโ2 * Kแถยณยณ
            Kแถยณโด = lโ2 * Kแถยณโด
            Kแถโดยน = lโ2 * Kแถโดยน
            Kแถโดยฒ = lโ2 * Kแถโดยฒ
            Kแถโดยณ = lโ2 * Kแถโดยณ
            Kแถโดโด = lโ2 * Kแถโดโด

            contact_energy = lโ2 * contact_energy


            if exact

                Cแถยฒยน = Cแถยฒยน * Tโโปยนฮโ'
                Cแถยฒยฒ = Cแถยฒยฒ * Tโโปยนฮโ' 
                Cแถยฒยณ = Cแถยฒยณ * Tโโปยนฮโ'
                Cแถยฒโด = Cแถยฒโด * Tโโปยนฮโ'
                Cแถโดยน = Cแถโดยน * Tโโปยนฮโ'
                Cแถโดยฒ = Cแถโดยฒ * Tโโปยนฮโ' 
                Cแถโดยณ = Cแถโดยณ * Tโโปยนฮโ'
                Cแถโดโด = Cแถโดโด * Tโโปยนฮโ'

            end


        end



    end


    Tแต = [Tแตยน; Tแตยฒ; Tแตยณ; Tแตโด]
    
    M = hcat(vcat(Mยนยน, Mยฒยน, Mยณยน, Mโดยน), vcat(Mยนยฒ, Mยฒยฒ, Mยณยฒ, Mโดยฒ), vcat(Mยนยณ, Mยฒยณ, Mยณยณ, Mโดยณ), vcat(Mยนโด, Mยฒโด, Mยณโด, Mโดโด))
    Cแต = hcat(vcat(Cแตยนยน, Cแตยฒยน, Cแตยณยน, Cแตโดยน), vcat(Cแตยนยฒ, Cแตยฒยฒ, Cแตยณยฒ, Cแตโดยฒ), vcat(Cแตยนยณ, Cแตยฒยณ, Cแตยณยณ, Cแตโดยณ), vcat(Cแตยนโด, Cแตยฒโด, Cแตยณโด, Cแตโดโด))

    
    Tแถ = [Tแถยน; Tแถยฒ; Tแถยณ; Tแถโด]
    Kแถ = hcat(vcat(Kแถยนยน, Kแถยฒยน, Kแถยณยน, Kแถโดยน), vcat(Kแถยนยฒ, Kแถยฒยฒ, Kแถยณยฒ, Kแถโดยฒ), vcat(Kแถยนยณ, Kแถยฒยณ, Kแถยณยณ, Kแถโดยณ), vcat(Kแถยนโด, Kแถยฒโด, Kแถยณโด, Kแถโดโด))
    Cแถ = hcat(vcat(Cแถยนยน, Cแถยฒยน, Cแถยณยน, Cแถโดยน), vcat(Cแถยนยฒ, Cแถยฒยฒ, Cแถยณยฒ, Cแถโดยฒ), vcat(Cแถยนยณ, Cแถยฒยณ, Cแถยณยณ, Cแถโดยณ), vcat(Cแถยนโด, Cแถยฒโด, Cแถยณโด, Cแถโดโด))


    return strain_energy, kinetic_energy, contact_energy, Tโฑโฟแต, Tแต, Tแถ, Kโฑโฟแต, Kแถ, M, Cแต, Cแถ




    
end







function assemble!(conf, matrices, energy, params, ฮt) 

    @unpack nodes, beams, colors, contact, sdf, gausspoints = conf
    
        
    # initialise the matrices associate to the whole structure
    fill!(matrices.K, 0)
    fill!(matrices.C, 0)
    fill!(matrices.M, 0)
    fill!(matrices.Tโฑโฟแต, 0)
    fill!(matrices.Tแต, 0)
    fill!(matrices.Tแถ, 0)
    
    # initialise the energy values associate to the whole structure
    energy.strain_energy = 0
    energy.kinetic_energy = 0
    energy.contact_energy = 0

    #Preparing constants
    gausspoints_info = (params.nแดณ, params.ฯแดณ, params.zแดณ)

    for cidxs in colors

        # @batch for idx in cidxs
        Threads.@threads for idx in cidxs

            b = LazyRow(beams, idx)
            
            n1 = b.node1
            n2 = b.node2
            # information from node 1 and 2
            Xโ, Xโ = nodes.Xโ[n1], nodes.Xโ[n2]
            uโ, uโ = nodes.u[n1], nodes.u[n2]
            uฬโ, uฬโ = nodes.uฬ[n1], nodes.uฬ[n2]
            uฬโ, uฬโ = nodes.uฬ[n1], nodes.uฬ[n2]
            wฬโ, wฬโ = nodes.wฬ[n1], nodes.wฬ[n2]
            wฬโ, wฬโ = nodes.wฬ[n1], nodes.wฬ[n2]
            Rโ, Rโ = nodes.R[n1], nodes.R[n2]
            ฮRโ, ฮRโ = nodes.ฮR[n1], nodes.ฮR[n2]

            # Packing
            init = (b.ind, Xโ, Xโ, b.lโ, b.Rโโฐ)      
            constants = (init, gausspoints_info, b.properties, contact, sdf, ฮt, gausspoints)

            strain_energy, kinetic_energy, contact_energy, Tโฑโฟแต, Tแต, Tแถ, Kโฑโฟแต, Kแถ, M, Cแต, Cแถ = compute(uโ, uโ, Rโ, Rโ, ฮRโ, ฮRโ, uฬโ, uฬโ, wฬโ, wฬโ, uฬโ, uฬโ, wฬโ, wฬโ, constants)
        
            K = Kโฑโฟแต - Kแถ
            C = Cแต-(1+params.ฮฑ)*Cแถ

            #-----------------------
            # Assemble contributions

            idof1 = nodes.idof_6[n1]
            idof2 = nodes.idof_6[n2]
            
            dofs = vcat(idof1, idof2)

            energy.strain_energy +=  strain_energy
            energy.kinetic_energy += kinetic_energy
            energy.contact_energy += contact_energy

            matrices.Tแต[dofs] += Tแต
            matrices.Tโฑโฟแต[dofs] += Tโฑโฟแต
            matrices.Tแถ[dofs] += Tแถ

            matrices.K[b.sparsity_map] += vec(K)
            matrices.C[b.sparsity_map] += vec(C)
            matrices.M[b.sparsity_map] += vec(M)

                                
        end

    end

end 