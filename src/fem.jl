
# Rotate using Rodrigue's formula
@inline function rotation_matrix(Î˜::AbstractVecOrMat{T}) where T
    
    Î˜_norm = norm(Î˜)
    if Î˜_norm > 10*eps(T)
        sinÎ˜ = sin(Î˜_norm)
        SÎ˜ = skew(Î˜)
        R = ID3 + sinÎ˜/Î˜_norm*SÎ˜ +  2*(sin(Î˜_norm/2)/Î˜_norm)^2 * SÎ˜*SÎ˜
        return R
    else
        return SMatrix{3,3,T,9}(1,0,0,0,1,0,0,0,1)
    end

end


@inline function local_Râ°(xâ‚, xâ‚‚)

    vâ‚ = xâ‚‚ - xâ‚
    l = norm(vâ‚)
    vâ‚ = vâ‚/l
    eâ‚‚ = @SVector [0,1,0]
    eâ‚ƒ = @SVector [0,0,1]

    if ( vâ‚[1] > 1e-8*l ) || ( vâ‚[2] > 1e-8*l )
        aux = cross(eâ‚ƒ, vâ‚)
        vâ‚‚ = aux/norm(aux)
    else
        T = eltype(vâ‚)
        vâ‚‚ = T.(eâ‚‚)
    end
    
    vâ‚ƒ = cross(vâ‚, vâ‚‚)

    Râ‚‘ = [vâ‚ vâ‚‚ vâ‚ƒ]

    return Râ‚‘

end


    



@inline function local_Râ‚‘_and_aux(xâ‚, xâ‚‚, Râ‚, Râ‚‚, Râ‚‘â°Eâ‚‚, lâ‚™)

    vâ‚ = (xâ‚‚ - xâ‚)/lâ‚™
    pâ‚ = Râ‚ * Râ‚‘â°Eâ‚‚
    pâ‚‚ = Râ‚‚ * Râ‚‘â°Eâ‚‚
    p = (pâ‚+pâ‚‚)/2
    vâ‚ƒ = cross(vâ‚, p)
    vâ‚ƒ = vâ‚ƒ / norm(vâ‚ƒ)
    vâ‚‚ = cross(vâ‚ƒ, vâ‚)

    Râ‚‘ = [vâ‚ vâ‚‚ vâ‚ƒ]

    ruâ‚ = -vâ‚'
    ruâ‚‚ = vâ‚'

    Râ‚‘Â¹Â²áµ€ = Râ‚‘[:, SOneTo(2)]'

    qâ‚, qâ‚‚ = Râ‚‘Â¹Â²áµ€*p
    qÂ¹Â¹, qÂ¹Â² = Râ‚‘Â¹Â²áµ€*pâ‚
    qÂ²Â¹, qÂ²Â² = Râ‚‘Â¹Â²áµ€*pâ‚‚
    
    Î· = qâ‚/qâ‚‚
    Î·Â¹Â¹ = qÂ¹Â¹/qâ‚‚
    Î·Â¹Â² = qÂ¹Â²/qâ‚‚
    Î·Â²Â¹ = qÂ²Â¹/qâ‚‚
    Î·Â²Â² = qÂ²Â²/qâ‚‚

    Gáµ€uâ‚ = @SMatrix [0 0 Î·/lâ‚™; 0 0 1/lâ‚™; 0 -1/lâ‚™ 0]
    Gáµ€uâ‚‚ = -Gáµ€uâ‚
    Gáµ€Î˜â‚ = @SMatrix [Î·Â¹Â²/2 -Î·Â¹Â¹/2 0; 0 0 0; 0 0 0]
    Gáµ€Î˜â‚‚ = @SMatrix [Î·Â²Â²/2 -Î·Â²Â¹/2 0; 0 0 0; 0 0 0]

    Dâ‚ƒ = (ID3 - vâ‚*vâ‚')/lâ‚™

    return Râ‚‘, ruâ‚, ruâ‚‚, Î·, Gáµ€uâ‚, Gáµ€Î˜â‚, Gáµ€uâ‚‚, Gáµ€Î˜â‚‚, Dâ‚ƒ
end




@inline function toangle(R::AbstractMatrix{T}) where T

    if abs((tr(R)-1)/2) < 1
        norm_v = max(acos((tr(R)-1)/2), 10*eps(T))
    else
        norm_v = 10*eps(T)
    end

    n_v = (1/(2*sin(norm_v))) * @SVector [R[3,2]-R[2,3], R[1,3]-R[3,1], R[2,1]-R[1,2]]

    return norm_v*n_v

end


@inline function skew(vec)

    return @SMatrix [0       -vec[3] vec[2] ;
                     vec[3]  0       -vec[1];
                     -vec[2] vec[1]  0      ]

end

# Get the inverse of skew symmetric matrix from toangle
@inline function Tâ‚›â»Â¹(Î˜::AbstractVector{T}) where T

    Î˜_norm = norm(Î˜)

    if Î˜_norm < 10*eps(T)
        Tâ‚›â»Â¹ = SMatrix{3,3,T,9}(1,0,0,0,1,0,0,0,1)
    else
        SÎ˜ = skew(Î˜)
        sinÎ˜2, cosÎ˜2 = sincos(Î˜_norm/2)
        Tâ‚›â»Â¹ = ID3 - SÎ˜/2 + (sinÎ˜2-Î˜_norm/2*cosÎ˜2)/(sinÎ˜2*Î˜_norm^2)*SÎ˜*SÎ˜
    end

    return Tâ‚›â»Â¹

end


@inline function Tâ‚›(Î˜::AbstractVector{T}) where T

    Î˜_norm = norm(Î˜)

    if Î˜_norm < 10*eps(T)
        Tâ‚› = SMatrix{3,3,T,9}(1, 0, 0, 0, 1, 0, 0, 0, 1)
    else
        SÎ˜ = skew(Î˜)
        Tâ‚› = ID3 + 2*(sin(Î˜_norm/2)/Î˜_norm)^2*SÎ˜ + (1-sin(Î˜_norm)/Î˜_norm)/Î˜_norm^2*(SÎ˜*SÎ˜)
    end

    return Tâ‚›

end


@inline function compute_Káµ¥(Î˜::AbstractVector{T}, v) where T

    Î˜norm = norm(Î˜)

    if Î˜norm < 10*eps(T)
        Káµ¥ = skew(v)/2
    else
        sinÎ˜, cosÎ˜ = sincos(Î˜norm)
        sinÎ˜2 = sin(Î˜norm/2)
        auxâ‚ = (2*sinÎ˜2/Î˜norm)^2

        u = Î˜/Î˜norm
        uvá¶œ = cross(u, v)
        uváµˆ = dot(u,v)
        UU = u*u'
        VU = v*u'
        UV = u*v'
    
        Káµ¥ =  (cosÎ˜-sinÎ˜/Î˜norm)/Î˜norm * (VU-uváµˆ*UU) + 
              (1-sinÎ˜/Î˜norm)/Î˜norm * (UV - 2*uváµˆ*UU + uváµˆ*ID3) -
              (sinÎ˜/Î˜norm-auxâ‚) * (uvá¶œ*u') +
              auxâ‚ * skew(v)/2
    
    end

    return Káµ¥

end


#  Compute Kint matrix
@inline function KÌ„â±â¿áµ—_beam(mat, geom, lâ‚€)
    
    KÌ„â±â¿áµ—uÌ„ = geom.A*mat.E/lâ‚€
    KÌ„â±â¿áµ—Î˜Ì… = Diagonal(@SVector [mat.G*geom.J/lâ‚€, 4*mat.E*geom.Iâ‚ƒâ‚ƒ/lâ‚€, 4*mat.E*geom.Iâ‚‚â‚‚/lâ‚€])
    KÌ„â±â¿áµ—Î˜Ì…Î˜Ì… = Diagonal(@SVector [-mat.G*geom.J/lâ‚€, 2*mat.E*geom.Iâ‚ƒâ‚ƒ/lâ‚€, 2*mat.E*geom.Iâ‚‚â‚‚/lâ‚€])
    
    return KÌ„â±â¿áµ—uÌ„, KÌ„â±â¿áµ—Î˜Ì…, KÌ„â±â¿áµ—Î˜Ì…Î˜Ì…
    
end




@inline function compute_Î·_Î¼(Î˜Ì„::AbstractVector{T}) where T

    Î˜ = norm(Î˜Ì„)

    if Î˜<10*eps(T)
        Î· = T(1/12)
        Î¼ = T(1/360)
    else
        sinÎ˜, cosÎ˜ = sincos(Î˜)
        sinÎ˜2 = sin(Î˜/2)
        Î· = ((2*sinÎ˜)-Î˜*(1+cosÎ˜))/(2*(Î˜^2)*sinÎ˜)
        Î¼ = (Î˜*(Î˜+sinÎ˜)-8*(sinÎ˜2)^2)/(4*(Î˜^4)*(sinÎ˜2)^2)
    end
    
    return Î·, Î¼

end




@inline function compute_KÌ„â‚•(Î˜Ì…, MÌ„, Tâ‚›â»Â¹Î˜Ì…, Î·, Î¼)

    Î˜Ì…MÌ„áµ€ = Î˜Ì…*MÌ„'
    MÌ„Î˜Ì…áµ€ = Î˜Ì…MÌ„áµ€'

    SÎ˜Ì… = skew(Î˜Ì…)
    SMÌ„ = skew(MÌ„)

    KÌ„â‚• =  ( Î·*(Î˜Ì…MÌ„áµ€ - 2*MÌ„Î˜Ì…áµ€ + dot(Î˜Ì…, MÌ„)*ID3) + Î¼*(SÎ˜Ì…*SÎ˜Ì…*MÌ„Î˜Ì…áµ€) - SMÌ„/2 ) * Tâ‚›â»Â¹Î˜Ì…

    return KÌ„â‚•

end




@inline function Pmatrices(Nâ‚, Nâ‚‚, Nâ‚ƒ, Nâ‚„, Nâ‚…, Nâ‚†, lâ‚™, Î·, Î·â‚â‚, Î·â‚â‚‚, Î·â‚‚â‚, Î·â‚‚â‚‚)

    Pâ‚PÂ¹ = @SMatrix [0 0 0; 0 (Nâ‚ƒ+Nâ‚„)/lâ‚™ 0; 0 0 (Nâ‚ƒ+Nâ‚„)/lâ‚™]
    Pâ‚PÂ² = @SMatrix [0 0 0; 0 0 Nâ‚ƒ; 0 -Nâ‚ƒ 0]
    Pâ‚PÂ³ = -Pâ‚PÂ¹
    Pâ‚Pâ´ = @SMatrix [0 0 0; 0 0 Nâ‚„; 0 -Nâ‚„ 0]

    Pâ‚‚PÂ¹ = @SMatrix [0 0 -Î·*(Nâ‚+Nâ‚‚)/lâ‚™; 0 0 -(Nâ‚…+Nâ‚†)/lâ‚™; 0 (Nâ‚…+Nâ‚†)/lâ‚™ 0]
    Pâ‚‚PÂ² = @SMatrix [-(Nâ‚‚*Î·â‚â‚‚)/2-Nâ‚*(Î·â‚â‚‚/2 - 1) (Î·â‚â‚*(Nâ‚+Nâ‚‚))/2 0; 0 Nâ‚… 0; 0 0 Nâ‚†]
    Pâ‚‚PÂ³ = -Pâ‚‚PÂ¹
    Pâ‚‚Pâ´ = @SMatrix [-(Nâ‚*Î·â‚‚â‚‚)/2-Nâ‚‚*(Î·â‚‚â‚‚/2 - 1) (Î·â‚‚â‚*(Nâ‚+Nâ‚‚))/2 0; 0 Nâ‚… 0; 0 0 Nâ‚†]


    return Pâ‚PÂ¹, Pâ‚PÂ², Pâ‚PÂ³, Pâ‚Pâ´, Pâ‚‚PÂ¹, Pâ‚‚PÂ², Pâ‚‚PÂ³, Pâ‚‚Pâ´

end







Base.@propagate_inbounds function compute(uâ‚::AbstractVector{T}, uâ‚‚, Râ‚, Râ‚‚, Î”Râ‚, Î”Râ‚‚, uÌ‡â‚, uÌ‡â‚‚, wÌ‡â‚, wÌ‡â‚‚, uÌˆâ‚, uÌˆâ‚‚, wÌˆâ‚, wÌˆâ‚‚, simvars, exact=true, dynamics=true) where T

    # Superscript Â¹ means matrix or vector associated to uâ‚
    # Superscript Â² means matrix or vector associated to Î˜â‚
    # Superscript Â³ means matrix or vector associated to uâ‚‚
    # Superscript â´ means matrix or vector associated to Î˜â‚‚

    (;Xâ‚, Xâ‚‚, lâ‚€, Râ‚‘â°) = simvars.init
    geom = simvars.geom
    comp = simvars.comp
    mat = simvars.mat
    

    xâ‚ =  Xâ‚ + uâ‚
    xâ‚‚ =  Xâ‚‚ + uâ‚‚
    
    lâ‚™ = norm(xâ‚‚ - xâ‚)

    uÌ„ = lâ‚™ - lâ‚€

    Râ‚‘, rÂ¹, rÂ³, Î·, Gáµ€Â¹, Gáµ€Â², Gáµ€Â³, Gáµ€â´, Dâ‚ƒ = local_Râ‚‘_and_aux(xâ‚, xâ‚‚, Râ‚, Râ‚‚, Râ‚‘â°[:,2], lâ‚™)


    RÌ…â‚ = Râ‚‘' * Râ‚ * Râ‚‘â°
    RÌ…â‚‚ = Râ‚‘' * Râ‚‚ * Râ‚‘â°

    Î˜Ì…â‚ = toangle(RÌ…â‚)
    Î˜Ì…â‚‚ = toangle(RÌ…â‚‚)

    if exact
        Tâ‚›â»Â¹Î˜Ì…â‚ = Tâ‚›â»Â¹(Î˜Ì…â‚)
        Tâ‚›â»Â¹Î˜Ì…â‚‚ = Tâ‚›â»Â¹(Î˜Ì…â‚‚)
    end


    PÂ¹Â¹ = -Gáµ€Â¹ 
    PÂ²Â¹ = PÂ¹Â¹
    PÂ¹Â² = ID3-Gáµ€Â²
    PÂ²Â² = -Gáµ€Â²
    PÂ¹â´ = -Gáµ€â´
    PÂ²â´ = ID3-Gáµ€â´


    # BÌ„âº = [r; PEáµ€]
    BÌ„âºÂ¹ = rÂ¹
    BÌ„âºÂ¹Â¹ = PÂ¹Â¹ * Râ‚‘'
    BÌ„âºÂ²Â¹ = BÌ„âºÂ¹Â¹
    BÌ„âºÂ¹Â² = PÂ¹Â² * Râ‚‘'
    BÌ„âºÂ²Â² = PÂ²Â² * Râ‚‘'
    BÌ„âºÂ¹â´ = PÂ¹â´ * Râ‚‘'
    BÌ„âºÂ²â´ = PÂ²â´ * Râ‚‘'

    
    # B = BÌ„BÌ„âº
    BÂ¹ = BÌ„âºÂ¹
    BÂ¹Â¹ = exact ?  Tâ‚›â»Â¹Î˜Ì…â‚ * BÌ„âºÂ¹Â¹ : BÌ„âºÂ¹Â¹
    BÂ¹Â² = exact ?  Tâ‚›â»Â¹Î˜Ì…â‚ * BÌ„âºÂ¹Â² : BÌ„âºÂ¹Â²
    BÂ¹â´ = exact ?  Tâ‚›â»Â¹Î˜Ì…â‚ * BÌ„âºÂ¹â´ : BÌ„âºÂ¹â´
    BÂ²Â¹ = exact ?  Tâ‚›â»Â¹Î˜Ì…â‚‚ * BÌ„âºÂ²Â¹ : BÌ„âºÂ²Â¹
    BÂ²Â² = exact ?  Tâ‚›â»Â¹Î˜Ì…â‚‚ * BÌ„âºÂ²Â² : BÌ„âºÂ²Â²
    BÂ²â´ = exact ?  Tâ‚›â»Â¹Î˜Ì…â‚‚ * BÌ„âºÂ²â´ : BÌ„âºÂ²â´

    

    KÌ„â±â¿áµ—uÌ„, KÌ„â±â¿áµ—Î˜Ì…, KÌ„â±â¿áµ—Î˜Ì…Î˜Ì… = KÌ„â±â¿áµ—_beam(mat, geom, lâ‚€)

    # TÌ„â±â¿áµ— = KÌ„â±â¿áµ— DÌ„
    TÌ„â±â¿áµ—uÌ„  = KÌ„â±â¿áµ—uÌ„  * uÌ„
    TÌ„â±â¿áµ—Î˜Ì…â‚ = KÌ„â±â¿áµ—Î˜Ì…  * Î˜Ì…â‚ + KÌ„â±â¿áµ—Î˜Ì…Î˜Ì… * Î˜Ì…â‚‚
    TÌ„â±â¿áµ—Î˜Ì…â‚‚ = KÌ„â±â¿áµ—Î˜Ì…Î˜Ì… * Î˜Ì…â‚ + KÌ„â±â¿áµ—Î˜Ì…  * Î˜Ì…â‚‚

    strain_energy = (uÌ„*TÌ„â±â¿áµ—uÌ„ + dot(Î˜Ì…â‚, TÌ„â±â¿áµ—Î˜Ì…â‚) + dot(Î˜Ì…â‚‚, TÌ„â±â¿áµ—Î˜Ì…â‚‚))/2


    # Tâ±â¿áµ— = Báµ€ TÌ„â±â¿áµ—
    Tâ±â¿áµ—Â¹ = BÂ¹'*TÌ„â±â¿áµ—uÌ„ + BÂ¹Â¹'*TÌ„â±â¿áµ—Î˜Ì…â‚ + BÂ²Â¹'*TÌ„â±â¿áµ—Î˜Ì…â‚‚
    Tâ±â¿áµ—Â² =             BÂ¹Â²'*TÌ„â±â¿áµ—Î˜Ì…â‚ + BÂ²Â²'*TÌ„â±â¿áµ—Î˜Ì…â‚‚
    Tâ±â¿áµ—Â³ = -Tâ±â¿áµ—Â¹
    Tâ±â¿áµ—â´ =             BÂ¹â´'*TÌ„â±â¿áµ—Î˜Ì…â‚ + BÂ²â´'*TÌ„â±â¿áµ—Î˜Ì…â‚‚



    # Force
    Tâ±â¿áµ— = [Tâ±â¿áµ—Â¹; Tâ±â¿áµ—Â²; Tâ±â¿áµ—Â³; Tâ±â¿áµ—â´]


    # [NÌ„ MÌ„âºâ‚ MÌ„âºâ‚‚] = BÌ„áµ€ TÌ„â±â¿áµ—
    NÌ„   = TÌ„â±â¿áµ—uÌ„
    MÌ„âºâ‚ = exact ? Tâ‚›â»Â¹Î˜Ì…â‚' * TÌ„â±â¿áµ—Î˜Ì…â‚  : TÌ„â±â¿áµ—Î˜Ì…â‚
    MÌ„âºâ‚‚ = exact ? Tâ‚›â»Â¹Î˜Ì…â‚‚' * TÌ„â±â¿áµ—Î˜Ì…â‚‚  : TÌ„â±â¿áµ—Î˜Ì…â‚‚


    # Qâ‚› = Páµ€ [MÌ„âºâ‚ MÌ„âºâ‚‚]
    Qâ‚›Â¹ = PÂ¹Â¹' * MÌ„âºâ‚ + PÂ²Â¹' * MÌ„âºâ‚‚
    Qâ‚›Â² = PÂ¹Â²' * MÌ„âºâ‚ + PÂ²Â²' * MÌ„âºâ‚‚
    Qâ‚›â´ = PÂ¹â´' * MÌ„âºâ‚ + PÂ²â´' * MÌ„âºâ‚‚
    

    # Q = S(Qâ‚›)
    QÂ¹ = skew(Qâ‚›Â¹)
    QÂ² = skew(Qâ‚›Â²)
    Qâ´ = skew(Qâ‚›â´)

    a = @SVector [0, Î·*(MÌ„âºâ‚[1] + MÌ„âºâ‚‚[1])/lâ‚™ + (MÌ„âºâ‚[2] + MÌ„âºâ‚‚[2])/lâ‚™, (MÌ„âºâ‚[3] + MÌ„âºâ‚‚[3])/lâ‚™]


    # DNÌ„ (DNÌ„Â¹Â¹ = DNÌ„Â³Â³ = -DNÌ„Â¹Â³ = -DNÌ„Â³Â¹)
    DNÌ„Â¹Â¹ = Dâ‚ƒ*NÌ„

    #QGáµ€
    QGáµ€Â¹Â¹ = QÂ¹*Gáµ€Â¹
    QGáµ€Â¹Â² = QÂ¹*Gáµ€Â²
    QGáµ€Â¹â´ = QÂ¹*Gáµ€â´

    QGáµ€Â²Â² = QÂ²*Gáµ€Â²
    QGáµ€Â²â´ = QÂ²*Gáµ€â´

    QGáµ€â´â´ = Qâ´*Gáµ€â´


    # EGa (diagonal)
    # Note: Râ‚‘*Ga = 0 for Î˜ indices because Râ‚‘*Gáµ€Î˜' has only non-zero values in the first column and a = [0 ...]
    EGaÂ¹ = Râ‚‘*Gáµ€Â¹'*a

    # EGar (EGarÂ¹Â¹ = EGarÂ³Â³ = -EGarÂ³Â¹ = -EGarÂ¹Â³)
    EGarÂ¹Â¹ = EGaÂ¹*rÂ¹

    # Kâ‚˜ = DNÌ„ - EQGáµ€Eáµ€ + EGar
    Kâ‚˜Â¹Â¹ = DNÌ„Â¹Â¹ - Râ‚‘*QGáµ€Â¹Â¹*Râ‚‘' + EGarÂ¹Â¹
    Kâ‚˜Â¹Â² =      - Râ‚‘*QGáµ€Â¹Â²*Râ‚‘'
    Kâ‚˜Â¹â´ =      - Râ‚‘*QGáµ€Â¹â´*Râ‚‘'
    
    Kâ‚˜Â²Â² =      - Râ‚‘*QGáµ€Â²Â²*Râ‚‘'
    Kâ‚˜Â²â´ =      - Râ‚‘*QGáµ€Â²â´*Râ‚‘'

    Kâ‚˜â´â´ =      - Râ‚‘*QGáµ€â´â´*Râ‚‘'


    # KÌƒ

    if exact

        Î·â‚, Î¼â‚ = compute_Î·_Î¼(Î˜Ì…â‚)
        Î·â‚‚, Î¼â‚‚ = compute_Î·_Î¼(Î˜Ì…â‚‚)

        MÌ„â‚ = TÌ„â±â¿áµ—Î˜Ì…â‚
        MÌ„â‚‚ = TÌ„â±â¿áµ—Î˜Ì…â‚‚

        KÌ„â‚•â‚ = compute_KÌ„â‚•(Î˜Ì…â‚, MÌ„â‚, Tâ‚›â»Â¹Î˜Ì…â‚, Î·â‚, Î¼â‚)
        KÌ„â‚•â‚‚ = compute_KÌ„â‚•(Î˜Ì…â‚‚, MÌ„â‚‚, Tâ‚›â»Â¹Î˜Ì…â‚‚, Î·â‚‚, Î¼â‚‚)

    end


    KÌƒÂ¹Â¹ = exact ?  BÌ„âºÂ¹Â¹' * KÌ„â‚•â‚ * BÌ„âºÂ¹Â¹  +  BÌ„âºÂ²Â¹' * KÌ„â‚•â‚‚ * BÌ„âºÂ²Â¹  +  Kâ‚˜Â¹Â¹   :   Kâ‚˜Â¹Â¹ 
    KÌƒÂ¹Â² = exact ?  BÌ„âºÂ¹Â¹' * KÌ„â‚•â‚ * BÌ„âºÂ¹Â²  +  BÌ„âºÂ²Â¹' * KÌ„â‚•â‚‚ * BÌ„âºÂ²Â²  +  Kâ‚˜Â¹Â²   :   Kâ‚˜Â¹Â² 
    KÌƒÂ¹â´ = exact ?  BÌ„âºÂ¹Â¹' * KÌ„â‚•â‚ * BÌ„âºÂ¹â´  +  BÌ„âºÂ²Â¹' * KÌ„â‚•â‚‚ * BÌ„âºÂ²â´  +  Kâ‚˜Â¹â´   :   Kâ‚˜Â¹â´ 

    KÌƒÂ²Â² = exact ?  BÌ„âºÂ¹Â²' * KÌ„â‚•â‚ * BÌ„âºÂ¹Â²  +  BÌ„âºÂ²Â²' * KÌ„â‚•â‚‚ * BÌ„âºÂ²Â²  +  Kâ‚˜Â²Â²   :   Kâ‚˜Â²Â² 
    KÌƒÂ²â´ = exact ?  BÌ„âºÂ¹Â²' * KÌ„â‚•â‚ * BÌ„âºÂ¹â´  +  BÌ„âºÂ²Â²' * KÌ„â‚•â‚‚ * BÌ„âºÂ²â´  +  Kâ‚˜Â²â´   :   Kâ‚˜Â²â´ 

    KÌƒâ´â´ = exact ?  BÌ„âºÂ¹â´' * KÌ„â‚•â‚ * BÌ„âºÂ¹â´  +  BÌ„âºÂ²â´' * KÌ„â‚•â‚‚ * BÌ„âºÂ²â´  +  Kâ‚˜â´â´   :   Kâ‚˜â´â´ 


    # Báµ€Kâ±â¿áµ—B
    
    Báµ€Kâ±â¿áµ—BÂ¹Â¹ = BÂ¹' * KÌ„â±â¿áµ—uÌ„ * BÂ¹      +      BÂ¹Â¹' * (KÌ„â±â¿áµ—Î˜Ì… * BÂ¹Â¹  +  KÌ„â±â¿áµ—Î˜Ì…Î˜Ì… * BÂ²Â¹)  +  BÂ²Â¹' * (KÌ„â±â¿áµ—Î˜Ì…Î˜Ì… * BÂ¹Â¹  +  KÌ„â±â¿áµ—Î˜Ì… * BÂ²Â¹)    
    Báµ€Kâ±â¿áµ—BÂ¹Â² =                              BÂ¹Â¹' * (KÌ„â±â¿áµ—Î˜Ì… * BÂ¹Â²  +  KÌ„â±â¿áµ—Î˜Ì…Î˜Ì… * BÂ²Â²)  +  BÂ²Â¹' * (KÌ„â±â¿áµ—Î˜Ì…Î˜Ì… * BÂ¹Â²  +  KÌ„â±â¿áµ—Î˜Ì… * BÂ²Â²)     
    Báµ€Kâ±â¿áµ—BÂ¹â´ =                              BÂ¹Â¹' * (KÌ„â±â¿áµ—Î˜Ì… * BÂ¹â´  +  KÌ„â±â¿áµ—Î˜Ì…Î˜Ì… * BÂ²â´)  +  BÂ²Â¹' * (KÌ„â±â¿áµ—Î˜Ì…Î˜Ì… * BÂ¹â´  +  KÌ„â±â¿áµ—Î˜Ì… * BÂ²â´)    
        
    Báµ€Kâ±â¿áµ—BÂ²Â² =                              BÂ¹Â²' * (KÌ„â±â¿áµ—Î˜Ì… * BÂ¹Â²  +  KÌ„â±â¿áµ—Î˜Ì…Î˜Ì… * BÂ²Â²)  +  BÂ²Â²' * (KÌ„â±â¿áµ—Î˜Ì…Î˜Ì… * BÂ¹Â²  +  KÌ„â±â¿áµ—Î˜Ì… * BÂ²Â²)      
    Báµ€Kâ±â¿áµ—BÂ²â´ =                              BÂ¹Â²' * (KÌ„â±â¿áµ—Î˜Ì… * BÂ¹â´  +  KÌ„â±â¿áµ—Î˜Ì…Î˜Ì… * BÂ²â´)  +  BÂ²Â²' * (KÌ„â±â¿áµ—Î˜Ì…Î˜Ì… * BÂ¹â´  +  KÌ„â±â¿áµ—Î˜Ì… * BÂ²â´)      
        
    Báµ€Kâ±â¿áµ—Bâ´â´ =                              BÂ¹â´' * (KÌ„â±â¿áµ—Î˜Ì… * BÂ¹â´  +  KÌ„â±â¿áµ—Î˜Ì…Î˜Ì… * BÂ²â´)  +  BÂ²â´' * (KÌ„â±â¿áµ—Î˜Ì…Î˜Ì… * BÂ¹â´  +  KÌ„â±â¿áµ—Î˜Ì… * BÂ²â´)    

    Kâ±â¿áµ—Â¹Â¹ =  Báµ€Kâ±â¿áµ—BÂ¹Â¹   +    KÌƒÂ¹Â¹
    Kâ±â¿áµ—Â¹Â² =  Báµ€Kâ±â¿áµ—BÂ¹Â²   +    KÌƒÂ¹Â²
    Kâ±â¿áµ—Â¹Â³ =  -Kâ±â¿áµ—Â¹Â¹
    Kâ±â¿áµ—Â¹â´ =  Báµ€Kâ±â¿áµ—BÂ¹â´   +    KÌƒÂ¹â´

    Kâ±â¿áµ—Â²Â² =  Báµ€Kâ±â¿áµ—BÂ²Â²   +    KÌƒÂ²Â²
    Kâ±â¿áµ—Â²Â³ =  -Kâ±â¿áµ—Â¹Â²'
    Kâ±â¿áµ—Â²â´ =  Báµ€Kâ±â¿áµ—BÂ²â´   +    KÌƒÂ²â´
    
    Kâ±â¿áµ—Â³Â³ =  Kâ±â¿áµ—Â¹Â¹
    Kâ±â¿áµ—Â³â´ =  -Kâ±â¿áµ—Â¹â´

    Kâ±â¿áµ—â´â´ =  Báµ€Kâ±â¿áµ—Bâ´â´   +    KÌƒâ´â´



    Kâ±â¿áµ— = hcat(vcat(Kâ±â¿áµ—Â¹Â¹, Kâ±â¿áµ—Â¹Â²', Kâ±â¿áµ—Â¹Â³', Kâ±â¿áµ—Â¹â´'), vcat(Kâ±â¿áµ—Â¹Â², Kâ±â¿áµ—Â²Â², Kâ±â¿áµ—Â²Â³', Kâ±â¿áµ—Â²â´'), vcat(Kâ±â¿áµ—Â¹Â³, Kâ±â¿áµ—Â²Â³, Kâ±â¿áµ—Â³Â³, Kâ±â¿áµ—Â³â´'), vcat(Kâ±â¿áµ—Â¹â´, Kâ±â¿áµ—Â²â´, Kâ±â¿áµ—Â³â´, Kâ±â¿áµ—â´â´))






    kinetic_energy = zero(T)

    TáµÂ¹ = zeros(Vec3{T})
    TáµÂ² = zeros(Vec3{T})
    TáµÂ³ = zeros(Vec3{T})
    Táµâ´ = zeros(Vec3{T})

    TáµˆÂ¹ = zeros(Vec3{T})
    TáµˆÂ² = zeros(Vec3{T})
    TáµˆÂ³ = zeros(Vec3{T})
    Táµˆâ´ = zeros(Vec3{T})

    MÂ¹Â¹ = zeros(Mat33{T})
    MÂ¹Â² = zeros(Mat33{T})
    MÂ¹Â³ = zeros(Mat33{T})
    MÂ¹â´ = zeros(Mat33{T})
    MÂ²Â¹ = zeros(Mat33{T})
    MÂ²Â² = zeros(Mat33{T})
    MÂ²Â³ = zeros(Mat33{T})
    MÂ²â´ = zeros(Mat33{T})
    MÂ³Â¹ = zeros(Mat33{T})
    MÂ³Â² = zeros(Mat33{T})
    MÂ³Â³ = zeros(Mat33{T})
    MÂ³â´ = zeros(Mat33{T})
    Mâ´Â¹ = zeros(Mat33{T})
    Mâ´Â² = zeros(Mat33{T})
    Mâ´Â³ = zeros(Mat33{T})
    Mâ´â´ = zeros(Mat33{T})

    CáµÂ¹Â¹ = zeros(Mat33{T})
    CáµÂ¹Â² = zeros(Mat33{T})
    CáµÂ¹Â³ = zeros(Mat33{T})
    CáµÂ¹â´ = zeros(Mat33{T})
    CáµÂ²Â¹ = zeros(Mat33{T})
    CáµÂ²Â² = zeros(Mat33{T})
    CáµÂ²Â³ = zeros(Mat33{T})
    CáµÂ²â´ = zeros(Mat33{T})
    CáµÂ³Â¹ = zeros(Mat33{T})
    CáµÂ³Â² = zeros(Mat33{T})
    CáµÂ³Â³ = zeros(Mat33{T})
    CáµÂ³â´ = zeros(Mat33{T})
    Cáµâ´Â¹ = zeros(Mat33{T})
    Cáµâ´Â² = zeros(Mat33{T})
    Cáµâ´Â³ = zeros(Mat33{T})
    Cáµâ´â´ = zeros(Mat33{T})




    contact_energy = zero(T)
        

    Tá¶œÂ¹ = zeros(Vec3{T})
    Tá¶œÂ² = zeros(Vec3{T})
    Tá¶œÂ³ = zeros(Vec3{T})
    Tá¶œâ´ = zeros(Vec3{T})



    Ká¶œÂ¹Â¹ = zeros(Mat33{T})
    Ká¶œÂ¹Â² = zeros(Mat33{T})
    Ká¶œÂ¹Â³ = zeros(Mat33{T})
    Ká¶œÂ¹â´ = zeros(Mat33{T})
    Ká¶œÂ²Â¹ = zeros(Mat33{T})
    Ká¶œÂ²Â² = zeros(Mat33{T})
    Ká¶œÂ²Â³ = zeros(Mat33{T})
    Ká¶œÂ²â´ = zeros(Mat33{T})
    Ká¶œÂ³Â¹ = zeros(Mat33{T})
    Ká¶œÂ³Â² = zeros(Mat33{T})
    Ká¶œÂ³Â³ = zeros(Mat33{T})
    Ká¶œÂ³â´ = zeros(Mat33{T})
    Ká¶œâ´Â¹ = zeros(Mat33{T})
    Ká¶œâ´Â² = zeros(Mat33{T})
    Ká¶œâ´Â³ = zeros(Mat33{T})
    Ká¶œâ´â´ = zeros(Mat33{T})

    Cá¶œÂ¹Â¹ = zeros(Mat33{T})
    Cá¶œÂ¹Â² = zeros(Mat33{T})
    Cá¶œÂ¹Â³ = zeros(Mat33{T})
    Cá¶œÂ¹â´ = zeros(Mat33{T})
    Cá¶œÂ²Â¹ = zeros(Mat33{T})
    Cá¶œÂ²Â² = zeros(Mat33{T})
    Cá¶œÂ²Â³ = zeros(Mat33{T})
    Cá¶œÂ²â´ = zeros(Mat33{T})
    Cá¶œÂ³Â¹ = zeros(Mat33{T})
    Cá¶œÂ³Â² = zeros(Mat33{T})
    Cá¶œÂ³Â³ = zeros(Mat33{T})
    Cá¶œÂ³â´ = zeros(Mat33{T})
    Cá¶œâ´Â¹ = zeros(Mat33{T})
    Cá¶œâ´Â² = zeros(Mat33{T})
    Cá¶œâ´Â³ = zeros(Mat33{T})
    Cá¶œâ´â´ = zeros(Mat33{T})


    
    contact = !isnothing(simvars.sdf)
        
    if dynamics
        
        UÌ‡â‚ = Râ‚‘' * uÌ‡â‚
        UÌ‡â‚‚ = Râ‚‘' * uÌ‡â‚‚
        WÌ‡â‚ = Râ‚‘' * wÌ‡â‚
        WÌ‡â‚‚ = Râ‚‘' * wÌ‡â‚‚
        
        UÌˆâ‚ = Râ‚‘' * uÌˆâ‚
        UÌˆâ‚‚ = Râ‚‘' * uÌˆâ‚‚
        WÌˆâ‚ = Râ‚‘' * wÌˆâ‚
        WÌˆâ‚‚ = Râ‚‘' * wÌˆâ‚‚

        SUÌ‡â‚ = skew(UÌ‡â‚)
        SUÌ‡â‚‚ = skew(UÌ‡â‚‚)
        SWÌ‡â‚ = skew(WÌ‡â‚)
        SWÌ‡â‚‚ = skew(WÌ‡â‚‚)

        WÌ‡áµ‰ = Gáµ€Â¹ * UÌ‡â‚ + Gáµ€Â² * WÌ‡â‚ + Gáµ€Â³ * UÌ‡â‚‚ + Gáµ€â´ * WÌ‡â‚‚
        SWÌ‡áµ‰ = skew(WÌ‡áµ‰)

        rdÌ‡ = dot(rÂ¹, uÌ‡â‚) + dot(rÂ³, uÌ‡â‚‚)


        Gáµ€Â¹Râ‚‘áµ€ = Gáµ€Â¹ * Râ‚‘'
        Gáµ€Â²Râ‚‘áµ€ = Gáµ€Â² * Râ‚‘'
        Gáµ€â´Râ‚‘áµ€ = Gáµ€â´ * Râ‚‘'

        Râ‚‘GÂ¹ = Râ‚‘ * Gáµ€Â¹'
        Râ‚‘GÂ² = Râ‚‘ * Gáµ€Â²'
        Râ‚‘Gâ´ = Râ‚‘ * Gáµ€â´'





        # cycle among the Gauss positions
        for iG in 1:comp.ná´³

            zá´³ = comp.zá´³[iG]
            Ï‰á´³ = comp.Ï‰á´³[iG]

            Î¾ = lâ‚€*(zá´³+1)/2

            # Shape functions
            Nâ‚ = 1-Î¾/lâ‚€
            Nâ‚‚ = 1-Nâ‚
            Nâ‚ƒ = Î¾*(1-Î¾/lâ‚€)^2
            Nâ‚„ = -(1-Î¾/lâ‚€)*((Î¾^2)/lâ‚€)
            Nâ‚… = (1-3*Î¾/lâ‚€)*(1-Î¾/lâ‚€)
            Nâ‚† = (3*Î¾/lâ‚€-2)*(Î¾/lâ‚€)
            Nâ‚‡ = Nâ‚ƒ+Nâ‚„
            Nâ‚ˆ = Nâ‚…+Nâ‚†-1


            uáµ— = @SVector [0, Nâ‚ƒ*Î˜Ì…â‚[3] + Nâ‚„*Î˜Ì…â‚‚[3], -Nâ‚ƒ*Î˜Ì…â‚[2] + -Nâ‚„*Î˜Ì…â‚‚[2]]
            Î˜Ì„  = @SVector [Nâ‚*Î˜Ì…â‚[1] + Nâ‚‚*Î˜Ì…â‚‚[1], Nâ‚…*Î˜Ì…â‚[2] + Nâ‚†*Î˜Ì…â‚‚[2], Nâ‚…*Î˜Ì…â‚[3] + Nâ‚†*Î˜Ì…â‚‚[3]]

            Suáµ— = skew(uáµ—)
            SÎ˜Ì„ = skew(Î˜Ì„)

            RÌ„ = ID3 + SÎ˜Ì„

            IÌ„áµ¨ = RÌ„*mat.Jáµ¨*RÌ„'
            Aáµ¨ = mat.Aáµ¨

            Nâ‚‡lâ‚™ = Nâ‚‡/lâ‚™
            Nâ‚‡lâ‚™Â² = Nâ‚‡lâ‚™/lâ‚™
            Nâ‚ˆlâ‚™ = Nâ‚ˆ/lâ‚™
            Nâ‚ˆlâ‚™Â² = Nâ‚ˆlâ‚™/lâ‚™

            Pâ‚PÂ¹ = @SMatrix [0 0 0; 0 Nâ‚‡lâ‚™ 0;0 0 Nâ‚‡lâ‚™]
            Pâ‚PÂ² = @SMatrix [0 0 0; 0 0 Nâ‚ƒ;0 -Nâ‚ƒ 0]
            Pâ‚PÂ³ = -Pâ‚PÂ¹
            Pâ‚Pâ´ = @SMatrix [0 0 0; 0 0 Nâ‚„;0 -Nâ‚„ 0]

            Hâ‚Â¹ = Nâ‚*ID3 + Pâ‚PÂ¹ - Suáµ—*Gáµ€Â¹
            Hâ‚Â² =          Pâ‚PÂ² - Suáµ—*Gáµ€Â²
            Hâ‚Â³ = Nâ‚‚*ID3 + Pâ‚PÂ³ - Suáµ—*Gáµ€Â³
            Hâ‚â´ =          Pâ‚Pâ´ - Suáµ—*Gáµ€â´

            Hâ‚‚Â¹ = @SMatrix [0 0 0; 0  0 -Nâ‚ˆlâ‚™;0 Nâ‚ˆlâ‚™ 0]
            Hâ‚‚Â² = Diagonal(@SVector [Nâ‚, Nâ‚…, Nâ‚…])
            Hâ‚‚Â³ = -Hâ‚‚Â¹
            Hâ‚‚â´ = Diagonal(@SVector [Nâ‚‚, Nâ‚†, Nâ‚†])


            uÌ‡áµ— =  Pâ‚PÂ¹ * UÌ‡â‚ +  Pâ‚PÂ² * WÌ‡â‚ + Pâ‚PÂ³ * UÌ‡â‚‚ + Pâ‚PÂ² * WÌ‡â‚‚

            SuÌ‡áµ— = skew(uÌ‡áµ—)
            
            Nâ‚‡rdÌ‡ = Nâ‚‡lâ‚™Â² * rdÌ‡
            HÌ‡â‚Â¹ = Diagonal(@SVector [0, -Nâ‚‡rdÌ‡, -Nâ‚‡rdÌ‡]) - SuÌ‡áµ— * Gáµ€Â¹
            HÌ‡â‚Â² =                                      - SuÌ‡áµ— * Gáµ€Â²
            HÌ‡â‚â´ =                                      - SuÌ‡áµ— * Gáµ€â´

            Nâ‚ˆrdÌ‡ = Nâ‚ˆlâ‚™Â² * rdÌ‡
            HÌ‡â‚‚Â¹ = @SMatrix [0 0 0; 0 0 Nâ‚ˆrdÌ‡; 0 -Nâ‚ˆrdÌ‡ 0]

            hâ‚ = Hâ‚Â¹ * UÌ‡â‚ + Hâ‚Â² * WÌ‡â‚ + Hâ‚Â³ * UÌ‡â‚‚ + Hâ‚â´ * WÌ‡â‚‚
            hâ‚‚ = Hâ‚‚Â¹ * UÌ‡â‚ + Hâ‚‚Â² * WÌ‡â‚ + Hâ‚‚Â³ * UÌ‡â‚‚ + Hâ‚‚â´ * WÌ‡â‚‚
            Shâ‚ = skew(hâ‚)
            Shâ‚‚ = skew(hâ‚‚)

            Câ‚Â¹ = SWÌ‡áµ‰ * Hâ‚Â¹ + HÌ‡â‚Â¹ - Hâ‚Â¹ * SWÌ‡áµ‰
            Câ‚Â² = SWÌ‡áµ‰ * Hâ‚Â² + HÌ‡â‚Â² - Hâ‚Â² * SWÌ‡áµ‰
            Câ‚Â³ = -Câ‚Â¹
            Câ‚â´ = SWÌ‡áµ‰ * Hâ‚â´ + HÌ‡â‚â´ - Hâ‚â´ * SWÌ‡áµ‰

            Câ‚‚Â¹ = SWÌ‡áµ‰ * Hâ‚‚Â¹ + HÌ‡â‚‚Â¹ - Hâ‚‚Â¹ * SWÌ‡áµ‰
            Câ‚‚Â² = SWÌ‡áµ‰ * Hâ‚‚Â²       - Hâ‚‚Â² * SWÌ‡áµ‰
            Câ‚‚Â³ = -Câ‚‚Â¹
            Câ‚‚â´ = SWÌ‡áµ‰ * Hâ‚‚â´       - Hâ‚‚â´ * SWÌ‡áµ‰

            Hâ‚Fâ‚ = Hâ‚Â¹ * SUÌ‡â‚ + Hâ‚Â² * SWÌ‡â‚ + Hâ‚Â³ * SUÌ‡â‚‚ + Hâ‚â´ * SWÌ‡â‚‚
            Hâ‚‚Fâ‚ = Hâ‚‚Â¹ * SUÌ‡â‚ + Hâ‚‚Â² * SWÌ‡â‚ + Hâ‚‚Â³ * SUÌ‡â‚‚ + Hâ‚‚â´ * SWÌ‡â‚‚

            Aâ‚DÌ‡rEÂ¹ = @SMatrix [0 0 0; UÌ‡â‚[2]-UÌ‡â‚‚[2] 0 0; UÌ‡â‚[3]-UÌ‡â‚‚[3] 0 0]
            Câ‚ƒÂ¹ = -Shâ‚*Gáµ€Â¹ + Nâ‚‡lâ‚™Â²*Aâ‚DÌ‡rEÂ¹ + SWÌ‡áµ‰*Pâ‚PÂ¹ + Hâ‚Fâ‚*Gáµ€Â¹
            Câ‚ƒÂ² = -Shâ‚*Gáµ€Â² +                  SWÌ‡áµ‰*Pâ‚PÂ² + Hâ‚Fâ‚*Gáµ€Â²
            Câ‚ƒâ´ = -Shâ‚*Gáµ€â´ +                  SWÌ‡áµ‰*Pâ‚Pâ´ + Hâ‚Fâ‚*Gáµ€â´

            Aâ‚‚DÌ‡rEÂ¹ = @SMatrix [0 0 0; -UÌ‡â‚[3]+UÌ‡â‚‚[3] 0 0; UÌ‡â‚[2]-UÌ‡â‚‚[2] 0 0]
            Câ‚„Â¹ = -Shâ‚‚*Gáµ€Â¹ + Nâ‚ˆlâ‚™Â²*Aâ‚‚DÌ‡rEÂ¹ + Hâ‚‚Fâ‚*Gáµ€Â¹
            Câ‚„Â² = -Shâ‚‚*Gáµ€Â²                  + Hâ‚‚Fâ‚*Gáµ€Â²
            Câ‚„â´ = -Shâ‚‚*Gáµ€â´                  + Hâ‚‚Fâ‚*Gáµ€â´

            uÌ‡â‚€ = Râ‚‘ * hâ‚

            Hâ‚Eáµ€dÌˆ = Hâ‚Â¹ * UÌˆâ‚ + Hâ‚Â² * WÌˆâ‚ + Hâ‚Â³ * UÌˆâ‚‚ + Hâ‚â´ * WÌˆâ‚‚
            Câ‚Eáµ€dÌ‡ = Câ‚Â¹ * UÌ‡â‚ + Câ‚Â² * WÌ‡â‚ + Câ‚Â³ * UÌ‡â‚‚ + Câ‚â´ * WÌ‡â‚‚
            Râ‚‘áµ€uÌˆâ‚€ = Hâ‚Eáµ€dÌˆ + Câ‚Eáµ€dÌ‡

            WÌ‡â‚€ = hâ‚‚
            wÌ‡â‚€ = Râ‚‘ * WÌ‡â‚€

            Hâ‚‚Eáµ€dÌˆ = Hâ‚‚Â¹ * UÌˆâ‚ + Hâ‚‚Â² * WÌˆâ‚ + Hâ‚‚Â³ * UÌˆâ‚‚ + Hâ‚‚â´ * WÌˆâ‚‚
            Câ‚‚Eáµ€dÌ‡ = Câ‚‚Â¹ * UÌ‡â‚ + Câ‚‚Â² * WÌ‡â‚ + Câ‚‚Â³ * UÌ‡â‚‚ + Câ‚‚â´ * WÌ‡â‚‚
            Râ‚‘áµ€wÌˆâ‚€ = Hâ‚‚Eáµ€dÌˆ + Câ‚‚Eáµ€dÌ‡

            SWÌ‡â‚€ = skew(WÌ‡â‚€)
            IÌ„áµ¨Râ‚‘áµ€wÌˆâ‚€ = IÌ„áµ¨*Râ‚‘áµ€wÌˆâ‚€
            SWÌ‡â‚€IÌ„áµ¨ = SWÌ‡â‚€*IÌ„áµ¨
            SWÌ‡â‚€IÌ„áµ¨WÌ‡â‚€ = SWÌ‡â‚€IÌ„áµ¨*WÌ‡â‚€
            IÌ„áµ¨Râ‚‘áµ€wÌˆâ‚€SWÌ‡â‚€IÌ„áµ¨WÌ‡â‚€ = IÌ„áµ¨Râ‚‘áµ€wÌˆâ‚€ + SWÌ‡â‚€IÌ„áµ¨WÌ‡â‚€
            Aáµ¨Hâ‚Â¹áµ€ = Aáµ¨*Hâ‚Â¹'
            Aáµ¨Hâ‚Â²áµ€ = Aáµ¨*Hâ‚Â²'
            Aáµ¨Hâ‚â´áµ€ = Aáµ¨*Hâ‚â´'
            TáµÂ¹G = Ï‰á´³ * (Aáµ¨Hâ‚Â¹áµ€*Râ‚‘áµ€uÌˆâ‚€ + Hâ‚‚Â¹'*IÌ„áµ¨Râ‚‘áµ€wÌˆâ‚€SWÌ‡â‚€IÌ„áµ¨WÌ‡â‚€)
            TáµÂ²G = Ï‰á´³ * (Aáµ¨Hâ‚Â²áµ€*Râ‚‘áµ€uÌˆâ‚€ + Hâ‚‚Â²'*IÌ„áµ¨Râ‚‘áµ€wÌˆâ‚€SWÌ‡â‚€IÌ„áµ¨WÌ‡â‚€)
            Táµâ´G = Ï‰á´³ * (Aáµ¨Hâ‚â´áµ€*Râ‚‘áµ€uÌˆâ‚€ + Hâ‚‚â´'*IÌ„áµ¨Râ‚‘áµ€wÌˆâ‚€SWÌ‡â‚€IÌ„áµ¨WÌ‡â‚€)

            TáµÂ¹ += TáµÂ¹G
            TáµÂ² += TáµÂ²G
            TáµÂ³ += -TáµÂ¹G + Ï‰á´³ * Aáµ¨ * Râ‚‘áµ€uÌˆâ‚€
            Táµâ´ += Táµâ´G

            if comp.damping>0
                TáµˆÂ¹ += Ï‰á´³ * (comp.damping * Aáµ¨Hâ‚Â¹áµ€*hâ‚ + Hâ‚‚Â¹'*IÌ„áµ¨*hâ‚‚)
                TáµˆÂ² += Ï‰á´³ * (comp.damping * Aáµ¨Hâ‚Â²áµ€*hâ‚ + Hâ‚‚Â²'*IÌ„áµ¨*hâ‚‚)
                TáµˆÂ³ += -TáµˆÂ¹ + Ï‰á´³ * Aáµ¨ * comp.damping * hâ‚
                Táµˆâ´ += Ï‰á´³ * (comp.damping * Aáµ¨Hâ‚â´áµ€*hâ‚ + Hâ‚‚â´'*IÌ„áµ¨*hâ‚‚)
            end


            MÂ¹Â¹G = Ï‰á´³ * (Aáµ¨Hâ‚Â¹áµ€*Hâ‚Â¹ + Hâ‚‚Â¹'*IÌ„áµ¨*Hâ‚‚Â¹)
            MÂ¹Â²G = Ï‰á´³ * (Aáµ¨Hâ‚Â¹áµ€*Hâ‚Â² + Hâ‚‚Â¹'*IÌ„áµ¨*Hâ‚‚Â²)
            MÂ¹â´G = Ï‰á´³ * (Aáµ¨Hâ‚Â¹áµ€*Hâ‚â´ + Hâ‚‚Â¹'*IÌ„áµ¨*Hâ‚‚â´)

            MÂ²Â²G = Ï‰á´³ * (Aáµ¨Hâ‚Â²áµ€*Hâ‚Â² + Hâ‚‚Â²'*IÌ„áµ¨*Hâ‚‚Â²)
            MÂ²â´G = Ï‰á´³ * (Aáµ¨Hâ‚Â²áµ€*Hâ‚â´ + Hâ‚‚Â²'*IÌ„áµ¨*Hâ‚‚â´)
            
            Mâ´â´G = Ï‰á´³ * (Aáµ¨Hâ‚â´áµ€*Hâ‚â´ + Hâ‚‚â´'*IÌ„áµ¨*Hâ‚‚â´)


            MÂ¹Â¹ += MÂ¹Â¹G
            MÂ¹Â² += MÂ¹Â²G
            MÂ¹Â³ += -MÂ¹Â¹G + Ï‰á´³ * Aáµ¨Hâ‚Â¹áµ€
            MÂ¹â´ += MÂ¹â´G

            MÂ²Â² += MÂ²Â²G
            MÂ²Â³ += -MÂ¹Â²G' + Ï‰á´³ * Aáµ¨Hâ‚Â²áµ€
            MÂ²â´ += MÂ²â´G

            MÂ³Â³ += MÂ¹Â¹G + Ï‰á´³ * Aáµ¨ * (ID3 - Hâ‚Â¹ - Hâ‚Â¹')
            MÂ³â´ += -MÂ¹â´G + Ï‰á´³ * Aáµ¨*Hâ‚â´
            
            Mâ´â´ += Mâ´â´G


            SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ = SWÌ‡â‚€IÌ„áµ¨ - skew(IÌ„áµ¨*WÌ‡â‚€)

            Aáµ¨Câ‚Â¹Câ‚ƒÂ¹ = Aáµ¨*(Câ‚Â¹ + Câ‚ƒÂ¹)
            Aáµ¨Câ‚Â¹Câ‚ƒÂ² = Aáµ¨*(Câ‚Â² + Câ‚ƒÂ²)
            Aáµ¨Câ‚Â¹Câ‚ƒâ´ = Aáµ¨*(Câ‚â´ + Câ‚ƒâ´)

            IÌ„áµ¨Câ‚‚Â¹Câ‚„Â¹SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€Hâ‚‚Â¹ = IÌ„áµ¨*(Câ‚‚Â¹ + Câ‚„Â¹) + SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚Â¹
            IÌ„áµ¨Câ‚‚Â²Câ‚„Â¹SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€Hâ‚‚Â² = IÌ„áµ¨*(Câ‚‚Â² + Câ‚„Â²) + SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚Â²
            IÌ„áµ¨Câ‚‚â´Câ‚„Â¹SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€Hâ‚‚â´ = IÌ„áµ¨*(Câ‚‚â´ + Câ‚„â´) + SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€ * Hâ‚‚â´


            CáµÂ¹Â¹G = Ï‰á´³ * (Hâ‚Â¹'*Aáµ¨Câ‚Â¹Câ‚ƒÂ¹ + Hâ‚‚Â¹'* IÌ„áµ¨Câ‚‚Â¹Câ‚„Â¹SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€Hâ‚‚Â¹ ) 
            CáµÂ¹Â²G = Ï‰á´³ * (Hâ‚Â¹'*Aáµ¨Câ‚Â¹Câ‚ƒÂ² + Hâ‚‚Â¹'* IÌ„áµ¨Câ‚‚Â²Câ‚„Â¹SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€Hâ‚‚Â² ) 
            CáµÂ¹â´G = Ï‰á´³ * (Hâ‚Â¹'*Aáµ¨Câ‚Â¹Câ‚ƒâ´ + Hâ‚‚Â¹'* IÌ„áµ¨Câ‚‚â´Câ‚„Â¹SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€Hâ‚‚â´ ) 

            CáµÂ²Â¹G = Ï‰á´³ * (Hâ‚Â²'*Aáµ¨Câ‚Â¹Câ‚ƒÂ¹ + Hâ‚‚Â²'* IÌ„áµ¨Câ‚‚Â¹Câ‚„Â¹SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€Hâ‚‚Â¹ ) 
            CáµÂ²Â²G = Ï‰á´³ * (Hâ‚Â²'*Aáµ¨Câ‚Â¹Câ‚ƒÂ² + Hâ‚‚Â²'* IÌ„áµ¨Câ‚‚Â²Câ‚„Â¹SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€Hâ‚‚Â² ) 
            CáµÂ²â´G = Ï‰á´³ * (Hâ‚Â²'*Aáµ¨Câ‚Â¹Câ‚ƒâ´ + Hâ‚‚Â²'* IÌ„áµ¨Câ‚‚â´Câ‚„Â¹SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€Hâ‚‚â´ ) 

            Cáµâ´Â¹G = Ï‰á´³ * (Hâ‚â´'*Aáµ¨Câ‚Â¹Câ‚ƒÂ¹ + Hâ‚‚â´'* IÌ„áµ¨Câ‚‚Â¹Câ‚„Â¹SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€Hâ‚‚Â¹ ) 
            Cáµâ´Â²G = Ï‰á´³ * (Hâ‚â´'*Aáµ¨Câ‚Â¹Câ‚ƒÂ² + Hâ‚‚â´'* IÌ„áµ¨Câ‚‚Â²Câ‚„Â¹SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€Hâ‚‚Â² ) 
            Cáµâ´â´G = Ï‰á´³ * (Hâ‚â´'*Aáµ¨Câ‚Â¹Câ‚ƒâ´ + Hâ‚‚â´'* IÌ„áµ¨Câ‚‚â´Câ‚„Â¹SWÌ‡â‚€IÌ„áµ¨mSIÌ„áµ¨WÌ‡â‚€Hâ‚‚â´ ) 


            CáµÂ¹Â¹ += CáµÂ¹Â¹G
            CáµÂ¹Â² += CáµÂ¹Â²G
            CáµÂ¹â´ += CáµÂ¹â´G

            CáµÂ²Â¹ += CáµÂ²Â¹G
            CáµÂ²Â² += CáµÂ²Â²G
            CáµÂ²â´ += CáµÂ²â´G

            CáµÂ³Â¹ += -CáµÂ¹Â¹G + Ï‰á´³ * Aáµ¨Câ‚Â¹Câ‚ƒÂ¹
            CáµÂ³Â² += -CáµÂ¹Â²G + Ï‰á´³ * Aáµ¨Câ‚Â¹Câ‚ƒÂ²
            CáµÂ³â´ += -CáµÂ¹â´G + Ï‰á´³ * Aáµ¨Câ‚Â¹Câ‚ƒâ´

            Cáµâ´Â¹ += Cáµâ´Â¹G
            Cáµâ´Â² += Cáµâ´Â²G
            Cáµâ´â´ += Cáµâ´â´G


            # kinetic energy
            IÌ„áµ¨áµ = Râ‚‘*IÌ„áµ¨*Râ‚‘'
            kinetic_energy += Ï‰á´³/2 * (Aáµ¨*uÌ‡â‚€'*uÌ‡â‚€ + wÌ‡â‚€'*IÌ„áµ¨áµ*wÌ‡â‚€)



            if contact

                xá´³ = Nâ‚*xâ‚ + Nâ‚‚*xâ‚‚ + Râ‚‘*uáµ—
                pâ‚™, pâ€²â‚™, Î â‚‘, gâ‚™, âˆ‚gâ‚™âˆ‚x, âˆ‚Â²gâ‚™âˆ‚xÂ² =  contact_gap(xá´³, comp.Îµá¶œ, simvars.sdf)
        
                if pâ‚™ â‰‰ 0 
        
                    Iâˆ‚gâ‚™âˆ‚x = ID3 - âˆ‚gâ‚™âˆ‚x*âˆ‚gâ‚™âˆ‚x'
                    gÌ‡â‚œ = Iâˆ‚gâ‚™âˆ‚x*uÌ‡â‚€
                    gÌ‡â‚œÂ² = dot(gÌ‡â‚œ, gÌ‡â‚œ)
        
                    contact_energy -= Ï‰á´³*Î â‚‘
                    
                    ğ“–â‚™ = âˆ‚gâ‚™âˆ‚x
                    Î¼Ê³áµ‰áµ = comp.Î¼/sqrt(gÌ‡â‚œÂ²+comp.Îµáµ—)
                    ğ“–â‚œ = -Î¼Ê³áµ‰áµ*gÌ‡â‚œ
                    
        
                    ğ“– = ğ“–â‚™ + ğ“–â‚œ
                    ğ“¯á¶œ = pâ‚™ * ğ“–
        
                    ğ“•á¶œ = Râ‚‘' * ğ“¯á¶œ
        
                    Râ‚‘Hâ‚áµ€Â¹ = Râ‚‘ * Hâ‚Â¹'
                    Râ‚‘Hâ‚áµ€Â² = Râ‚‘ * Hâ‚Â²'
                    Râ‚‘Hâ‚áµ€Â³ = Râ‚‘ * Hâ‚Â³'
                    Râ‚‘Hâ‚áµ€â´ = Râ‚‘ * Hâ‚â´'
        
                    Tá¶œÂ¹ += Ï‰á´³ * (Râ‚‘Hâ‚áµ€Â¹ * ğ“•á¶œ)
                    Tá¶œÂ² += Ï‰á´³ * (Râ‚‘Hâ‚áµ€Â² * ğ“•á¶œ)
                    Tá¶œÂ³ += Ï‰á´³ * (Râ‚‘Hâ‚áµ€Â³ * ğ“•á¶œ)
                    Tá¶œâ´ += Ï‰á´³ * (Râ‚‘Hâ‚áµ€â´ * ğ“•á¶œ)

        
                    SÌ‚Hâ‚áµ€ğ“•á¶œÂ¹ = skew(Hâ‚Â¹' * ğ“•á¶œ)
                    SÌ‚Hâ‚áµ€ğ“•á¶œÂ² = skew(Hâ‚Â²' * ğ“•á¶œ)
                    SÌ‚Hâ‚áµ€ğ“•á¶œÂ³ = skew(Hâ‚Â³' * ğ“•á¶œ)
                    SÌ‚Hâ‚áµ€ğ“•á¶œâ´ = skew(Hâ‚â´' * ğ“•á¶œ)
        
                    Râ‚‘SÌ‚Hâ‚áµ€ğ“•á¶œÂ¹ = Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œÂ¹
                    tâ‚Â¹Â¹ = -Râ‚‘SÌ‚Hâ‚áµ€ğ“•á¶œÂ¹ * Gáµ€Â¹Râ‚‘áµ€
                    tâ‚Â¹Â² = -Râ‚‘SÌ‚Hâ‚áµ€ğ“•á¶œÂ¹ * Gáµ€Â²Râ‚‘áµ€
                    tâ‚Â¹Â³ = -tâ‚Â¹Â¹
                    tâ‚Â¹â´ = -Râ‚‘SÌ‚Hâ‚áµ€ğ“•á¶œÂ¹ * Gáµ€â´Râ‚‘áµ€
        
                    Râ‚‘SÌ‚Hâ‚áµ€ğ“•á¶œÂ² = Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œÂ²
                    tâ‚Â²Â¹ = -Râ‚‘SÌ‚Hâ‚áµ€ğ“•á¶œÂ² * Gáµ€Â¹Râ‚‘áµ€
                    tâ‚Â²Â² = -Râ‚‘SÌ‚Hâ‚áµ€ğ“•á¶œÂ² * Gáµ€Â²Râ‚‘áµ€
                    tâ‚Â²Â³ = -tâ‚Â²Â¹
                    tâ‚Â²â´ = -Râ‚‘SÌ‚Hâ‚áµ€ğ“•á¶œÂ² * Gáµ€â´Râ‚‘áµ€
        
                    Râ‚‘SÌ‚Hâ‚áµ€ğ“•á¶œÂ³ = Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œÂ³
                    tâ‚Â³Â¹ = -Râ‚‘SÌ‚Hâ‚áµ€ğ“•á¶œÂ³ * Gáµ€Â¹Râ‚‘áµ€
                    tâ‚Â³Â² = -Râ‚‘SÌ‚Hâ‚áµ€ğ“•á¶œÂ³ * Gáµ€Â²Râ‚‘áµ€
                    tâ‚Â³Â³ = -tâ‚Â³Â¹
                    tâ‚Â³â´ = -Râ‚‘SÌ‚Hâ‚áµ€ğ“•á¶œÂ³ * Gáµ€â´Râ‚‘áµ€
        
                    Râ‚‘SÌ‚Hâ‚áµ€ğ“•á¶œâ´ = Râ‚‘ * SÌ‚Hâ‚áµ€ğ“•á¶œâ´
                    tâ‚â´Â¹ = -Râ‚‘SÌ‚Hâ‚áµ€ğ“•á¶œâ´ * Gáµ€Â¹Râ‚‘áµ€
                    tâ‚â´Â² = -Râ‚‘SÌ‚Hâ‚áµ€ğ“•á¶œâ´ * Gáµ€Â²Râ‚‘áµ€
                    tâ‚â´Â³ = -tâ‚â´Â¹
                    tâ‚â´â´ = -Râ‚‘SÌ‚Hâ‚áµ€ğ“•á¶œâ´ * Gáµ€â´Râ‚‘áµ€
        
        
                    vâ‚ = rÂ³
                    Aâ‚áµ€ğ“•á¶œrâ‚â‚ = @SMatrix[0 0 0; ğ“•á¶œ[2]*vâ‚[1] ğ“•á¶œ[2]*vâ‚[2] ğ“•á¶œ[2]*vâ‚[3]; ğ“•á¶œ[3]*vâ‚[1] ğ“•á¶œ[3]*vâ‚[2] ğ“•á¶œ[3]*vâ‚[3]]
        
                    Sğ“•á¶œ = skew(ğ“•á¶œ)
        
                    Sğ“•á¶œPâ‚PÂ¹Râ‚‘áµ€ = Sğ“•á¶œ * Pâ‚PÂ¹ * Râ‚‘'
                    Sğ“•á¶œPâ‚PÂ²Râ‚‘áµ€ = Sğ“•á¶œ * Pâ‚PÂ² * Râ‚‘'
                    Sğ“•á¶œPâ‚Pâ´Râ‚‘áµ€ = Sğ“•á¶œ * Pâ‚Pâ´ * Râ‚‘'
                    
                    tâ‚‚Â¹Â¹ = Nâ‚‡lâ‚™Â² * Râ‚‘ * Aâ‚áµ€ğ“•á¶œrâ‚â‚ - Râ‚‘GÂ¹ * Sğ“•á¶œPâ‚PÂ¹Râ‚‘áµ€
                    tâ‚‚Â¹Â² =                       - Râ‚‘GÂ¹ * Sğ“•á¶œPâ‚PÂ²Râ‚‘áµ€
                    tâ‚‚Â¹Â³ = -tâ‚‚Â¹Â¹
                    tâ‚‚Â¹â´ =                       - Râ‚‘GÂ¹ * Sğ“•á¶œPâ‚Pâ´Râ‚‘áµ€
        
                    tâ‚‚Â²Â¹ =                       - Râ‚‘GÂ² * Sğ“•á¶œPâ‚PÂ¹Râ‚‘áµ€
                    tâ‚‚Â²Â² =                       - Râ‚‘GÂ² * Sğ“•á¶œPâ‚PÂ²Râ‚‘áµ€
                    tâ‚‚Â²Â³ = -tâ‚‚Â²Â¹
                    tâ‚‚Â²â´ =                       - Râ‚‘GÂ² * Sğ“•á¶œPâ‚Pâ´Râ‚‘áµ€
        
                    tâ‚‚Â³Â¹ = tâ‚‚Â¹Â³
                    tâ‚‚Â³Â² = -tâ‚‚Â¹Â²
                    tâ‚‚Â³Â³ = tâ‚‚Â¹Â¹
                    tâ‚‚Â³â´ = -tâ‚‚Â¹â´
        
                    tâ‚‚â´Â¹ =                       - Râ‚‘Gâ´ * Sğ“•á¶œPâ‚PÂ¹Râ‚‘áµ€
                    tâ‚‚â´Â² =                       - Râ‚‘Gâ´ * Sğ“•á¶œPâ‚PÂ²Râ‚‘áµ€
                    tâ‚‚â´Â³ = -tâ‚‚â´Â¹
                    tâ‚‚â´â´ =                       - Râ‚‘Gâ´ * Sğ“•á¶œPâ‚Pâ´Râ‚‘áµ€
        
                    Râ‚‘Hâ‚áµ€Â¹Sğ“•á¶œ = Râ‚‘Hâ‚áµ€Â¹ * Sğ“•á¶œ
                    Râ‚‘Hâ‚áµ€Â²Sğ“•á¶œ = Râ‚‘Hâ‚áµ€Â² * Sğ“•á¶œ
                    Râ‚‘Hâ‚áµ€Â³Sğ“•á¶œ = Râ‚‘Hâ‚áµ€Â³ * Sğ“•á¶œ
                    Râ‚‘Hâ‚áµ€â´Sğ“•á¶œ = Râ‚‘Hâ‚áµ€â´ * Sğ“•á¶œ
        
                    tâ‚ƒÂ¹Â¹ = Râ‚‘Hâ‚áµ€Â¹Sğ“•á¶œ * Gáµ€Â¹Râ‚‘áµ€
                    tâ‚ƒÂ¹Â² = Râ‚‘Hâ‚áµ€Â¹Sğ“•á¶œ * Gáµ€Â²Râ‚‘áµ€
                    tâ‚ƒÂ¹Â³ = -tâ‚ƒÂ¹Â¹
                    tâ‚ƒÂ¹â´ = Râ‚‘Hâ‚áµ€Â¹Sğ“•á¶œ * Gáµ€â´Râ‚‘áµ€
        
                    tâ‚ƒÂ²Â¹ = Râ‚‘Hâ‚áµ€Â²Sğ“•á¶œ * Gáµ€Â¹Râ‚‘áµ€
                    tâ‚ƒÂ²Â² = Râ‚‘Hâ‚áµ€Â²Sğ“•á¶œ * Gáµ€Â²Râ‚‘áµ€
                    tâ‚ƒÂ²Â³ = -tâ‚ƒÂ²Â¹
                    tâ‚ƒÂ²â´ = Râ‚‘Hâ‚áµ€Â²Sğ“•á¶œ * Gáµ€â´Râ‚‘áµ€
        
                    tâ‚ƒÂ³Â¹ = Râ‚‘Hâ‚áµ€Â³Sğ“•á¶œ * Gáµ€Â¹Râ‚‘áµ€
                    tâ‚ƒÂ³Â² = Râ‚‘Hâ‚áµ€Â³Sğ“•á¶œ * Gáµ€Â²Râ‚‘áµ€
                    tâ‚ƒÂ³Â³ = -tâ‚ƒÂ³Â¹
                    tâ‚ƒÂ³â´ = Râ‚‘Hâ‚áµ€Â³Sğ“•á¶œ * Gáµ€â´Râ‚‘áµ€
        
                    tâ‚ƒâ´Â¹ = Râ‚‘Hâ‚áµ€â´Sğ“•á¶œ * Gáµ€Â¹Râ‚‘áµ€
                    tâ‚ƒâ´Â² = Râ‚‘Hâ‚áµ€â´Sğ“•á¶œ * Gáµ€Â²Râ‚‘áµ€
                    tâ‚ƒâ´Â³ = -tâ‚ƒâ´Â¹
                    tâ‚ƒâ´â´ = Râ‚‘Hâ‚áµ€â´Sğ“•á¶œ * Gáµ€â´Râ‚‘áµ€
        
        
        
        
                    âˆ‚gâ‚™âˆ‚xRâ‚‘hâ‚âˆ‚Â²gâ‚™âˆ‚xÂ² = -dot(âˆ‚gâ‚™âˆ‚x, uÌ‡â‚€) * âˆ‚Â²gâ‚™âˆ‚xÂ²
                    Râ‚‘áµ€âˆ‚Â²gâ‚™âˆ‚xÂ²Râ‚‘hâ‚ = Râ‚‘' * âˆ‚Â²gâ‚™âˆ‚xÂ² * uÌ‡â‚€
                    Râ‚‘Hâ‚Â¹Râ‚‘áµ€ = Râ‚‘ * Hâ‚Â¹ * Râ‚‘'
                    Râ‚‘Hâ‚Â²Râ‚‘áµ€ = Râ‚‘ * Hâ‚Â² * Râ‚‘'
                    Râ‚‘Hâ‚Â³Râ‚‘áµ€ = Râ‚‘ * Hâ‚Â³ * Râ‚‘'
                    Râ‚‘Hâ‚â´Râ‚‘áµ€ = Râ‚‘ * Hâ‚â´ * Râ‚‘'
        
                    ğ“â‚Â¹ =  âˆ‚gâ‚™âˆ‚xRâ‚‘hâ‚âˆ‚Â²gâ‚™âˆ‚xÂ² * Râ‚‘Hâ‚Â¹Râ‚‘áµ€ - âˆ‚gâ‚™âˆ‚x * (Râ‚‘ * Hâ‚Â¹' * Râ‚‘áµ€âˆ‚Â²gâ‚™âˆ‚xÂ²Râ‚‘hâ‚)'
                    ğ“â‚Â² =  âˆ‚gâ‚™âˆ‚xRâ‚‘hâ‚âˆ‚Â²gâ‚™âˆ‚xÂ² * Râ‚‘Hâ‚Â²Râ‚‘áµ€ - âˆ‚gâ‚™âˆ‚x * (Râ‚‘ * Hâ‚Â²' * Râ‚‘áµ€âˆ‚Â²gâ‚™âˆ‚xÂ²Râ‚‘hâ‚)'
                    ğ“â‚Â³ =  âˆ‚gâ‚™âˆ‚xRâ‚‘hâ‚âˆ‚Â²gâ‚™âˆ‚xÂ² * Râ‚‘Hâ‚Â³Râ‚‘áµ€ - âˆ‚gâ‚™âˆ‚x * (Râ‚‘ * Hâ‚Â³' * Râ‚‘áµ€âˆ‚Â²gâ‚™âˆ‚xÂ²Râ‚‘hâ‚)'
                    ğ“â‚â´ =  âˆ‚gâ‚™âˆ‚xRâ‚‘hâ‚âˆ‚Â²gâ‚™âˆ‚xÂ² * Râ‚‘Hâ‚â´Râ‚‘áµ€ - âˆ‚gâ‚™âˆ‚x * (Râ‚‘ * Hâ‚â´' * Râ‚‘áµ€âˆ‚Â²gâ‚™âˆ‚xÂ²Râ‚‘hâ‚)'
        
                    Iâˆ‚gâ‚™âˆ‚xRâ‚‘ = Iâˆ‚gâ‚™âˆ‚x * Râ‚‘
                    Iâˆ‚gâ‚™âˆ‚xRâ‚‘Shâ‚ = - Iâˆ‚gâ‚™âˆ‚xRâ‚‘ * Shâ‚
                    ğ“â‚‚Â¹ = Iâˆ‚gâ‚™âˆ‚xRâ‚‘Shâ‚ * Gáµ€Â¹Râ‚‘áµ€
                    ğ“â‚‚Â² = Iâˆ‚gâ‚™âˆ‚xRâ‚‘Shâ‚ * Gáµ€Â²Râ‚‘áµ€
                    ğ“â‚‚Â³ = -ğ“â‚‚Â¹
                    ğ“â‚‚â´ = Iâˆ‚gâ‚™âˆ‚xRâ‚‘Shâ‚ * Gáµ€â´Râ‚‘áµ€

                    Aâ‚DÌ‡rÂ¹ = @SMatrix [0 0 0; vâ‚[1]*(UÌ‡â‚[2]-UÌ‡â‚‚[2]) vâ‚[2]*(UÌ‡â‚[2]-UÌ‡â‚‚[2]) vâ‚[3]*(UÌ‡â‚[2]-UÌ‡â‚‚[2]);vâ‚[1]*(UÌ‡â‚[3]-UÌ‡â‚‚[3]) vâ‚[2]*(UÌ‡â‚[3]-UÌ‡â‚‚[3]) vâ‚[3]*(UÌ‡â‚[3]-UÌ‡â‚‚[3])]
                    Aâ‚DÌ‡rÂ³ = -Aâ‚DÌ‡rÂ¹
        
                    Râ‚‘SGáµ€DÌ‡ = Râ‚‘ * skew(Gáµ€Â¹ * UÌ‡â‚ + Gáµ€Â² * WÌ‡â‚ + Gáµ€Â³ * UÌ‡â‚‚ + Gáµ€â´ * WÌ‡â‚‚)
                    ğ“â‚ƒÂ¹ = Iâˆ‚gâ‚™âˆ‚x * Nâ‚‡lâ‚™Â² * Râ‚‘ * Aâ‚DÌ‡rÂ¹ + Râ‚‘SGáµ€DÌ‡ * Pâ‚PÂ¹ * Râ‚‘'
                    ğ“â‚ƒÂ² =                               Râ‚‘SGáµ€DÌ‡ * Pâ‚PÂ² * Râ‚‘'
                    ğ“â‚ƒÂ³ = Iâˆ‚gâ‚™âˆ‚x * Nâ‚‡lâ‚™Â² * Râ‚‘ * Aâ‚DÌ‡rÂ³ + Râ‚‘SGáµ€DÌ‡ * Pâ‚PÂ³ * Râ‚‘'
                    ğ“â‚ƒâ´ =                               Râ‚‘SGáµ€DÌ‡ * Pâ‚Pâ´ * Râ‚‘'
        
                    Hâ‚SDÌ‡ = Hâ‚Fâ‚
                    ğ“â‚„Â¹ = Iâˆ‚gâ‚™âˆ‚xRâ‚‘ * Hâ‚SDÌ‡ * Gáµ€Â¹Râ‚‘áµ€
                    ğ“â‚„Â² = Iâˆ‚gâ‚™âˆ‚xRâ‚‘ * Hâ‚SDÌ‡ * Gáµ€Â²Râ‚‘áµ€
                    ğ“â‚„Â³ = -ğ“â‚„Â¹
                    ğ“â‚„â´ = Iâˆ‚gâ‚™âˆ‚xRâ‚‘ * Hâ‚SDÌ‡ * Gáµ€â´Râ‚‘áµ€
        
                    ğ“‘Â¹ = Iâˆ‚gâ‚™âˆ‚x * Râ‚‘Hâ‚Â¹Râ‚‘áµ€
                    ğ“‘Â² = Iâˆ‚gâ‚™âˆ‚x * Râ‚‘Hâ‚Â²Râ‚‘áµ€
                    ğ“‘Â³ = Iâˆ‚gâ‚™âˆ‚x * Râ‚‘Hâ‚Â³Râ‚‘áµ€
                    ğ“‘â´ = Iâˆ‚gâ‚™âˆ‚x * Râ‚‘Hâ‚â´Râ‚‘áµ€
        
                    ğ“Â¹ = ğ“â‚Â¹ + ğ“â‚‚Â¹ + ğ“â‚ƒÂ¹ + ğ“â‚„Â¹
                    ğ“Â² = ğ“â‚Â² + ğ“â‚‚Â² + ğ“â‚ƒÂ² + ğ“â‚„Â²
                    ğ“Â³ = ğ“â‚Â³ + ğ“â‚‚Â³ + ğ“â‚ƒÂ³ + ğ“â‚„Â³
                    ğ“â´ = ğ“â‚â´ + ğ“â‚‚â´ + ğ“â‚ƒâ´ + ğ“â‚„â´
                    
                    IÎ¼Ê³áµ‰áµgÌ‡â‚œgÌ‡â‚œ = ID3 - Î¼Ê³áµ‰áµ*gÌ‡â‚œ*gÌ‡â‚œ'
                    Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â¹ = Râ‚‘Hâ‚áµ€Â¹ * Râ‚‘'
                    Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â² = Râ‚‘Hâ‚áµ€Â² * Râ‚‘'
                    Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â³ = Râ‚‘Hâ‚áµ€Â³ * Râ‚‘'
                    Râ‚‘Hâ‚áµ€Râ‚‘áµ€â´ = Râ‚‘Hâ‚áµ€â´ * Râ‚‘'
        
                    Ká¶ á¶œÂ¹ = pâ€²â‚™ * ğ“– * (Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â¹ * âˆ‚gâ‚™âˆ‚x)' + pâ‚™ * (âˆ‚Â²gâ‚™âˆ‚xÂ² * Râ‚‘Hâ‚Â¹Râ‚‘áµ€ - Î¼Ê³áµ‰áµ * IÎ¼Ê³áµ‰áµgÌ‡â‚œgÌ‡â‚œ * ğ“Â¹ )
                    Ká¶ á¶œÂ² = pâ€²â‚™ * ğ“– * (Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â² * âˆ‚gâ‚™âˆ‚x)' + pâ‚™ * (âˆ‚Â²gâ‚™âˆ‚xÂ² * Râ‚‘Hâ‚Â²Râ‚‘áµ€ - Î¼Ê³áµ‰áµ * IÎ¼Ê³áµ‰áµgÌ‡â‚œgÌ‡â‚œ * ğ“Â² )
                    Ká¶ á¶œÂ³ = pâ€²â‚™ * ğ“– * (Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â³ * âˆ‚gâ‚™âˆ‚x)' + pâ‚™ * (âˆ‚Â²gâ‚™âˆ‚xÂ² * Râ‚‘Hâ‚Â³Râ‚‘áµ€ - Î¼Ê³áµ‰áµ * IÎ¼Ê³áµ‰áµgÌ‡â‚œgÌ‡â‚œ * ğ“Â³ )
                    Ká¶ á¶œâ´ = pâ€²â‚™ * ğ“– * (Râ‚‘Hâ‚áµ€Râ‚‘áµ€â´ * âˆ‚gâ‚™âˆ‚x)' + pâ‚™ * (âˆ‚Â²gâ‚™âˆ‚xÂ² * Râ‚‘Hâ‚â´Râ‚‘áµ€ - Î¼Ê³áµ‰áµ * IÎ¼Ê³áµ‰áµgÌ‡â‚œgÌ‡â‚œ * ğ“â´ )
        
        
                    
        
                    tâ‚„Â¹Â¹ = Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â¹ * Ká¶ á¶œÂ¹
                    tâ‚„Â¹Â² = Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â¹ * Ká¶ á¶œÂ²
                    tâ‚„Â¹Â³ = Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â¹ * Ká¶ á¶œÂ³
                    tâ‚„Â¹â´ = Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â¹ * Ká¶ á¶œâ´
        
                    tâ‚„Â²Â¹ = Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â² * Ká¶ á¶œÂ¹
                    tâ‚„Â²Â² = Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â² * Ká¶ á¶œÂ²
                    tâ‚„Â²Â³ = Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â² * Ká¶ á¶œÂ³
                    tâ‚„Â²â´ = Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â² * Ká¶ á¶œâ´
        
                    tâ‚„Â³Â¹ = Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â³ * Ká¶ á¶œÂ¹
                    tâ‚„Â³Â² = Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â³ * Ká¶ á¶œÂ²
                    tâ‚„Â³Â³ = Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â³ * Ká¶ á¶œÂ³
                    tâ‚„Â³â´ = Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â³ * Ká¶ á¶œâ´
        
                    tâ‚„â´Â¹ = Râ‚‘Hâ‚áµ€Râ‚‘áµ€â´ * Ká¶ á¶œÂ¹
                    tâ‚„â´Â² = Râ‚‘Hâ‚áµ€Râ‚‘áµ€â´ * Ká¶ á¶œÂ²
                    tâ‚„â´Â³ = Râ‚‘Hâ‚áµ€Râ‚‘áµ€â´ * Ká¶ á¶œÂ³
                    tâ‚„â´â´ = Râ‚‘Hâ‚áµ€Râ‚‘áµ€â´ * Ká¶ á¶œâ´
        
        
                    Cá¶ á¶œÂ¹ = -pâ‚™*Î¼Ê³áµ‰áµ * IÎ¼Ê³áµ‰áµgÌ‡â‚œgÌ‡â‚œ * ğ“‘Â¹
                    Cá¶ á¶œÂ² = -pâ‚™*Î¼Ê³áµ‰áµ * IÎ¼Ê³áµ‰áµgÌ‡â‚œgÌ‡â‚œ * ğ“‘Â²
                    Cá¶ á¶œÂ³ = -pâ‚™*Î¼Ê³áµ‰áµ * IÎ¼Ê³áµ‰áµgÌ‡â‚œgÌ‡â‚œ * ğ“‘Â³
                    Cá¶ á¶œâ´ = -pâ‚™*Î¼Ê³áµ‰áµ * IÎ¼Ê³áµ‰áµgÌ‡â‚œgÌ‡â‚œ * ğ“‘â´
        
        
                    Ká¶œÂ¹Â¹ +=  Ï‰á´³ * (tâ‚Â¹Â¹ + tâ‚‚Â¹Â¹ + tâ‚ƒÂ¹Â¹ + tâ‚„Â¹Â¹)
                    Ká¶œÂ¹Â² +=  Ï‰á´³ * (tâ‚Â¹Â² + tâ‚‚Â¹Â² + tâ‚ƒÂ¹Â² + tâ‚„Â¹Â²)
                    Ká¶œÂ¹Â³ +=  Ï‰á´³ * (tâ‚Â¹Â³ + tâ‚‚Â¹Â³ + tâ‚ƒÂ¹Â³ + tâ‚„Â¹Â³)
                    Ká¶œÂ¹â´ +=  Ï‰á´³ * (tâ‚Â¹â´ + tâ‚‚Â¹â´ + tâ‚ƒÂ¹â´ + tâ‚„Â¹â´)
        
                    Ká¶œÂ²Â¹ +=  Ï‰á´³ * (tâ‚Â²Â¹ + tâ‚‚Â²Â¹ + tâ‚ƒÂ²Â¹ + tâ‚„Â²Â¹)
                    Ká¶œÂ²Â² +=  Ï‰á´³ * (tâ‚Â²Â² + tâ‚‚Â²Â² + tâ‚ƒÂ²Â² + tâ‚„Â²Â²)
                    Ká¶œÂ²Â³ +=  Ï‰á´³ * (tâ‚Â²Â³ + tâ‚‚Â²Â³ + tâ‚ƒÂ²Â³ + tâ‚„Â²Â³)
                    Ká¶œÂ²â´ +=  Ï‰á´³ * (tâ‚Â²â´ + tâ‚‚Â²â´ + tâ‚ƒÂ²â´ + tâ‚„Â²â´)
        
                    Ká¶œÂ³Â¹ +=  Ï‰á´³ * (tâ‚Â³Â¹ + tâ‚‚Â³Â¹ + tâ‚ƒÂ³Â¹ + tâ‚„Â³Â¹)
                    Ká¶œÂ³Â² +=  Ï‰á´³ * (tâ‚Â³Â² + tâ‚‚Â³Â² + tâ‚ƒÂ³Â² + tâ‚„Â³Â²)
                    Ká¶œÂ³Â³ +=  Ï‰á´³ * (tâ‚Â³Â³ + tâ‚‚Â³Â³ + tâ‚ƒÂ³Â³ + tâ‚„Â³Â³)
                    Ká¶œÂ³â´ +=  Ï‰á´³ * (tâ‚Â³â´ + tâ‚‚Â³â´ + tâ‚ƒÂ³â´ + tâ‚„Â³â´)
        
                    Ká¶œâ´Â¹ +=  Ï‰á´³ * (tâ‚â´Â¹ + tâ‚‚â´Â¹ + tâ‚ƒâ´Â¹ + tâ‚„â´Â¹)
                    Ká¶œâ´Â² +=  Ï‰á´³ * (tâ‚â´Â² + tâ‚‚â´Â² + tâ‚ƒâ´Â² + tâ‚„â´Â²)
                    Ká¶œâ´Â³ +=  Ï‰á´³ * (tâ‚â´Â³ + tâ‚‚â´Â³ + tâ‚ƒâ´Â³ + tâ‚„â´Â³)
                    Ká¶œâ´â´ +=  Ï‰á´³ * (tâ‚â´â´ + tâ‚‚â´â´ + tâ‚ƒâ´â´ + tâ‚„â´â´)
        
        
                    Cá¶œÂ¹Â¹ +=  Ï‰á´³ * Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â¹ * Cá¶ á¶œÂ¹
                    Cá¶œÂ¹Â² +=  Ï‰á´³ * Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â¹ * Cá¶ á¶œÂ²
                    Cá¶œÂ¹Â³ +=  Ï‰á´³ * Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â¹ * Cá¶ á¶œÂ³
                    Cá¶œÂ¹â´ +=  Ï‰á´³ * Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â¹ * Cá¶ á¶œâ´
        
                    Cá¶œÂ²Â¹ +=  Ï‰á´³ * Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â² * Cá¶ á¶œÂ¹
                    Cá¶œÂ²Â² +=  Ï‰á´³ * Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â² * Cá¶ á¶œÂ²
                    Cá¶œÂ²Â³ +=  Ï‰á´³ * Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â² * Cá¶ á¶œÂ³
                    Cá¶œÂ²â´ +=  Ï‰á´³ * Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â² * Cá¶ á¶œâ´
        
                    Cá¶œÂ³Â¹ +=  Ï‰á´³ * Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â³ * Cá¶ á¶œÂ¹
                    Cá¶œÂ³Â² +=  Ï‰á´³ * Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â³ * Cá¶ á¶œÂ²
                    Cá¶œÂ³Â³ +=  Ï‰á´³ * Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â³ * Cá¶ á¶œÂ³
                    Cá¶œÂ³â´ +=  Ï‰á´³ * Râ‚‘Hâ‚áµ€Râ‚‘áµ€Â³ * Cá¶ á¶œâ´
        
                    Cá¶œâ´Â¹ +=  Ï‰á´³ * Râ‚‘Hâ‚áµ€Râ‚‘áµ€â´ * Cá¶ á¶œÂ¹
                    Cá¶œâ´Â² +=  Ï‰á´³ * Râ‚‘Hâ‚áµ€Râ‚‘áµ€â´ * Cá¶ á¶œÂ²
                    Cá¶œâ´Â³ +=  Ï‰á´³ * Râ‚‘Hâ‚áµ€Râ‚‘áµ€â´ * Cá¶ á¶œÂ³
                    Cá¶œâ´â´ +=  Ï‰á´³ * Râ‚‘Hâ‚áµ€Râ‚‘áµ€â´ * Cá¶ á¶œâ´

    
        
                end
            
            
            end


            
        end

        lâ‚€2 = lâ‚€/2
        lâ‚€2Râ‚‘ = lâ‚€2 * Râ‚‘


        TáµÂ¹ = lâ‚€2Râ‚‘*TáµÂ¹
        TáµÂ² = lâ‚€2Râ‚‘*TáµÂ²
        TáµÂ³ = lâ‚€2Râ‚‘*TáµÂ³
        Táµâ´ = lâ‚€2Râ‚‘*Táµâ´


        TáµˆÂ¹ = lâ‚€2Râ‚‘*TáµˆÂ¹
        TáµˆÂ² = lâ‚€2Râ‚‘*TáµˆÂ²
        TáµˆÂ³ = lâ‚€2Râ‚‘*TáµˆÂ³
        Táµˆâ´ = lâ‚€2Râ‚‘*Táµˆâ´


        MÂ¹Â¹ = lâ‚€2Râ‚‘ * MÂ¹Â¹ * Râ‚‘'
        MÂ¹Â² = lâ‚€2Râ‚‘ * MÂ¹Â² * Râ‚‘'
        MÂ¹Â³ = lâ‚€2Râ‚‘ * MÂ¹Â³ * Râ‚‘'
        MÂ¹â´ = lâ‚€2Râ‚‘ * MÂ¹â´ * Râ‚‘'
        MÂ²Â² = lâ‚€2Râ‚‘ * MÂ²Â² * Râ‚‘'
        MÂ²Â³ = lâ‚€2Râ‚‘ * MÂ²Â³ * Râ‚‘'
        MÂ²â´ = lâ‚€2Râ‚‘ * MÂ²â´ * Râ‚‘'
        MÂ³Â³ = lâ‚€2Râ‚‘ * MÂ³Â³ * Râ‚‘'
        MÂ³â´ = lâ‚€2Râ‚‘ * MÂ³â´ * Râ‚‘'
        Mâ´â´ = lâ‚€2Râ‚‘ * Mâ´â´ * Râ‚‘'

        CáµÂ¹Â¹ = lâ‚€2Râ‚‘ * CáµÂ¹Â¹ * Râ‚‘' 
        CáµÂ¹Â² = lâ‚€2Râ‚‘ * CáµÂ¹Â² * Râ‚‘' 
        CáµÂ¹Â³ = -CáµÂ¹Â¹             
        CáµÂ¹â´ = lâ‚€2Râ‚‘ * CáµÂ¹â´ * Râ‚‘' 
        CáµÂ²Â¹ = lâ‚€2Râ‚‘ * CáµÂ²Â¹ * Râ‚‘' 
        CáµÂ²Â² = lâ‚€2Râ‚‘ * CáµÂ²Â² * Râ‚‘' 
        CáµÂ²Â³ = -CáµÂ²Â¹            
        CáµÂ²â´ = lâ‚€2Râ‚‘ * CáµÂ²â´ * Râ‚‘' 
        CáµÂ³Â¹ = lâ‚€2Râ‚‘ * CáµÂ³Â¹ * Râ‚‘'
        CáµÂ³Â² = lâ‚€2Râ‚‘ * CáµÂ³Â² * Râ‚‘' 
        CáµÂ³Â³ = -CáµÂ³Â¹              
        CáµÂ³â´ = lâ‚€2Râ‚‘ * CáµÂ³â´ * Râ‚‘' 
        Cáµâ´Â¹ = lâ‚€2Râ‚‘ * Cáµâ´Â¹ * Râ‚‘' 
        Cáµâ´Â² = lâ‚€2Râ‚‘ * Cáµâ´Â² * Râ‚‘' 
        Cáµâ´Â³ = -Cáµâ´Â¹
        Cáµâ´â´ = lâ‚€2Râ‚‘ * Cáµâ´â´ * Râ‚‘' 



        kinetic_energy = lâ‚€2* kinetic_energy



        if exact
            
            Î˜â‚ = toangle(Î”Râ‚)
            Î˜â‚‚ = toangle(Î”Râ‚‚)
            
            Tâ‚›â»Â¹Î˜â‚ = Tâ‚›â»Â¹(Î˜â‚)
            Tâ‚›â»Â¹Î˜â‚‚ = Tâ‚›â»Â¹(Î˜â‚‚)

            MÂ²Â¹ = MÂ¹Â²' * Tâ‚›â»Â¹Î˜â‚'
            MÂ²Â² = MÂ²Â²  * Tâ‚›â»Â¹Î˜â‚' 
            MÂ²Â³ = MÂ²Â³  * Tâ‚›â»Â¹Î˜â‚'
            MÂ²â´ = MÂ²â´  * Tâ‚›â»Â¹Î˜â‚'
            MÂ³Â¹ = MÂ¹Â³'
            MÂ³Â² = MÂ²Â³'
            Mâ´Â¹ = MÂ¹â´' * Tâ‚›â»Â¹Î˜â‚‚'
            Mâ´Â² = MÂ²â´' * Tâ‚›â»Â¹Î˜â‚‚' 
            Mâ´Â³ = MÂ³â´' * Tâ‚›â»Â¹Î˜â‚‚'
            Mâ´â´ = Mâ´â´  * Tâ‚›â»Â¹Î˜â‚‚'

            CáµÂ²Â¹ = CáµÂ²Â¹ * Tâ‚›â»Â¹Î˜â‚'
            CáµÂ²Â² = CáµÂ²Â² * Tâ‚›â»Â¹Î˜â‚' 
            CáµÂ²Â³ = CáµÂ²Â³ * Tâ‚›â»Â¹Î˜â‚'
            CáµÂ²â´ = CáµÂ²â´ * Tâ‚›â»Â¹Î˜â‚'
            Cáµâ´Â¹ = Cáµâ´Â¹ * Tâ‚›â»Â¹Î˜â‚‚'
            Cáµâ´Â² = Cáµâ´Â² * Tâ‚›â»Â¹Î˜â‚‚' 
            Cáµâ´Â³ = Cáµâ´Â³ * Tâ‚›â»Â¹Î˜â‚‚'
            Cáµâ´â´ = Cáµâ´â´ * Tâ‚›â»Â¹Î˜â‚‚'

        else

            MÂ²Â¹ = MÂ¹Â²'
            MÂ³Â¹ = MÂ¹Â³'
            MÂ³Â² = MÂ²Â³'
            Mâ´Â¹ = MÂ¹â´' 
            Mâ´Â² = MÂ²â´'
            Mâ´Â³ = MÂ³â´'

        end

        if comp.damping>0
            CáµÂ¹Â¹ += comp.damping*MÂ¹Â¹
            CáµÂ¹Â² += comp.damping*MÂ¹Â²
            CáµÂ¹Â³ += comp.damping*MÂ¹Â³
            CáµÂ¹â´ += comp.damping*MÂ¹â´
            CáµÂ²Â¹ += comp.damping*MÂ²Â¹
            CáµÂ²Â² += comp.damping*MÂ²Â²
            CáµÂ²Â³ += comp.damping*MÂ²Â³
            CáµÂ²â´ += comp.damping*MÂ²â´
            CáµÂ³Â¹ += comp.damping*MÂ³Â¹
            CáµÂ³Â² += comp.damping*MÂ³Â²
            CáµÂ³Â³ += comp.damping*MÂ³Â³
            CáµÂ³â´ += comp.damping*MÂ³â´
            Cáµâ´Â¹ += comp.damping*Mâ´Â¹
            Cáµâ´Â² += comp.damping*Mâ´Â²
            Cáµâ´Â³ += comp.damping*Mâ´Â³
            Cáµâ´â´ += comp.damping*Mâ´â´
        end


        if contact


            Tá¶œÂ¹ = lâ‚€2*Tá¶œÂ¹
            Tá¶œÂ² = lâ‚€2*Tá¶œÂ²
            Tá¶œÂ³ = lâ‚€2*Tá¶œÂ³
            Tá¶œâ´ = lâ‚€2*Tá¶œâ´


            Cá¶œÂ¹Â¹ = lâ‚€2 * Cá¶œÂ¹Â¹ 
            Cá¶œÂ¹Â² = lâ‚€2 * Cá¶œÂ¹Â² 
            Cá¶œÂ¹Â³ = lâ‚€2 * Cá¶œÂ¹Â³ 
            Cá¶œÂ¹â´ = lâ‚€2 * Cá¶œÂ¹â´ 
            Cá¶œÂ²Â¹ = lâ‚€2 * Cá¶œÂ²Â¹ 
            Cá¶œÂ²Â² = lâ‚€2 * Cá¶œÂ²Â² 
            Cá¶œÂ²Â³ = lâ‚€2 * Cá¶œÂ²Â³ 
            Cá¶œÂ²â´ = lâ‚€2 * Cá¶œÂ²â´ 
            Cá¶œÂ³Â¹ = lâ‚€2 * Cá¶œÂ³Â¹ 
            Cá¶œÂ³Â² = lâ‚€2 * Cá¶œÂ³Â² 
            Cá¶œÂ³Â³ = lâ‚€2 * Cá¶œÂ³Â³ 
            Cá¶œÂ³â´ = lâ‚€2 * Cá¶œÂ³â´ 
            Cá¶œâ´Â¹ = lâ‚€2 * Cá¶œâ´Â¹ 
            Cá¶œâ´Â² = lâ‚€2 * Cá¶œâ´Â² 
            Cá¶œâ´Â³ = lâ‚€2 * Cá¶œâ´Â³ 
            Cá¶œâ´â´ = lâ‚€2 * Cá¶œâ´â´ 

            Ká¶œÂ¹Â¹ = lâ‚€2 * Ká¶œÂ¹Â¹
            Ká¶œÂ¹Â² = lâ‚€2 * Ká¶œÂ¹Â²
            Ká¶œÂ¹Â³ = lâ‚€2 * Ká¶œÂ¹Â³
            Ká¶œÂ¹â´ = lâ‚€2 * Ká¶œÂ¹â´
            Ká¶œÂ²Â¹ = lâ‚€2 * Ká¶œÂ²Â¹
            Ká¶œÂ²Â² = lâ‚€2 * Ká¶œÂ²Â²
            Ká¶œÂ²Â³ = lâ‚€2 * Ká¶œÂ²Â³
            Ká¶œÂ²â´ = lâ‚€2 * Ká¶œÂ²â´
            Ká¶œÂ³Â¹ = lâ‚€2 * Ká¶œÂ³Â¹
            Ká¶œÂ³Â² = lâ‚€2 * Ká¶œÂ³Â²
            Ká¶œÂ³Â³ = lâ‚€2 * Ká¶œÂ³Â³
            Ká¶œÂ³â´ = lâ‚€2 * Ká¶œÂ³â´
            Ká¶œâ´Â¹ = lâ‚€2 * Ká¶œâ´Â¹
            Ká¶œâ´Â² = lâ‚€2 * Ká¶œâ´Â²
            Ká¶œâ´Â³ = lâ‚€2 * Ká¶œâ´Â³
            Ká¶œâ´â´ = lâ‚€2 * Ká¶œâ´â´

            contact_energy = lâ‚€2 * contact_energy


            if exact

                Cá¶œÂ²Â¹ = Cá¶œÂ²Â¹ * Tâ‚›â»Â¹Î˜â‚'
                Cá¶œÂ²Â² = Cá¶œÂ²Â² * Tâ‚›â»Â¹Î˜â‚' 
                Cá¶œÂ²Â³ = Cá¶œÂ²Â³ * Tâ‚›â»Â¹Î˜â‚'
                Cá¶œÂ²â´ = Cá¶œÂ²â´ * Tâ‚›â»Â¹Î˜â‚'
                Cá¶œâ´Â¹ = Cá¶œâ´Â¹ * Tâ‚›â»Â¹Î˜â‚‚'
                Cá¶œâ´Â² = Cá¶œâ´Â² * Tâ‚›â»Â¹Î˜â‚‚' 
                Cá¶œâ´Â³ = Cá¶œâ´Â³ * Tâ‚›â»Â¹Î˜â‚‚'
                Cá¶œâ´â´ = Cá¶œâ´â´ * Tâ‚›â»Â¹Î˜â‚‚'

            end


        end



    end


    Táµ = [TáµÂ¹; TáµÂ²; TáµÂ³; Táµâ´]
    Táµˆ = [TáµˆÂ¹; TáµˆÂ²; TáµˆÂ³; Táµˆâ´]
    
    M = hcat(vcat(MÂ¹Â¹, MÂ²Â¹, MÂ³Â¹, Mâ´Â¹), vcat(MÂ¹Â², MÂ²Â², MÂ³Â², Mâ´Â²), vcat(MÂ¹Â³, MÂ²Â³, MÂ³Â³, Mâ´Â³), vcat(MÂ¹â´, MÂ²â´, MÂ³â´, Mâ´â´))
    Cáµ = hcat(vcat(CáµÂ¹Â¹, CáµÂ²Â¹, CáµÂ³Â¹, Cáµâ´Â¹), vcat(CáµÂ¹Â², CáµÂ²Â², CáµÂ³Â², Cáµâ´Â²), vcat(CáµÂ¹Â³, CáµÂ²Â³, CáµÂ³Â³, Cáµâ´Â³), vcat(CáµÂ¹â´, CáµÂ²â´, CáµÂ³â´, Cáµâ´â´))

    
    Tá¶œ = [Tá¶œÂ¹; Tá¶œÂ²; Tá¶œÂ³; Tá¶œâ´]
    Ká¶œ = hcat(vcat(Ká¶œÂ¹Â¹, Ká¶œÂ²Â¹, Ká¶œÂ³Â¹, Ká¶œâ´Â¹), vcat(Ká¶œÂ¹Â², Ká¶œÂ²Â², Ká¶œÂ³Â², Ká¶œâ´Â²), vcat(Ká¶œÂ¹Â³, Ká¶œÂ²Â³, Ká¶œÂ³Â³, Ká¶œâ´Â³), vcat(Ká¶œÂ¹â´, Ká¶œÂ²â´, Ká¶œÂ³â´, Ká¶œâ´â´))
    Cá¶œ = hcat(vcat(Cá¶œÂ¹Â¹, Cá¶œÂ²Â¹, Cá¶œÂ³Â¹, Cá¶œâ´Â¹), vcat(Cá¶œÂ¹Â², Cá¶œÂ²Â², Cá¶œÂ³Â², Cá¶œâ´Â²), vcat(Cá¶œÂ¹Â³, Cá¶œÂ²Â³, Cá¶œÂ³Â³, Cá¶œâ´Â³), vcat(Cá¶œÂ¹â´, Cá¶œÂ²â´, Cá¶œÂ³â´, Cá¶œâ´â´))


    return strain_energy, kinetic_energy, contact_energy, Tâ±â¿áµ—, Táµ, Tá¶œ, Táµˆ, Kâ±â¿áµ—, Ká¶œ, M, Cáµ, Cá¶œ




    
end




function compute_K_T!(nodes, allbeams, matrices, energy, conf, sdf, comp, sol_GP, to, T=Float64) 
    
    @timeit_debug to "Initialization" begin
        
        # initialise the matrices associate to the whole structure
        matrices.Kâ±â¿áµ—.nzval .= 0
        matrices.Cáµ.nzval .= 0 
        matrices.M.nzval .= 0
        matrices.Ká¶œ.nzval .= 0
        matrices.Tâ±â¿áµ— .= 0
        matrices.Táµ .= 0
        matrices.Táµˆ .= 0
        matrices.Tá¶œ .= 0
       
        # initialise the energy values associate to the whole structure
        energy.strain_energy = 0
        energy.kinetic_energy = 0
        energy.contact_energy = 0
        
    end
    
    # cycle over the beams   
    @timeit_debug to "Compute and assemble elemental contributions" begin

        for e in LazyRows(allbeams)
            
            @timeit_debug to "Compute elemental contributions" begin
                
                # information from node 1 and 2
                Xâ‚, Xâ‚‚ = nodes.Xâ‚€[e.node1], nodes.Xâ‚€[e.node2]
                uâ‚, uâ‚‚ = nodes.u[e.node1], nodes.u[e.node2]
                uÌ‡â‚, uÌ‡â‚‚ = nodes.uÌ‡[e.node1], nodes.uÌ‡[e.node2]
                uÌˆâ‚, uÌˆâ‚‚ = nodes.uÌˆ[e.node1], nodes.uÌˆ[e.node2]
                wÌ‡â‚, wÌ‡â‚‚ = nodes.wÌ‡[e.node1], nodes.wÌ‡[e.node2]
                wÌˆâ‚, wÌˆâ‚‚ = nodes.wÌˆ[e.node1], nodes.wÌˆ[e.node2]
                Râ‚, Râ‚‚ = nodes.R[e.node1], nodes.R[e.node2]
                Î”Râ‚, Î”Râ‚‚ = nodes.Î”R[e.node1], nodes.Î”R[e.node2]


                #----------------------------------------
                # Compute the contibution from the e beam
                init = (;Xâ‚, Xâ‚‚, e.lâ‚€, e.Râ‚‘â°)
                simvars = (;conf.mat, conf.geom, comp, init, sdf)

                strain_energy, kinetic_energy, contact_energy, Tâ±â¿áµ—, Táµ, Tá¶œ, Táµˆ, Kâ±â¿áµ—, Ká¶œ, M, Cáµ, Cá¶œ = compute(uâ‚, uâ‚‚, Râ‚, Râ‚‚, Î”Râ‚, Î”Râ‚‚, uÌ‡â‚, uÌ‡â‚‚, wÌ‡â‚, wÌ‡â‚‚, uÌˆâ‚, uÌˆâ‚‚, wÌˆâ‚, wÌˆâ‚‚, simvars)
            
            end 

            @timeit_debug to "Assemble elemental contributions" begin

                #-----------------------
                # Assemble contributions
                
                idof1 = nodes.idof_6[e.node1]
                idof2 = nodes.idof_6[e.node2]
                
                idof = vcat(idof1, idof2)
                
                energy.strain_energy +=  strain_energy
                energy.kinetic_energy += kinetic_energy
                energy.contact_energy +=  contact_energy
            
                update_spmat_sum(matrices.Kâ±â¿áµ—, e.sparsity_map, Kâ±â¿áµ—)
                update_spmat_sum(matrices.Cáµ, e.sparsity_map, Cáµ)#-(1+comp.Î±)*Cá¶œ)
                update_spmat_sum(matrices.M, e.sparsity_map, M)
                # update_spmat_sum(matrices.Ká¶œ, e.sparsity_map, Ká¶œ)

                
                update_vec_sum(matrices.Táµ, idof, Táµ)
                update_vec_sum(matrices.Táµˆ, idof, Táµˆ)
                update_vec_sum(matrices.Tâ±â¿áµ—, idof, Tâ±â¿áµ—)
                # update_vec_sum(matrices.Tá¶œ, idof, Tá¶œ)
            end
                               
        end



    end 
    
end 
